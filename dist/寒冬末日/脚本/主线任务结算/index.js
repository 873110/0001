function e(e){try{return JSON.stringify(e)}catch{return'[unstringifiable]'}}function t(e){return{当前阶段:_.get(e,'主线任务.当前阶段',null),阶段目标:_.get(e,'主线任务.阶段目标',null),目标完成状态:_.get(e,'主线任务.目标完成状态',null),情报碎片:_.get(e,'主线任务.情报碎片',null),$meta:_.get(e,'主线任务.$meta',null),庇护所能力:_.get(e,'庇护所.庇护所能力',null)}}function n(t,n,o){const s=Array.from(new Set([...Object.keys(n??{}),...Object.keys(o??{})])),c={};for(const e of s){const t=n?.[e],s=o?.[e];_.isEqual(t,s)||(c[e]={before:t,after:s})}if(0!==Object.keys(c).length){console.log(`[MissionLogic][${t}] changed keys: ${Object.keys(c).join(', ')}`);for(const[n,o]of Object.entries(c))console.log(`[MissionLogic][${t}] ${n}: ${e(o.before)} -> ${e(o.after)}`)}}function o(e){return e&&'object'==typeof e?Array.isArray(e)?e.map((e,t)=>({key:String(t),value:{描述:String(e?.描述??''),当前值:Number(e?.当前值??0),目标值:Number(e?.目标值??0)}})):Object.entries(e).map(([e,t])=>({key:String(e),value:{描述:String(t?.描述??''),当前值:Number(t?.当前值??0),目标值:Number(t?.目标值??0)}})):[]}function s(e){const t=Number(e);return Number.isFinite(t)?t:0}function c(e){const t=s(e.当前值),n=s(e.目标值);return!(n<=0)&&t>=n}function r(e){if(!e||'object'!=typeof e)return!1;const t=e.状态;return'未探索'===t||'已探索'===t||'已完成'===t}function i(e){const t=_.get(e,'主线任务',null);if(!t||'object'!=typeof t)return;const n=_.get(t,'$meta',null),o=n&&'object'==typeof n?n:{楼层:{last_seen_message_id:0},情报碎片:{},阶段目标:{}};o.楼层&&'object'==typeof o.楼层||(o.楼层={last_seen_message_id:0}),'number'!=typeof o.楼层.last_seen_message_id&&(o.楼层.last_seen_message_id=0),o.情报碎片&&'object'==typeof o.情报碎片||(o.情报碎片={}),o.阶段目标&&'object'==typeof o.阶段目标||(o.阶段目标={}),_.set(e,'主线任务.$meta',o)}const l=[{编号:'LOG-001',描述:'旧物业终端的损坏记录中发现一段加密通讯录音，提及15层某房间储备紧急医疗物资（房号破损模糊）。',价值:'药品、抗生素、升级【医疗舱】的组件。',风险:'信息可能过时；物资被抢先；楼层存在未知危险或被小团体盘踞。',状态:'未探索'},{编号:'LOG-002',描述:'地下二层车库深处疑似有大功率柴油发电机（应急照明/消防系统），暴雪前曾进行大型维护。',价值:'稳定电力来源（电梯/净水等）、大量柴油储备。',风险:'车库环境复杂，可能是幸存者据点或变异生物巢穴。',状态:'未探索'},{编号:'SIGNAL-003',描述:'业余无线电截获断续广播：自称“方舟”的组织宣称在瑞峰购物中心建成“乌托邦”，欢迎加入（夹杂诡异赞美诗）。',价值:'潜在盟友/交易伙伴，或值得征服的新领地。',风险:'可能是骗局/陷阱/邪教诱饵。',状态:'未探索'}],a=[{name:'阶段一：秩序的萌芽',goals:[{key:'肃清20、19、21层的敌对幸存者',描述:'肃清20、19、21层的敌对幸存者',目标值:3},{key:'庇护至少3个核心女性角色或家庭',描述:'庇护至少3个核心女性角色或家庭',目标值:3},{key:'完成一个公寓内部的情报碎片任务',描述:'完成一个公寓内部的情报碎片任务',目标值:1}],rewards:{abilities:{基础电力利用优化:'“伊甸”完成基础自检与优化，提高基础电力利用效率。',非致命防御制造器:'任务奖励解锁：可制造非致命防御装置（用于庇护区安全）。'}}},{name:'阶段二：塔内孤王',goals:[{key:'垂直统一（掌控1-21层）',描述:'彻底掌控星穹国际公寓所有楼层（1-21层）',目标值:1},{key:'激活生命线（修复备用发电机组）',描述:'完成【备用发电机组】探索与修复',目标值:1},{key:'技术垄断（关键区域升至2级）',描述:'至少一项关键区域升级至2级',目标值:1}],rewards:{abilities:{核心系统自适应升级:'提升庇护所整体运行效率，并可能解锁新的建造/科研选项。',全楼广播系统:'可向整栋大楼发布最高指示，强化统治与威慑。',轻型军火熔炉:'任务奖励解锁：制造工坊可升级“轻型军火熔炉”。'}}},{name:'阶段三：社区辐射',goals:[{key:'冲出牢笼（载具格纳库+雪地车）',描述:'研发并建立【载具格纳库】，制造第一辆雪地车',目标值:1},{key:'建立前哨（探索外部建筑）',描述:'探索至少一个周边建筑并建立稳定前哨',目标值:1},{key:'接触外部势力（交易/击退）',描述:'与拾荒者联盟建立交易路线，或击退雪狼帮狩猎队',目标值:1}],rewards:{abilities:{外部环境信息整合:'提升侦测与预警能力，优化外部环境信息整合。',雪原地图:'获得高价值物资点与“微型堡垒”分布线索的地图。',工业原料合成器:'任务奖励解锁：载具格纳库可解锁“工业原料合成器”。'}}},{name:'最终阶段：新世界的王',goals:[{key:'区域霸主（击溃大型外部势力）',描述:'击溃雪狼帮或“方舟”教会至少一个大型外部势力',目标值:1},{key:'秩序建立（100名幸存者社区）',描述:'建立至少100名幸存者、分工明确的末日社区',目标值:100},{key:'文明火种（关键区域顶级）',描述:'至少三个关键区域升级至顶级',目标值:3}],rewards:{abilities:{生态穹顶:'解锁最终庇护所形态“生态穹顶”，达成自给自足的生态循环。'}}}];function u(e){const t=_.get(e,'主线任务',null);if(!t||'object'!=typeof t)return;const n=o(_.get(t,'阶段目标',{}));if(0===n.length)return;const s=_.get(t,'目标完成状态',{})??{},r={...'object'==typeof s?s:{}};let i=0;const l=[];for(let e=0;e<n.length;e+=1){const t=c(n[e].value);t&&(i+=1);const o=String(e);_.isEqual(r[o],t)||l.push(o),r[o]=t}_.set(e,'主线任务.目标完成状态',r),console.log(`[主线任务] 阶段目标完成状态: ${i}/${n.length}`);for(let e=0;e<n.length;e+=1){const t=n[e].value,o=r[String(e)];console.log(`[主线任务]  - 目标${e}: ${o?'✓':'○'} ${t.描述} (${t.当前值}/${t.目标值})`)}const a=i===n.length;console.log('[主线任务] '+(a?'✓ 所有目标完成，准备结算阶段':'○ 等待剩余目标完成'))}function f(e,t,n){const s=_.get(e,'主线任务',null);if(!s||'object'!=typeof s)return;const r=String(_.get(s,'当前阶段','')),i=String(_.get(t,'主线任务.当前阶段',''));if(!r)return;if(i&&i!==r)return void(n&&console.log(`[MissionLogic] skip stage-advance: already changed by AI (${i} -> ${r})`));const l=o(_.get(s,'阶段目标',{}));if(0===l.length)return;if(!l.every(e=>c(e.value)))return;const u=function(e){const t=a.findIndex(t=>t.name===e);return t<0?null:{current:a[t],next:a[t+1]??null}}(r);if(!u)return void console.log(`[MissionLogic] stage completed but unknown stage name: ${r}`);u.next?(console.log(`[MissionLogic] stage completed: ${r} -> ${u.next.name}`),_.set(e,'主线任务.当前阶段',u.next.name),_.set(e,'主线任务.阶段目标',function(e){const t={};for(const n of e.goals)t[n.key]={描述:n.描述,当前值:0,目标值:n.目标值};return t}(u.next)),_.set(e,'主线任务.目标完成状态',function(e){const t={};for(let n=0;n<e;n+=1)t[String(n)]=!1;return t}(u.next.goals.length))):console.log(`[MissionLogic] final stage completed: ${r}`);const f=u.current.rewards?.abilities??{};for(const[t,n]of Object.entries(f)){const o=`庇护所.庇护所能力.${t}`;null==_.get(e,o)&&(_.set(e,o,{desc:n}),console.log(`[MissionLogic] reward: +${t}`))}}$(async()=>{await waitGlobalInitialized('Mvu'),eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,(e,a)=>{const g=_.get(e,'stat_data',{}),y=_.get(a,'stat_data',{}),m=function(){const e=getVariables({type:'chat'})??{},t=_.get(e,'eden.debug',{})??{};return!0===_.get(t,'mission_logic',!1)}(),p=function(){try{const e=globalThis.getLastMessageId?.();if('number'==typeof e&&Number.isFinite(e))return e;const t=Number(e);return Number.isFinite(t)?t:null}catch{return null}}();if(m){n('AI',t(y),t(g))}const b=m?t(g):null;if(function(e,t){const n=_.get(e,'主线任务',null);if(!n||'object'!=typeof n)return;const o=_.get(n,'情报碎片',null),s=o&&'object'==typeof o&&!Array.isArray(o)?o:{};if(Object.keys(s).length>0)return;const c={};for(const e of l)c[e.编号]={...e};_.set(e,'主线任务.情报碎片',c),t&&console.log(`[MissionLogic] seeded intel fragments: ${l.length}`)}(g,m),function(e,t){const n=_.get(e,'主线任务',null);if(!n||'object'!=typeof n)return;const o=_.get(n,'情报碎片',null);if(!o||'object'!=typeof o||Array.isArray(o))return;const c=Object.values(o).filter(r).filter(e=>'已完成'===e.状态).length,i=_.get(n,'阶段目标',null);if(!i||'object'!=typeof i)return;const l='完成一个公寓内部的情报碎片任务',a=_.get(i,l,null);if(!a||'object'!=typeof a)return;const u=s(a.目标值),f=Math.min(s(c),u>0?u:0),g=s(a.当前值);g!==f&&(_.set(e,`主线任务.阶段目标.${l}.当前值`,f),t&&console.log(`[MissionLogic] sync intel progress: ${g} -> ${f} (completed=${c})`))}(g,m),u(g),f(g,y,m),null!=p&&(i(g),_.set(g,'主线任务.$meta.楼层.last_seen_message_id',p),function(e,t){const n=_.get(e,'主线任务',null);if(!n||'object'!=typeof n)return;const o=_.get(n,'情报碎片',null);if(!o||'object'!=typeof o||Array.isArray(o))return;i(e);const s=_.get(e,'主线任务.$meta'),c=s.情报碎片??{};for(const e of Object.keys(c))e in o||delete c[e];for(const[e,n]of Object.entries(o)){if(!r(n))continue;const o=c[e]??{created_at:t,explored_at:0,completed_at:0};o.created_at||(o.created_at=t),'未探索'===n.状态?(o.explored_at=0,o.completed_at=0):'已探索'===n.状态?(o.explored_at||(o.explored_at=t),o.completed_at=0):'已完成'===n.状态&&(o.completed_at||(o.completed_at=t),o.explored_at||(o.explored_at=o.created_at||t)),c[e]=o}s.情报碎片=c,_.set(e,'主线任务.$meta',s)}(g,p),function(e,t){const n=_.get(e,'主线任务',null);if(!n||'object'!=typeof n)return;const s=o(_.get(n,'阶段目标',{}));i(e);const r=_.get(e,'主线任务.$meta'),l=r.阶段目标??{},a=new Set(s.map(e=>e.key));for(const e of Object.keys(l))a.has(e)||delete l[e];for(const e of s){const n=c(e.value),o=l[e.key]??{completed_at:0};n?o.completed_at||(o.completed_at=t):o.completed_at=0,l[e.key]=o}r.阶段目标=l,_.set(e,'主线任务.$meta',r)}(g,p),function(e,t,n){const o=_.get(e,'主线任务',null);if(!o||'object'!=typeof o)return;const s=_.get(o,'情报碎片',null);if(!s||'object'!=typeof s||Array.isArray(s))return;i(e);const c=_.get(e,'主线任务.$meta'),l=c.情报碎片??{},a=[];for(const[e,n]of Object.entries(s)){if(!r(n))continue;const o=l[e];if(!o)continue;if('已完成'===n.状态){const n=o.completed_at||0;n>0&&t-n>=3&&a.push(e);continue}if('已探索'===n.状态){const n=o.explored_at||0;n>0&&t-n>=3&&a.push(e);continue}const s=o.created_at||0;s>0&&t-s>=5&&a.push(e)}if(0!==a.length){for(const e of a)delete s[e],delete l[e];c.情报碎片=l,_.set(e,'主线任务.情报碎片',s),_.set(e,'主线任务.$meta',c),n&&console.log(`[MissionLogic] cleanup intel fragments: ${a.join(', ')}`)}}(g,p,m),function(e,t,n){const s=_.get(e,'主线任务',null);if(!s||'object'!=typeof s)return;const r=_.get(s,'阶段目标',null);if(!r||'object'!=typeof r)return;i(e);const l=_.get(e,'主线任务.$meta'),a=l.阶段目标??{},f=[],g=o(r);for(const e of g){if(!c(e.value))continue;const n=a[e.key]?.completed_at??0;n>0&&t-n>=3&&f.push(e.key)}if(0!==f.length){if(Array.isArray(r)){const e=f.map(e=>Number(e)).filter(e=>Number.isFinite(e)).sort((e,t)=>t-e);for(const t of e)t>=0&&t<r.length&&r.splice(t,1);l.阶段目标={}}else for(const e of f)delete r[e],delete a[e];_.set(e,'主线任务.目标完成状态',{}),u(e),Array.isArray(r)||(l.阶段目标=a),_.set(e,'主线任务.阶段目标',r),_.set(e,'主线任务.$meta',l),n&&console.log(`[MissionLogic] cleanup completed goals: ${f.join(', ')}`)}}(g,p,m)),m&&b){n('Script',b,t(g))}})});
//# sourceMappingURL=index.js.map