const t=z;function e(t){return _.clamp(Number(t)||0,0,100)}function n(t){const e=String(t??'').trim();if(!e)return'';const n=e.replace(/\s+/g,'');return'核心区/餐厅厨房'===n?'核心区/餐厅/厨房':'玄关/隔离区'===n||'玄关/净化区'===n||'玄关/净化隔离区'===n||'玄关/净化/隔离区'===n||'玄关（净化/隔离区）'===n?'玄关/净化/隔离区':n.startsWith('室外/')?`户外/${n.slice(3)}`:'室外'===n?'户外':n}function r(t){const e=n(t);if(!e)return{kind:'none'};if('玄关/临时客房A'===e)return{kind:'entrance',room:'临时客房A'};if('玄关/临时客房B'===e)return{kind:'entrance',room:'临时客房B'};if('玄关/净化/隔离区'===e)return{kind:'entrance',room:'净化/隔离区'};if('玄关'===e)return{kind:'entrance',room:'玄关'};if('核心区/主卧室'===e)return{kind:'core',room:'主卧室'};if('核心区/主浴室'===e)return{kind:'core',room:'主浴室'};if('核心区/客厅'===e)return{kind:'core',room:'客厅'};if('核心区/餐厅/厨房'===e)return{kind:'core',room:'餐厅/厨房'};const r=e.match(/^楼层(\d+)\/(.+)$/);if(r){const t=String(r[1]??'').trim(),e=String(r[2]??'').trim();if(t&&e&&/^\d{4}$/.test(e))return{kind:'floor',floor:t,roomNumber:e}}const o=e.match(/^户外\/(.+)$/);if(o){const t=String(o[1]??'').trim();return t?{kind:'outdoor',area:t}:{kind:'outdoor',area:''}}return'户外'===e?{kind:'outdoor',area:''}:{kind:'none'}}function o(t){return'entrance'===t.kind?'临时客房A'===t.room?'玄关/临时客房A':'临时客房B'===t.room?'玄关/临时客房B':'净化/隔离区'===t.room?'玄关/净化/隔离区':'玄关':'core'===t.kind?'客厅'===t.room?'核心区/客厅':'餐厅/厨房'===t.room?'核心区/餐厅/厨房':'主卧室'===t.room?'核心区/主卧室':'核心区/主浴室':'floor'===t.kind?`楼层${t.floor}/${t.roomNumber}`:'outdoor'===t.kind?t.area?`户外/${t.area}`:'户外':''}function i(t,e){const n=e??'';if(!n)return{kind:'none'};const r=_.get(t,'玄关.临时客房A入住者',[]);if(Array.isArray(r)&&r.includes(n))return{kind:'entrance',room:'临时客房A'};const o=_.get(t,'玄关.临时客房B入住者',[]);if(Array.isArray(o)&&o.includes(n))return{kind:'entrance',room:'临时客房B'};const i=_.get(t,'玄关.净化隔离区入住者',[]);if(Array.isArray(i)&&i.includes(n))return{kind:'entrance',room:'净化/隔离区'};const s=_.get(t,'核心区.主卧室使用者',[]);if(Array.isArray(s)&&s.includes(n))return{kind:'core',room:'主卧室'};const a=_.get(t,'核心区.主浴室使用者',[]);if(Array.isArray(a)&&a.includes(n))return{kind:'core',room:'主浴室'};const l=_.get(t,'核心区.客厅使用者',[]);if(Array.isArray(l)&&l.includes(n))return{kind:'core',room:'客厅'};const c=_.get(t,'核心区.餐厅厨房使用者',[]);if(Array.isArray(c)&&c.includes(n))return{kind:'core',room:'餐厅/厨房'};const u=_.get(t,'楼层房间.楼层20房间',{});if(u&&'object'==typeof u)for(const[t,e]of Object.entries(u)){const r=e?.入住者??[];if(Array.isArray(r)&&r.includes(n))return{kind:'floor',floor:'20',roomNumber:t}}const f=_.get(t,'楼层房间.楼层19房间',{});if(f&&'object'==typeof f)for(const[t,e]of Object.entries(f)){const r=e?.入住者??[];if(Array.isArray(r)&&r.includes(n))return{kind:'floor',floor:'19',roomNumber:t}}return{kind:'none'}}function s(t,e){const n=Number(t);return Number.isFinite(n)?'20'===e?n<3?0:3===n?3:4===n?6:12:n<6?0:_.clamp(3*(n-5),0,12):0}function a(t){const e={};for(const[n,r]of Object.entries(t??{}))Array.isArray(r)&&(e[n]=_(r).filter(t=>'string'==typeof t&&t.trim().length>0).filter(t=>!('20'===n&&'2001'===t)).uniq().sortBy().value());return e}function l(t,e){const n=function(t){const e=(t??'').match(/(\d{1,4})年(\d{1,2})月(\d{1,2})日/);if(!e)return null;const n=Number(e[1]),r=Number(e[2]),o=Number(e[3]);if(!Number.isFinite(n)||!Number.isFinite(r)||!Number.isFinite(o))return null;const i=new Date(n,r-1,o);return Number.isNaN(i.getTime())?null:Math.floor(i.getTime()/864e5)}(t),r=function(t){const e=(t??'').match(/(\d{1,2}):(\d{2})/);if(!e)return null;const n=Number(e[1]),r=Number(e[2]);return Number.isFinite(n)&&Number.isFinite(r)?n<0||n>23||r<0||r>59?null:{hour:n,minute:r}:null}(e);if(null===n||null===r)return null;return{epochMinutes:1440*n+60*r.hour+r.minute,hour:r.hour,minute:r.minute}}const c='eden.shelter_scope',u='eden.rules.health',f='eden.shelter_upgrade';const d='1.2',g='__eden_helper_active_instance__',p=(()=>{try{return`${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`}catch{return String(Date.now())}})(),h='eden.debug.eden_helper_log',m='伊甸调试开关',y='伊甸调试写入日志';function b(t,e){const n=String(e??'').split('.').filter(Boolean);let r=t;for(const t of n){if(!r||'object'!=typeof r)return;r=r[t]}return r}function N(t,e=1200){try{const n=JSON.stringify(t,(t,e)=>'string'==typeof e&&e.length>400?`${e.slice(0,400)}…`:e);return'string'!=typeof n?String(t??''):n.length<=e?n:`${n.slice(0,e)}…`}catch{return String(t??'')}}function v(){try{try{const t=new URLSearchParams(window.location.search);if(t.has('debug')||t.has('dev'))return{enabled:!0,toConsole:!0,toChat:t.has('to_chat')}}catch{}const t='function'==typeof getVariables?getVariables({type:'chat'})??{}:{},e=!0===b(t,'eden.debug.eden_helper');return{enabled:e,toConsole:e,toChat:!0===b(t,'eden.debug.to_chat')}}catch{return{enabled:!1,toConsole:!1,toChat:!1}}}function A(){try{return window.top??window}catch{return window}}function S(){try{const t=A(),e=t?.[g];return!e||'object'!=typeof e||e.id===p}catch{return!0}}function k(t,e,n,r){if(!S())return;const o=r??v();if(!o.enabled)return;const i='string'==typeof n?.zh?n.zh:'',s=n?{...n}:void 0;s&&'zh'in s&&delete s.zh;const a={ts:(new Date).toISOString(),level:t,event:e,...i?{zh:i}:{},...n||{}};if(o.toConsole){const n=i?`${i} (${e})`:e,r=s?` ${N(s)}`:'';console?.[t]?.(`[eden/helper] ${n}${r}`)}if(o.toChat&&'function'==typeof updateVariablesWith)try{updateVariablesWith(t=>{const e=b(t,h),r=Array.isArray(e)?e.slice():[];return r.push({ts:a.ts,level:a.level,event:a.event,zh:a.zh??'',data:n?N(n):''}),r.length>80&&r.splice(0,r.length-80),function(t,e,n){const r=String(e??'').split('.').filter(Boolean);if(0===r.length)return;let o=t;for(let t=0;t<r.length-1;t++){const e=r[t];o[e]&&'object'==typeof o[e]||(o[e]={}),o=o[e]}o[r[r.length-1]]=n}(t,h,r),t},{type:'chat'})}catch{}}function j(t){try{const e='function'==typeof getVariables?getVariables({type:'chat'})??{}:{};return!0===_.get(e,t,!1)}catch{return!1}}function M(t){'function'==typeof updateVariablesWith&&updateVariablesWith(e=>('boolean'==typeof t.eden_helper&&_.set(e,'eden.debug.eden_helper',t.eden_helper),'boolean'==typeof t.date_logic&&_.set(e,'eden.debug.date_logic',t.date_logic),'boolean'==typeof t.offstage_health&&_.set(e,'eden.debug.offstage_health',t.offstage_health),'boolean'==typeof t.room_logic&&_.set(e,'eden.debug.room_logic',t.room_logic),'boolean'==typeof t.to_chat&&_.set(e,'eden.debug.to_chat',t.to_chat),e),{type:'chat'})}function w(t){const e=['玄关/净化/隔离区','玄关/临时客房A','玄关/临时客房B','核心区/客厅','核心区/餐厅/厨房','核心区/主卧室','核心区/主浴室'],n=_.get(t,'楼层房间.楼层20房间',{});if(n&&'object'==typeof n)for(const t of Object.keys(n)){const n=String(t??'').trim();n&&e.push(`楼层20/${n}`)}const r=_.get(t,'楼层房间.楼层19房间',{});if(r&&'object'==typeof r)for(const t of Object.keys(r)){const n=String(t??'').trim();n&&e.push(`楼层19/${n}`)}return _(e).uniq().value()}function F(t,e){const r=n(e);if('玄关/净化/隔离区'===r)return _.get(t,'玄关.净化隔离区入住者',[]);if('玄关/临时客房A'===r)return _.get(t,'玄关.临时客房A入住者',[]);if('玄关/临时客房B'===r)return _.get(t,'玄关.临时客房B入住者',[]);if('核心区/客厅'===r)return _.get(t,'核心区.客厅使用者',[]);if('核心区/餐厅/厨房'===r)return _.get(t,'核心区.餐厅厨房使用者',[]);if('核心区/主卧室'===r)return _.get(t,'核心区.主卧室使用者',[]);if('核心区/主浴室'===r)return _.get(t,'核心区.主浴室使用者',[]);const o=r.match(/^楼层(20|19)\/(.+)$/);if(o){const e=o[1],n=String(o[2]??'').trim();return n?_.get(t,`楼层房间.楼层${e}房间.${n}.入住者`,[]):[]}return[]}function O(t){const e=new Set(['世界','庇护所','房间','主线任务','楼层其他住户','临时NPC']),n=[];for(const[r,o]of Object.entries(t??{}))e.has(r)||'string'==typeof r&&r&&!r.startsWith('_')&&o&&'object'==typeof o&&'登场状态'in o&&'健康'in o&&n.push(r);const r=[],o=_.get(t,'临时NPC',{});if(o&&'object'==typeof o&&!Array.isArray(o))for(const[t,e]of Object.entries(o))'string'==typeof t&&t&&e&&'object'==typeof e&&'登场状态'in e&&'健康'in e&&r.push(t);return{core:n,tempNpc:r}}function P(t,e,r){const o=r?`临时NPC.${e}.所在房间`:`${e}.所在房间`;return n(_.get(t,o,''))}function I(t,e,r,o){const i=r?`临时NPC.${e}.所在房间`:`${e}.所在房间`;_.set(t,i,n(o))}function D(t){if(!t)return!1;return'none'!==r(t).kind}function E(t){const e=n(t.oldTag),r=n(t.newTag);return D(r)?{finalTag:r,reason:'explicit'}:''===r?D(e)?{finalTag:'',reason:'explicit-none'}:{finalTag:'',reason:'none'}:D(e)?{finalTag:e,reason:'invalid-keep-old'}:{finalTag:'',reason:'invalid-to-none'}}function C(t,e){return Array.isArray(t)?_(t).filter(t=>'string'==typeof t).map(t=>t.trim()).filter(t=>t.length>0&&!e.has(t)).value():[]}function B(t,e,r){const o=n(e);if('玄关/净化/隔离区'===o)return void _.set(t,'玄关.净化隔离区入住者',r);if('玄关/临时客房A'===o)return void _.set(t,'玄关.临时客房A入住者',r);if('玄关/临时客房B'===o)return void _.set(t,'玄关.临时客房B入住者',r);if('核心区/客厅'===o)return void _.set(t,'核心区.客厅使用者',r);if('核心区/餐厅/厨房'===o)return void _.set(t,'核心区.餐厅厨房使用者',r);if('核心区/主卧室'===o)return void _.set(t,'核心区.主卧室使用者',r);if('核心区/主浴室'===o)return void _.set(t,'核心区.主浴室使用者',r);const i=o.match(/^楼层(20|19)\/(.+)$/);if(!i)return;const s=i[1],a=String(i[2]??'').trim();a&&(!function(t,e,n){const r=`楼层房间.楼层${e}房间.${n}`,o=_.get(t,r,null);o&&'object'==typeof o||_.set(t,r,{入住者:[]});const i=_.get(t,`${r}.入住者`,null);Array.isArray(i)||_.set(t,`${r}.入住者`,[])}(t,s,a),_.set(t,`楼层房间.楼层${s}房间.${a}.入住者`,r))}function W(t,e,n){const r=_.get(t,'房间',{})??{},s=_.get(e,'房间',{})??{};!function(t,e){const n=_.get(t,'房间',{})??{},{core:r,tempNpc:s}=O(t),a=[];for(const e of[...r,...s]){const r=s.includes(e);if(P(t,e,r))continue;const l=o(i(n,e));l&&(I(t,e,r,l),a.push({name:e,tag:l}))}e&&a.length>0&&console.log('[房间逻辑] 已从「房间」表补齐缺失的角色所在房间标签:',a)}(t,n);const{core:a,tempNpc:l}=O(t),c=new Set([...a,...l]),u=_([...w(s),...w(r)]).uniq().value(),f=new Map,d=new Map,g=new Map,p=new Map;for(const n of[...a,...l]){const r=l.includes(n),o=P(e,n,r),i=P(t,n,r);g.set(n,o),p.set(n,i);const{finalTag:s,reason:a}=E({oldTag:o,newTag:i});f.set(n,s),d.set(n,a),s!==i&&I(t,n,r,s)}const h=_.cloneDeep(r??{});for(const t of u){const e=C(F(s,t),c);B(h,t,e)}for(const t of[...a,...l]){const e=f.get(t)??'';if(!e)continue;const n=F(h,e),r=Array.isArray(n)?n.slice():[];r.includes(t)||r.push(t),B(h,e,r)}const m=[...a,...l];for(const t of u){const e=F(h,t),n=_(e).filter(t=>'string'==typeof t).map(t=>t.trim()).filter(t=>t.length>0).uniq().value(),r=n.filter(t=>!m.includes(t)),o=n.filter(t=>m.includes(t));B(h,t,[...r,...o])}if(_.set(t,'房间',h),n){const t=[];for(const e of[...a,...l]){const n=g.get(e)??'',r=p.get(e)??'',o=f.get(e)??'',i=d.get(e)??'';n===r&&r===o||t.push({name:e,old:n,next:r,final:o,reason:i})}t.length>0&&console.log('[房间逻辑] 房间标签对齐详情:',t);const e=[],n=u;for(const t of[...a,...l]){const r=n.filter(e=>(F(h,e)??[]).includes(t));r.length>1&&e.push({name:t,tags:r})}e.length>0&&console.log('[房间逻辑] 对齐后仍存在多房间重复占用:',e);const r=[...d.entries()].reduce((t,[,e])=>(t[e]=(t[e]??0)+1,t),{});console.log('[房间逻辑] 对齐原因统计:',r)}}function T(t){const e=Number(t);return _.clamp(Number.isFinite(e)?e:1,1,10)}const L=t.z.object({last_roll_date:t.z.string().prefault(''),days_since_upgrade:t.z.coerce.number().prefault(0),roll_history:t.z.record(t.z.string(),t.z.object({roll:t.z.union([t.z.coerce.number(),t.z.null()]),upgraded:t.z.boolean(),reason:t.z.string().prefault('normal'),source:t.z.string().prefault('script'),ts:t.z.string().prefault(''),event_id:t.z.string().optional(),message_id:t.z.coerce.number().optional(),trigger:t.z.string().optional()}).passthrough()).prefault({}),last_roll_value:t.z.union([t.z.coerce.number(),t.z.null()]).optional(),last_roll_upgraded:t.z.boolean().optional(),last_roll_reason:t.z.string().optional(),last_roll_source:t.z.string().optional(),last_roll_event_id:t.z.string().optional(),last_roll_settled:t.z.boolean().optional(),last_level_message_id:t.z.coerce.number().optional(),last_level_source:t.z.string().optional(),last_ability_message_id:t.z.coerce.number().optional(),last_ability_source:t.z.string().optional(),last_ability_changed:t.z.boolean().optional(),last_ability_event_id:t.z.string().optional(),last_ability_added_names:t.z.array(t.z.string()).optional(),manual_request:t.z.object({id:t.z.string().prefault(''),message_id:t.z.coerce.number().prefault(0),today:t.z.string().prefault(''),ts:t.z.string().prefault('')}).prefault({id:'',message_id:0,today:'',ts:''}).optional()}).passthrough().prefault({last_roll_date:'',days_since_upgrade:0});function x(){try{const t=getVariables({type:'chat'})??{},e=_.get(t,f,{});return L.parse(e)}catch{return L.parse({})}}function V(t){'function'==typeof updateVariablesWith&&updateVariablesWith(e=>{const n=_.get(e,f,{}),r=n&&'object'==typeof n&&!Array.isArray(n)?{...n}:{},o=t(r)??r;return _.set(e,f,o),e},{type:'chat'})}function q(){try{const t=globalThis.getLastMessageId?.();if('number'==typeof t&&Number.isFinite(t))return t;const e=Number(t);return Number.isFinite(e)?e:null}catch{return null}}function R(t){const e=String(t??'').trim().match(/^(\d+)\s*天/);if(!e)return 0;const n=Number(e[1]);return Number.isFinite(n)?Math.max(0,n):0}function H(t){const e=Math.max(0,Math.floor(t));return`${e}天 | 剩余保底升级天数：${Math.max(0,7-e)}天`}function U(t,e,n){if('guarantee'===n)return'今日已投掷: 保底升级！';return`今日已投掷: ${'number'==typeof t&&Number.isFinite(t)?Math.floor(t):0}点 (${e?'触发幸运升级！':'未升级'})`}function K(t){const e=String(t??'').trim().match(/(\d+)年(\d+)月(\d+)日/);if(!e)return null;const n=Number(e[1]),r=Number(e[2]),o=Number(e[3]);return Number.isFinite(n)&&Number.isFinite(r)&&Number.isFinite(o)?1e4*n+100*r+o:null}function J(t){try{const e=globalThis?.crypto?.randomUUID?.();if('string'==typeof e&&e)return`${t}_${e}`}catch{}return`${t}_${Date.now()}_${Math.floor(1e9*Math.random())}`}const Y=function(t){const e={},n=String(t??'').split(/###\s*庇护所等级\s*(\d+)\s*:/g);for(let t=1;t+1<n.length;t+=2){const r=Number(n[t]),o=String(n[t+1]??'');if(!Number.isFinite(r))continue;const i=o.split(/\r?\n/),s=[];let a=null,l=[],c=!1;const u=()=>{if(!a)return;const t=l.map(t=>String(t??'').trim()).filter(Boolean).join('\n').trim();s.push({name:a.trim(),desc:t}),a=null,l=[],c=!1},f=t=>{const e=t.trim();if(!e)return!1;try{if(!/^\p{Extended_Pictographic}/u.test(e))return!1}catch{if(!/^[\u2600-\u27BF\u{1F300}-\u{1FAFF}]/u.test(e))return!1}return!e.startsWith('#')&&!e.startsWith('<')&&(!e.startsWith('---')&&(!e.startsWith('简介')&&!e.startsWith('-')))};for(const t of i){const e=String(t??'').trimEnd().trim();if(!e){c&&l.push('');continue}if(e.startsWith('---')){a&&u();continue}const n=e.match(/^简介[:：]\s*(.*)$/);n&&a?(c=!0,l.push(n[1]??'')):f(e)?(a&&u(),a=e,l=[],c=!1):c&&a&&l.push(e)}a&&u(),s.length>0&&(e[r]=s)}return e}('<庇护所升级能力>\n\n# 伊甸园庇护所升级蓝图\n\n### ⚙️ 自适应升级逻辑 (Adaptive Upgrade Logic)\n“伊甸”庇护所的升级并非简单的数值积累，而是基于“伊甸”AI对外部环境的自适应响应以及对失落科技的重新整合。\n1. **主线驱动**：完成 <主线任务-星穹秩序> 的关键阶段是获得大规模功能升级（跨等级跳跃）的主要手段。\n2. **情报碎片触发**：发现并完成特定的【情报碎片】（尤其是主线与扩展类）是解锁特定功能模块（如医疗舱、制造单元）的前提条件。\n3. **资源反馈**：AI会根据收容人数、掌握的楼层范围自动优化电力与资源配给。\n\n---\n### 庇护所等级 1: 磐石基础 (Rock-Solid Foundation)\n\n\n---\n🛡️绝对安全屏障🛡️\n简介：庇护所的外墙、门窗均由未知超合金构成，形成一体化的绝对物理屏障。主入口的气密舱门足以抵御包括穿甲火箭弹在内的常规攻城武器，确保外部的任何灾害与暴力都无法侵扰您的安宁。\n\n⚡“仲裁者”内部安防系统⚡\n简介：庇护所的地板、墙壁内集成了纳米级安防网络。一旦“伊甸”AI通过生物特征或您的指令，判定进入内部的访客怀有敌意或攻击倾向，系统会瞬间释放高压电流，使其立刻麻痹并丧失行动能力，任您处置。从这一刻起，任何进入您家的人，生死皆在您一念之间。\n\n💧无限基础资源💧\n简介：内部管网系统与一个微型物质重组单元相连，可无限量供应生命所需的基础资源。\n\n🌡️环境循环系统🌡️\n简介：一套完全独立的空气净化与温控系统。它能24小时不间断地过滤并循环室内空气，维持医用无菌标准，同时将室温恒定在您设定的最舒适的温度，让您彻底隔绝外界的严寒。\n\n📡对外观察接口📡\n简介：位于玄关的集成系统，包含一块高清显示屏和一套双向通信设备。您可以安全地在室内与门外的访客对话，并通过遍布公寓楼内外的微型无人机（此时仅有监视功能）观察周边情况。\n\n📤单向物资投送仓📤\n简介：位于玄关墙壁上的一个小型投送装置。\n\n---\n### 庇护所等级 2: 安全掌控 (Secure & Control)\n\n\n---\n\n🌐数字天堂🌐\n简介：庇护所建立了一个独立的局域网络，并链接到一个存储着旧世界海量数据的服务器。您可以随时访问几乎所有的电影、电视剧、音乐、游戏和电子书籍。网络稳定，体验流畅，告别末世的枯燥乏味。\n\n👁️全天候侦察网络👁️\n简介：监视无人机群升级。增加了红外热成像与夜视功能，并扩大了侦察范围，覆盖整个小区。您现在可以更清晰、更全面地掌握周边所有幸存者的动态。\n\n🛰️“哨兵”预警系统🛰️\n简介：一套集成在侦察网络中的高级预警系统。当无人机侦测到任何潜在威胁（如大规模人群聚集、武器开火、异常热源）靠近庇护所一定范围时，系统会立即通过全息投影和语音向您发出警报，并提供实时战术分析。\n\n---\n### 庇护所等级 3: 奢华纪元 (Era of Luxury)\n简介: 您正式步入末日中的“帝王”生活。物质享受达到顶峰，基础的医疗保障也已到位，您的生存优势变得无可动摇。\n\n---\n💎万象合成终端：文明垄断💎\n简介：物质重组单元的质变进化。在外界仅能依靠冻土与雪水苟延残喘时，该终端允许您生产旧世界所有顶奢消耗品（如A5级和牛、限量版波尔多红酒、特制雪茄）。更重要的是，它能合成带有**“生物激素诱导”**属性的辅助品。在极寒末日，这种绝对的生存阶级差异，将让任何孤傲的校花或高冷的教师在生理与心理上彻底对您产生**“美食依附”**。\n\n👕环境织造机：第二层皮肤👕\n简介：超越传统物理隔离的生产单元。它能制造厚度仅如蝉翼、却能发射稳定“热场力”的特制纤维。这意味着角色在零下五十度的室内也能身着轻薄性感的旧时代衣物，彻底解放被臃肿冬装束缚的肉体。同时，织物内嵌的纳米触感传感器可由主控端调节，实现对穿着者**全天候的生理状态监控与微妙触觉反馈控制**。\n\n⚕️生化医疗站：基因进化⚕️\n简介：配备高精度纳米医疗阵列。除了彻底免疫感冒、发烧及雪晶初级感染外，它最核心的功能是**“基因修复与容颜常驻”**。它能通过内循环代谢调节，逆转末世极寒带来的皮肤粗燥、脱发与组织衰老，让庇护所内的女性保持甚至超越灾难前的巅峰美貌。在文明崩塌的世界，这种“永驻青春”的诱惑是您建立**女性顺从体系**的最强筹码。\n\n🛡️庇护范围同步协议🛡️\n简介：“伊甸”获得对整栋公寓环境管网的深度控制权。将部分公寓房间纳入【生存庇护范围】，为其同步供暖、通风与空气过滤。\n- 名额：20层可同步 3 个房间。\n- 效果：被同步房间成为“温暖而可呼吸”的据点\n- 限制：仅提供环境维持与基础生存保障，不等同于 2001 室的绝对安防\n\n🎭全息娱乐剧院🎭\n简介：在客厅区域激活一个全息投影舞台，配合环绕立体声系统，提供沉浸式的感官享受。\n\n---\n### 庇护所等级 4: 秩序武装 (Armament of Order)\n\n---\n🤖“看守者”自动巡逻机器人🤖\n简介：一种小型、静音的双足巡逻机器人，可在庇护所内部及门口走廊进行24小时不间断巡逻。配备非致命电击武器和摄像探头，能够自动驱离未经授权的闯入者，并将实时画面传回观察接口。\n\n🛡️庇护范围扩展·20层🛡️\n简介：环境管网的同步带宽提升，“伊甸”可同时维持更多房间的供暖与通风。\n- 名额：20层可同步 6 个房间。\n\n---\n### 庇护所等级 5: 追随者体系 (Follower System)\n简介: 您的权柄开始向外延伸。您现在有能力为您的忠诚追随者提供一个赖以生存的“家”，建立属于您的末日秩序。\n\n---\n🏘️独立生命维持模块：恩赐量化🏘️\n简介：每一间“伊甸荚舱”的氧气纯度、淡水流量、热量等级都由主控制室实时量化调节。这不再是宿舍，而是阶级划分的物理工具。您可以为表现优异的角色提供富氧环境和适宜湿度，而让忤逆者在稀薄寒冷的空气中进行“反省”。**“呼吸权”的配给**是您作为末日孤王对追随者施行的最高奖赏与惩戒。\n\n📊追随者监控矩阵：意志解析📊\n简介：通过内嵌于各区域的次声波扫描与生物电感应，实时量化角色的心理状态。系统不仅显示【忠诚度】和【健康值】，更能捕捉到潜意识中的【服从意愿】与【欲望波峰】。AI会精准提示您：谁正在进行危险的内心权衡，谁的道德枷锁正因饥饿而松动，谁正处于最适合被“标记”和“彻底占有”的生理周期。\n\n🌐全环境集成网络：上帝视角🌐\n简介：接入公寓内所有公共及私密区域的隐蔽采集终端。您能实时监听任何据点内的窃窃私语，观察角色在独处时的真实表情。通过亚音频引导技术，您甚至可以悄无声息地微调追随者的睡眠深度与梦境内容，从潜意识层面瓦解反抗意志，确立您的唯一主导权。\n\n🍽️集体餐饮合成器🍽️\n简介：扩展万象合成终端的功能，允许批量合成定制化的餐食。您可以预设菜单，系统将自动为所有追随者准备营养均衡、口味适宜的饭菜，并通过荚舱的投送系统分发，大幅减轻您的管理负担。\n\n🛡️庇护范围扩展·整层覆盖🛡️\n简介：对 20 层环境管网完成完全接管，同步效率与稳定性质变。\n- 名额：20层可同步 12 个房间（整层覆盖）。\n\n---\n### 庇护所等级 6: 武装力量 (Armed Force)\n简介: 您获得了真正意义上的致命武力，从一个富有的幸存者，转变为拥有武装力量的末日军阀。\n\n---\n🔬外科手术台🔬\n简介：初级医疗舱升级。新增一套全自动外科手术设备，能够处理更严重的伤势，如枪伤、骨折固定、阑尾炎切除等中等复杂度的外科手术，极大地提升了您和您追随者的生存率。\n\n🛡️庇护范围扩展·跨楼层🛡️\n简介：同步管网向下贯通，伊甸开始具备对 19 层房间的环境维持能力。\n- 名额：19层可同步 3 个房间（此后每提升 1 级再 +3，上限 12）。\n\n🎯战术训练模拟舱🎯\n简介：一个虚拟现实训练装置。您和您的卫队可以在完全安全的模拟环境中进行武器射击、小队配合、CQB战术等训练，快速提升实战能力，而无需消耗实际弹药或承担受伤风险。\n\n---\n### 庇护所等级 7: 远征准备 (Expedition Prep)\n简介: 庇护所开始为走出公寓、探索这个面目全非的世界做准备。\n\n---\n🚗“先驱者”载具制造单元🚗\n简介：庇护所内一个巨大的扩展区被解锁，成为载具车库。同时，您获得了一台载具制造器，能够生产第一代末日探索载具“先驱者-I”。这是一款具备全地形履带、密封增压驾驶室（可抵御雪晶腐蚀）、大容量储物空间和基础外部装甲的六轮探索车。\n\n🌡️外部环境分析仪🌡️\n简介：安装在载具和无人机上的高级传感器阵列。能够实时分析外部空气中的雪晶浓度、辐射水平、有毒气体成分，并预测局部天气变化，为您的远征提供至关重要的环境情报。\n\n---\n### 庇护所等级 8: 移动堡垒 (Mobile Fortress)\n简介: 质变的时刻。您的家不再被束缚于原地，它本身就成为了最强大的末日座驾。\n\n---\n⚙️动力驱动系统 Mk.I⚙️\n简介：庇护所底部伸出数条巨大的、如同蜈蚣般的节肢状液压驱动足。您的整个庇护所（公寓房间）现在可以从建筑结构上脱离，以缓慢但稳定的速度在城市废墟中移动，成为一个真正意义上的移动堡垒。\n\n💥重型军械库💥\n简介：军火熔炉升级。解锁了突击步枪、狙击步枪、霰弹枪和手榴弹等更具威力的武器制造权限，您的武装力量得到全面强化。\n\n⚖️内部重力稳定系统⚖️\n简介：在庇护所移动时，该系统能自动调节内部重力场，消除加速、减速、颠簸带来的不适感，确保内部人员如履平地。同时，它还能模拟不同的重力环境，用于训练或特殊实验。\n\n---\n### 庇护所等级 9: 完全自持 (Total Self-Sufficiency)\n简介: 庇护所进化为一座近乎完美的生态闭环方舟，其医疗科技已超越旧世界。\n\n---\n⚛️“创世纪”能源核心⚛️\n简介：庇护所的核心能源升级为一座微型、安全、零污染的聚变反应堆。它能提供近乎无限的庞大能源，足以支持所有系统（包括移动）高强度运行，并拥有巨大的能源冗余。\n\n🧬专家级自动医师🧬\n简介：外科手术台最终升级。新增的生物再生模块使其能够执行高难度的再生手术，如断肢再接续、受损器官修复等。理论上，只要大脑未死亡，任何非致命的物理损伤都可以被逆转。\n\n🌿生态循环农场🌿\n简介：一个利用先进水培和气培技术的室内垂直农场。它可以高效生产新鲜蔬菜、水果甚至小型粮食作物，不仅丰富了您的食谱，更实现了食物来源的完全自给，不依赖物质重组单元。\n\n---\n### 庇护所等级 10: 行走伊甸 (Walking Eden)\n简介: 您的庇护所已成为这个冰封星球上的奇迹，是行走的文明火种，是您意志所及的权柄象征。\n\n---\n🚀动力驱动系统 Mk.II🚀\n简介：液压驱动足被反重力引擎所取代。您的庇护所现在可以离地数米悬浮，并以更快的速度、更强的机动性在任何地形上“航行”，无视一切地面障碍。\n\n🌌光学迷彩力场🌌\n简介：庇护所外部可以生成一层扭曲光线和热信号的力场，使其在视觉上和热成像上完全隐形。您可以悄无声-息地出现在任何地方，或是在众目睽睽之下消失无踪。\n\n🌍“净化者”环境探针🌍\n简介：您可以发射一种特殊的能量探针。在探针效果范围内（半径约50米），它可以在短时间内中和雪晶的腐蚀性，融化积雪，净化水源，创造出一片小型的、临时的“安全区”。这是您向外界彰显并施展影响力的强大工具。\n\n⏳时空稳定锚⏳\n简介：庇护所的最神秘科技之一。启动后，可以在庇护所周围形成一个稳定的时空场，极大程度地抵抗外部时间流速异常、空间扭曲等极端现象，确保您在面对未知超自然威胁时保有最后的避难所。\n\n</庇护所升级能力>\n');function G(t){const e=String(t??'').trim();return e?e.replace(/[“”]/g,'"').replace(/[‘’]/g,'\'').replace(/[（]/g,'(').replace(/[）]/g,')').replace(/\s+/g,' ').trim():''}function Q(t){const e=String(t??'').trim();if(!e)return null;if(e.includes('保底'))return{kind:'guarantee',roll:null,upgraded:!0};const n=e.match(/今日已投掷[:：]?\s*(\d+)\s*点/);if(!n)return null;const r=Number(n[1]);if(!Number.isFinite(r))return null;const o=_.clamp(Math.floor(r),0,10);return{kind:'number',roll:o,upgraded:7===o||10===o}}function X(t,e,n){const r=_.get(t,'stat_data',{})??{},o=_.get(e,'stat_data',{})??{},i=String(_.get(r,['世界','日期'],'')??'').trim();if(!i)return;const s=String(_.get(o,['世界','日期'],'')??'').trim(),a=x(),l=a.roll_history??{},c=a?.manual_request??null,u=Number(c?.message_id??0),f=String(c?.today??'').trim(),d=Number.isFinite(u)&&u>0&&(!f||f===i),g=String(a.last_roll_date??'').trim(),p=(Object.prototype.hasOwnProperty.call(a,'last_roll_value')&&a.last_roll_value,Object.prototype.hasOwnProperty.call(l,i),(()=>{if(!s)return!1;if(s===i)return!1;const t=K(s),e=K(i);return null==t||null==e||e>t})());if(!g){const t=R(_.get(r,['庇护所','距离上次升级'],'')),e=Q(_.get(r,['庇护所','今日投掷点数'],'')),o=q()??0,a=s&&s!==i?s:i;V(n=>({...n,last_roll_date:a,days_since_upgrade:t,...e?{last_roll_value:e.roll,last_roll_upgraded:e.upgraded,last_roll_reason:'guarantee'===e.kind?'guarantee':e.upgraded?'lucky':'normal',last_roll_source:'seed',roll_history:{...'object'==typeof n?.roll_history&&n.roll_history?n.roll_history:{},...Object.prototype.hasOwnProperty.call('object'==typeof n?.roll_history&&n.roll_history?n.roll_history:{},a)?{}:{[a]:{roll:e.roll,upgraded:e.upgraded,reason:'guarantee'===e.kind?'guarantee':e.upgraded?'lucky':'normal',source:'seed',ts:(new Date).toISOString(),message_id:o,trigger:'seed'}}}}:{}})),k('info','daily_roll.seed',{today:i,yesterday:s,seedDate:a,seededDays:t,hasSeededRoll:!!e,message_id:o},n)}const h=g?a:x(),m=h.roll_history??{},y=Object.prototype.hasOwnProperty.call(m,i)?m[i]:null,b=String(h.last_roll_date??'').trim(),N=Object.prototype.hasOwnProperty.call(h,'last_roll_value')&&void 0!==h.last_roll_value,v=b===i&&N,A=!!y,S=d&&!A,j=p&&!A||S,M=S?'manual':'script',w=(S?u:q())??0;if(A){const t=U(y?.roll??null,!0===y?.upgraded,'guarantee'===String(y?.reason??'').trim()?'guarantee':void 0);String(_.get(r,['庇护所','今日投掷点数'],'')??'')!==t&&_.set(r,['庇护所','今日投掷点数'],t);const e=H(Number.isFinite(h.days_since_upgrade)&&h.days_since_upgrade>=0?Math.floor(h.days_since_upgrade):R(_.get(r,['庇护所','距离上次升级'],'')));String(_.get(r,['庇护所','距离上次升级'],'')??'')!==e&&_.set(r,['庇护所','距离上次升级'],e)}if(!j)return(p||d)&&console.log(`[DailyRoll] skip ${JSON.stringify({today:i,yesterday:s,crossedDay:p,last_roll_date:b,alreadyRolledToday:v,alreadyHasHistoryToday:A,hasManual:d,last_roll_source:h?.last_roll_source??''})}`),void(d&&(V(t=>{const e={...t};return delete e.manual_request,e}),k('info','daily_roll.manual.noop',{today:i,message_id:w},n)));const F=Number.isFinite(h.days_since_upgrade)?Math.max(0,Math.floor(h.days_since_upgrade)):R(_.get(r,['庇护所','距离上次升级'],'')),O=F>=7,P=_.get(r,['庇护所','今日投掷点数'],''),I=_.get(o,['庇护所','今日投掷点数'],'');!_.isEqual(P,I)&&String(P??'').trim().length>0&&k('warn','daily_roll.ai_roll_ignored',{today:i,message_id:w,roll_text:String(P??'').slice(0,120)},n);let D=null,E=!1,C='normal',B=M;O?(D=null,E=!0,C='guarantee'):(D=Math.floor(11*Math.random()),E=7===D||10===D,B=M,C=E?'lucky':'ai_invalid'===C?'ai_invalid':'normal');const W=_.get(o,['庇护所','庇护所等级'],1),L=_.get(r,['庇护所','庇护所等级'],1),X=T(W),Z=T(L),tt=Math.max(X,Z);tt!==Z&&(_.set(r,['庇护所','庇护所等级'],tt),k('warn','shelter.level.downgrade_corrected',{oldLevel:X,newLevel:Z,baselineLevel:tt,today:i,message_id:w},n));const et=E&&tt<10&&!(Z>X)?T(tt+1):tt,nt=E?0:F+1;_.set(r,['庇护所','今日投掷点数'],U(D,E,O?'guarantee':void 0)),_.set(r,['庇护所','距离上次升级'],H(nt)),_.set(r,['庇护所','庇护所等级'],et);const rt=function(t,e){const n=T(e),r=_.get(t,['庇护所','庇护所能力'],{}),o=r&&'object'==typeof r?Object.keys(r):[],i=new Set(o.map(t=>G(t)).filter(Boolean)),s=_.get(t,['庇护所','庇护所能力'],{});s&&'object'==typeof s||_.set(t,['庇护所','庇护所能力'],{});const a={..._.get(t,['庇护所','庇护所能力'])??{}},l={},c=new Map;for(const[t,e]of Object.entries(a)){const n=String(t??'').trim();if(!n)continue;const r=G(n);if(!r)continue;const o=String(e?.desc??'').trim(),i=c.get(r);if(!i){c.set(r,n),l[n]={desc:o};continue}const s=String(l[i]?.desc??'').trim();(!s&&o||o&&o.length>s.length)&&(l[i]={desc:o})}const u=[],f={...l};for(let t=1;t<=n;t++)for(const e of Y[t]??[]){const t=String(e.name??'').trim(),n=G(t);if(!n)continue;const r=c.get(n);if(!r){c.set(n,t),f[t]={desc:e.desc},i.has(n)||u.push(t);continue}const o=f[r];!String(o?.desc??'').trim()&&e.desc&&(f[r]={desc:e.desc})}_.set(t,['庇护所','庇护所能力'],f);const d=String(_.get(t,['庇护所','可扩展区域','医疗翼'],'')??''),g=n>=9?'专家级自动医师':n>=6?'外科手术台':n>=3?'初级医疗舱':'未解锁';_.set(t,['庇护所','可扩展区域','医疗翼'],g);const p=d!==g;let h=!1;if(n>=7){const e=String(_.get(t,['庇护所','可扩展区域','载具格纳库'],'')??'');e&&'未解锁'!==e||(_.set(t,['庇护所','可扩展区域','载具格纳库'],'先驱者制造单元'),h=!0)}return{addedAbilities:u,patchedMedicalWing:p,patchedVehicleHangar:h}}(r,et),ot=et>X,it=rt.addedAbilities.length>0,st=J('roll'),at=it?J('ability'):'';k('info','daily_roll.settled',{today:i,message_id:w,trigger:S?'manual':'auto',source:B,reason:C,baseDays:F,nextDays:nt,roll:D,upgraded:E,oldLevel:X,nextLevel:et,didLevelUp:ot,rewardAddedAbilities:rt.addedAbilities,rewardPatchedMedicalWing:rt.patchedMedicalWing,rewardPatchedVehicleHangar:rt.patchedVehicleHangar},n),console.log(`[DailyRoll] settled ${JSON.stringify({today:i,yesterday:s,trigger:S?'manual':'auto',source:B,reason:C,roll:D,upgraded:E,oldLevel:X,nextLevel:et,baseDays:F,nextDays:nt})}`),V(t=>{const e={...t,last_roll_date:i,days_since_upgrade:nt,last_roll_value:D,last_roll_upgraded:E,last_roll_reason:C,last_roll_source:B,last_roll_event_id:st,last_roll_settled:!0},n={...t&&'object'==typeof t&&!Array.isArray(t)&&'object'==typeof t.roll_history?t.roll_history??{}:{},[i]:{roll:D,upgraded:E,reason:C,source:B,ts:(new Date).toISOString(),event_id:st,message_id:w,trigger:S?'manual':'auto'}};return e.roll_history=function(t,e){const n=Object.entries(t??{});if(n.length<=e)return t??{};const r=n.map(([t,e])=>{const n=K(t);return{k:t,v:e,n:null==n?Number.POSITIVE_INFINITY:n}});return r.sort((t,e)=>t.n-e.n),r.slice(Math.max(0,r.length-e)).reduce((t,e)=>(t[e.k]=e.v,t),{})}(n,120),ot&&(e.last_level_message_id=w,e.last_level_source=B),e.last_ability_changed=it,it&&(e.last_ability_message_id=w,e.last_ability_source=B,e.last_ability_event_id=at,e.last_ability_added_names=rt.addedAbilities.slice()),delete e.manual_request,e})}function Z(t){return Array.isArray(t)?_(t).filter(t=>'string'==typeof t).map(t=>t.trim()).filter(Boolean).value():[]}function tt(t,e){if(e<=0)return[];const n=_(t).filter(t=>'string'==typeof t&&t.trim().length>0).map(t=>t.trim()).filter(t=>'2001'!==t).uniq().sortBy().value();return n.length<=e?n:n.slice(0,e)}function et(t){const e=(t??'').match(/(\d{1,2}):(\d{2})/);if(!e)return null;const n=Number(e[1]),r=Number(e[2]);return Number.isFinite(n)&&Number.isFinite(r)?n<0||n>23||r<0||r>59?null:60*n+r:null}function nt(){const t=getVariables({type:'chat'})??{},e=_.get(t,'eden.debug',{})??{};return{dateLogic:!0===_.get(e,'date_logic',!1),offstageHealth:!0===_.get(e,'offstage_health',!1)}}function rt(t,e,n){const o=r(_.get(t,`${e}.所在房间`,''));return'core'===o.kind||'entrance'===o.kind||'floor'===o.kind&&('20'===o.floor&&'2001'===o.roomNumber||('20'===o.floor||'19'===o.floor)&&function(t,e,n){const r=t?.[e]??[];return!!Array.isArray(r)&&r.includes(n)}(n,o.floor,o.roomNumber))}function ot(t){return t&&'object'==typeof t&&'健康'in t&&'登场状态'in t}function it(t,e){const n=_.cloneDeep(t);for(const[t,r]of Object.entries(e??{})){const e=n[t];null!=e?'string'!=typeof e||''!==e.trim()||'string'!=typeof r||''===r.trim()?Array.isArray(e)&&0===e.length&&Array.isArray(r)&&r.length>0&&(n[t]=r.slice()):n[t]=r:n[t]=r}return n}function st(t,e){return t?{health:!_.isEqual(t.健康,e.健康),healthReason:!_.isEqual(t.健康更新原因,e.健康更新原因),relation:!_.isEqual(t.关系,e.关系),relationTendency:!_.isEqual(t.关系倾向,e.关系倾向),imprint:!_.isEqual(t.秩序刻印,e.秩序刻印),imprintReason:!_.isEqual(t.秩序刻印更新原因,e.秩序刻印更新原因),thought:!_.isEqual(t.内心想法,e.内心想法)}:{health:!1,healthReason:!1,relation:!1,relationTendency:!1,imprint:!1,imprintReason:!1,thought:!1}}function at(t,n,r){const o=n.健康,i='number'==typeof o||'string'==typeof o?Number(o):NaN;if(!Number.isFinite(i))return;const s=function(t){const n=e(t);return n<=0?'死亡':n<30?'重病/濒死':n<60?'生病/受伤':n<80?'亚健康':'健康'}(e(i));_.set(r,`${t}.健康状况`,s)}function lt(t,e,n,r){if(!st(e,n).thought)return;'离场'===_.get(n,'登场状态','')&&(r.offstageHealth&&console.log(`[登场状态] 「${t}」内心想法已更新，登场状态自动回拨为「登场」`),_.set(n,'登场状态','登场'))}function ct(t,e,n,r,o){const i=n.秩序刻印;if('number'!=typeof i&&'string'!=typeof i)return;const s=Number(i);Number.isFinite(s)&&(s>=0||(o.offstageHealth&&console.log(`[死亡判定] 「${e}」Imp=${s}（<0），判定精神崩溃自杀：健康清零`),_.set(r,`${t}.健康`,0),_.set(r,`${t}.健康更新原因`,'死亡（Imp<0 触发精神崩溃自杀）'),_.set(r,`${t}.健康状况`,'死亡'),_.set(r,`${t}.秩序刻印`,s),_.set(r,`${t}.秩序刻印更新原因`,''),_.set(r,`${t}.登场状态`,'离场'),_.set(r,`${t}.衣着`,''),_.set(r,`${t}.舌唇`,''),_.set(r,`${t}.胸乳`,''),_.set(r,`${t}.私穴`,''),_.set(r,`${t}.神态样貌`,''),_.set(r,`${t}.动作姿势`,''),_.set(r,`${t}.内心想法`,''),_.set(r,`${t}.所在房间`,'')))}function ut(t,n,r,o,i){const s=r.健康;if('number'!=typeof s&&'string'!=typeof s)return;const a=e(Number(s)||0);if(a>0)return;const l=String(r?.健康更新原因??'').trim(),c=r?.秩序刻印,u='number'==typeof c||'string'==typeof c?Number(c):NaN,f=Number.isFinite(u)&&u<0;_.set(o,`${t}.健康`,0),_.set(o,`${t}.健康状况`,'死亡'),_.set(o,`${t}.登场状态`,'离场'),l||_.set(o,`${t}.健康更新原因`,'死亡（健康归零）'),_.set(o,`${t}.衣着`,''),_.set(o,`${t}.舌唇`,''),_.set(o,`${t}.胸乳`,''),_.set(o,`${t}.私穴`,''),_.set(o,`${t}.神态样貌`,''),_.set(o,`${t}.动作姿势`,''),_.set(o,`${t}.内心想法`,''),_.set(o,`${t}.所在房间`,''),f||(_.set(o,`${t}.秩序刻印`,0),_.set(o,`${t}.秩序刻印更新原因`,'')),i.offstageHealth&&console.log(`[死亡判定] 「${n}」健康<=0，判定死亡 ${N({health:a,reason:l,diedFromNegativeImprint:f})}`)}function ft(t,n,r,o,i,s,a,l,c){if(null===s)return;const u=st(r,o);if(u.health)return;if(u.healthReason){const t=String(o?.健康更新原因??'').trim();if(t&&'0, 无变化'!==t)return}if(!('离场'===_.get(o,'登场状态','')))return;const f=o.健康;if('number'!=typeof f&&'string'!=typeof f)return;const d=e(Number(f)||0);if(d<=0)return;const g=rt(i,t,a),p=function(t,e,n){const r=Number(t);if(!Number.isFinite(r)||r<=0)return{delta:0,reason:'0, 无变化'};const o=Math.max(0,Number(n.decayPer6h)||0),i=Math.max(0,Number(n.recoverPer12h)||0),s=Math.max(0,Number(n.decayMultiplier)||0),a=Math.max(0,Number(n.recoverMultiplier)||0);if(e){const t=Math.floor(r/12),e=Math.floor(t*i*a);return e?{delta:e,reason:`+${e}, 离场受庇护休整`}:{delta:0,reason:'0, 无变化'}}const l=Math.floor(r/6),c=-Math.floor(l*o*s);return c?{delta:c,reason:`${c}, 离场未受庇护自然衰减`}:{delta:0,reason:'0, 无变化'}}(s,g,l);if(!p.delta)return;const h=e(d+p.delta),m=h-d;_.set(i,`${t}.健康`,h);const y=p.reason.split(',').slice(1).join(',').trim()||(g?'离场受庇护休整':'离场未受庇护自然衰减'),b=m?`${m>0?`+${m}`:`${m}`}, ${y}`:'0, 无变化';_.set(i,`${t}.健康更新原因`,b),c.offstageHealth&&console.log(`[离场结算] 「${n}」健康 ${d} -> ${h}（${b}）${N({deltaHours:s,sheltered:g,rules:l})}`)}function dt(t,e,n,r){const o=n.秩序刻印;if('number'!=typeof o&&'string'!=typeof o)return;const i=Number(o),s=function(t){const e=_.clamp(Number(t)||0,0,100);return e<=0?'无':e<20?'拒绝':e<40?'交易':e<60?'顺从':e<90?'忠诚':'性奴'}(i);if(!st(e,n).relation&&n.关系!==s){const e=String(n?.关系??'').trim();_.set(r,`${t}.关系`,s),k('info','relation.auto_derived',{zh:`Imp 达到 ${Number.isFinite(i)?i:'?'}，自动调整「${t}」关系为「${s}」`,rolePath:t,imp:Number.isFinite(i)?i:null,relationBefore:e,relationAfter:s})}}function gt(t,e,n){const r=_.get(e,'stat_data.世界.时间',''),o=_.get(t,'stat_data.世界.时间','');if(r===o)return void(n.dateLogic&&console.log('[时间逻辑] 时间未变化：不检查日期'));const i=et(r),s=et(o);if(null===i||null===s)return;if(i<=s)return void(n.dateLogic&&console.log(`[时间逻辑] 时间变化但未跨天：${r} -> ${o} (oldMin=${i}, newMin=${s})`));console.log(`[时间逻辑] 检测到跨天：${r} -> ${o}`);const a=_.get(e,'stat_data.世界.日期',''),l=_.get(t,'stat_data.世界.日期','');if(a!==l)return void(n.dateLogic&&console.log(`[时间逻辑] AI 已更新日期：${a} -> ${l}`));const c=function(t){const e=(t??'').match(/(\d{1,4})年(\d{1,2})月(\d{1,2})日/);if(!e)return null;const n=Number(e[1]),r=Number(e[2]),o=Number(e[3]);return Number.isFinite(n)&&Number.isFinite(r)&&Number.isFinite(o)?r<1||r>12||o<1||o>31?null:{year:n,month:r,day:o}:null}(a);if(!c)return void(n.dateLogic&&console.log(`[时间逻辑] 无法解析日期字符串：${a}`));const u=new Date(c.year,c.month-1,c.day);if(Number.isNaN(u.getTime()))return void(n.dateLogic&&console.log(`[时间逻辑] 无法转换为 Date：${a}`));console.log('[时间逻辑] AI 未更新日期，脚本开始补全日期/天数...'),u.setDate(u.getDate()+1);const f=`末日纪元，${(d=u).getFullYear()}年${d.getMonth()+1}月${d.getDate()}日`;var d;_.set(t,'stat_data.世界.日期',f);const g=_.get(t,'stat_data.世界.末日天数');'number'==typeof g&&_.set(t,'stat_data.世界.末日天数',g+1);const p=_.get(t,'stat_data.世界.末日天数');console.log(`[时间逻辑] 已补全日期：${a} -> ${f}; 天数: ${g} -> ${p}`)}function _t(t,e,n){const r=nt(),o=_.get(e,'stat_data.世界',{}),i=_.get(t,'stat_data.世界',{});let s=function(t,e){const n=l(t.日期??'',t.时间??''),r=l(e.日期??'',e.时间??'');if(!n||!r)return null;const o=r.epochMinutes-n.epochMinutes;return Number.isFinite(o)?o<=0?null:o/60:null}(o,i);if(null===s){const t=_.get(o,'末日天数',null),e=_.get(i,'末日天数',null);if('number'==typeof t&&'number'==typeof e&&Number.isFinite(t)&&Number.isFinite(e)){const n=Math.floor(e)-Math.floor(t);n>0&&(s=24*n)}}if(null===s){_.get(e,'stat_data.世界.时间','')!==_.get(t,'stat_data.世界.时间','')?console.log(`[时间逻辑] 无法计算世界时间差(diffWorldHours=null) ${N({oldWorld:o,newWorld:i})}`):r.dateLogic&&console.log(`[时间逻辑] diffWorldHours=null（时间未变化）${N({oldWorld:o,newWorld:i})}`)}else r.dateLogic&&console.log(`[时间逻辑] 世界时间差(diffWorldHours)=${s.toFixed(2)}小时`);const a=_.get(t,'stat_data',{}),c=_.get(e,'stat_data',{}),f=function(){const t=getVariables({type:'chat'})??{},e=_.get(t,u,{})??{};return{decayPer6h:_.clamp(Number(e.decayPer6h)||5,0,10),recoverPer12h:_.clamp(Number(e.recoverPer12h)||1,0,10),decayMultiplier:_.clamp(Number(e.decayMultiplier)||1,0,10),recoverMultiplier:_.clamp(Number(e.recoverMultiplier)||1,0,10)}}(),d=new Set(['世界','庇护所','房间','主线任务','楼层其他住户','临时NPC']);for(const[t,e]of Object.entries(a??{})){if(d.has(t))continue;if('string'!=typeof t||t.startsWith('_'))continue;if(!ot(e))continue;const o=_.get(c,t,null);lt(t,o,e,r),ct(t,t,e,a,r),ft(t,t,o,e,a,s,n,f,r),ut(t,t,e,a,r),at(t,e,a),dt(t,o,e,a)}const g=_.get(a,'临时NPC',{});if(g&&'object'==typeof g)for(const[t,e]of Object.entries(g)){if('string'!=typeof t||!t)continue;if(!ot(e))continue;const o=_.get(c,`临时NPC.${t}`,null);lt(t,o,e,r),ct(`临时NPC.${t}`,t,e,a,r),ft(`临时NPC.${t}`,t,o,e,a,s,n,f,r),ut(`临时NPC.${t}`,t,e,a,r),ft(`临时NPC.${t}`,t,o,e,a,s,n,f,r),at(`临时NPC.${t}`,e,a),dt(`临时NPC.${t}`,o,e,a)}}$(async()=>{'function'==typeof appendInexistentScriptButtons&&'function'==typeof getButtonEvent&&'function'==typeof eventOn&&(appendInexistentScriptButtons([{name:m,visible:!0},{name:y,visible:!0}]),eventOn(getButtonEvent(m),()=>{if(!S())return;const t=!j('eden.debug.eden_helper');M({eden_helper:t,date_logic:t,offstage_health:t,room_logic:t}),toastr?.info?.('伊甸调试：'+(t?'已开启':'已关闭')),console.log(`[eden/helper] 调试开关：${t?'开启':'关闭'} ${N({enabled:t})}`)}),eventOn(getButtonEvent(y),()=>{if(!S())return;const t=!j('eden.debug.to_chat');M({to_chat:t}),toastr?.info?.('伊甸调试写入日志：'+(t?'已开启':'已关闭')),console.log(`[eden/helper] 调试写入日志：${t?'开启':'关闭'} ${N({to_chat:t})}`)})),await waitGlobalInitialized('Mvu'),function(){try{A()[g]={id:p,version:d,scriptId:'function'==typeof getScriptId?getScriptId():null,ts:(new Date).toISOString()}}catch{}}();const t=v();!function(){try{if(!S())return;const t=`eden.helper.loaded.${'function'==typeof getScriptId?String(getScriptId()??'unknown'):'unknown'}.v${d}`;if(sessionStorage.getItem(t))return;sessionStorage.setItem(t,'1'),toastr?.success?.(`伊甸后台数据辅助 v${d} 加载成功`)}catch{}}(),k('info','boot',{zh:`伊甸后台数据辅助已启动 v${d}（实例 ${p}）`,script:'伊甸后台数据辅助',version:d,instanceId:p},t);let e=null;eventMakeFirst(Mvu.events.VARIABLE_UPDATE_STARTED,t=>{if(S())try{e=_.cloneDeep(t)}catch{e=t}});eventMakeFirst(Mvu.events.VARIABLE_UPDATE_ENDED,(t,n)=>{if(!S())return;const r=v();k('debug','mvu.update_ended.first.begin',{},r);try{const o=_.get(t,'stat_data',{})??{},i=e??n,s=_.get(i,'stat_data',{})??{};!function(t,e){const n=_.get(t,'临时NPC',{});if(!n||'object'!=typeof n||Array.isArray(n))return;const r=[];for(const[e,o]of Object.entries(n)){if('string'!=typeof e||!e)continue;if(!ot(o))continue;const n=_.get(t,e,null);if(!ot(n))continue;const i=it(n,o);_.set(t,e,i),_.unset(t,['临时NPC',e]),r.push(e)}r.length>0&&e&&k('info','role.merge_temp_into_core',{names:r},e)}(o,r),function(t,e,n){const{core:r,tempNpc:o}=O(t),i=[...r,...o],s=[];for(const r of i){const i=o.includes(r)?`临时NPC.${r}`:r,a=_.get(t,i,null),l=_.get(e,i,null);if(!a||'object'!=typeof a)continue;if(!l||'object'!=typeof l)continue;const c=String(_.get(l,'登场状态','')??'').trim(),u=String(_.get(a,'登场状态','')??'').trim();'登场'===c&&c===u&&_.isEqual(l,a)&&(_.set(t,`${i}.登场状态`,'离场'),s.push({name:r,path:i}),k('warn','stage_sanitize.force_offstage',{zh:`回拨「${r}」的登场状态为「离场」（AI 未改登场状态且本轮无字段更新）`,role:r,rolePath:i,reason:'onstage_unchanged_and_no_updates'},n))}s.length>0&&k('info','stage_sanitize.summary',{zh:`登场状态清洗完成：共回拨 ${s.length} 名角色为「离场」`,patchedCount:s.length,patched:s},n)}(o,s,r),function(t,e,n){const{core:r,tempNpc:o}=O(t),i=[...r,...o],s=[],a=[];for(const r of i){const i=o.includes(r)?`临时NPC.${r}`:r,l=_.get(t,i,null),c=_.get(e,i,null);if(!l||'object'!=typeof l)continue;if(!c||'object'!=typeof c)continue;const u=String(_.get(c,'登场状态','')??'').trim(),f=String(_.get(l,'登场状态','')??'').trim();if('离场'!==u)continue;if(u!==f)continue;if(_.isEqual(c,l))continue;const d=new Set(['登场状态']),g=new Set(['健康','健康更新原因']),p=Array.from(new Set([...Object.keys(c),...Object.keys(l)])).filter(t=>!d.has(t)&&!_.isEqual(c?.[t],l?.[t])),h=p.filter(t=>!g.has(t));0!==h.length?(_.set(t,`${i}.登场状态`,'登场'),s.push({name:r,path:i,changedKeys:p.slice(),effectiveChangedKeys:h.slice()}),k('warn','stage_sanitize.force_onstage',{zh:`回拨「${r}」的登场状态为「登场」（检测到非健康字段更新：${h.slice(0,8).join('、')}${h.length>8?` 等${h.length}项`:''}）`,role:r,rolePath:i,reason:'offstage_unchanged_but_role_updated',changedKeys:p,effectiveChangedKeys:h,ignoredKeysForEffective:Array.from(g)},n)):p.length>0&&a.push({name:r,path:i,changedKeys:p.slice()})}s.length>0&&k('info','stage_sanitize.summary.force_onstage',{zh:`离场状态校准完成：共回拨 ${s.length} 名角色为「登场」`,patchedCount:s.length,patched:s},n),a.length>0&&k('debug','stage_sanitize.summary.skip_health_only',{zh:`离场状态校准：检测到 ${a.length} 名角色仅更新「健康/健康更新原因」，保持「离场」`,skippedCount:a.length,skipped:a},n)}(o,s,r);const a=function(){const t=getVariables({type:'chat'})??{},e=_.get(t,'eden.debug',{})??{};return!0===_.get(e,'room_logic',!1)}();a&&k('debug','room_logic.begin',{},r),W(o,s,a),a&&k('debug','room_logic.end',{},r);gt(t,i,nt())}catch(t){k('error','mvu.update_ended.first.error',{reason:t instanceof Error?t.message:String(t)},r)}finally{k('debug','mvu.update_ended.first.end',{},r)}}),eventMakeLast(Mvu.events.VARIABLE_UPDATE_ENDED,(t,n)=>{if(!S())return;const r=v();k('debug','mvu.update_ended.last.begin',{},r);try{const i=e??n,l=_.get(t,'stat_data',{})??{};X(t,i,r);const u=T(_.get(l,['庇护所','庇护所等级'],1)),f=function(){const t=getVariables({type:'chat'})??{},e=_.get(t,c,{});return e&&'object'==typeof e?a(e):{}}(),d=function(t){if(!t||'object'!=typeof t||Array.isArray(t))return null;const e=t.add??null,n=t.remove??null,r={},o={},i=null==e&&null==n&&(Object.prototype.hasOwnProperty.call(t,'20')||Object.prototype.hasOwnProperty.call(t,'19')),s=i?t:e,a=i?null:n;if(s&&'object'==typeof s&&!Array.isArray(s))for(const t of['20','19']){const e=Z(s[t]);e.length&&(r[t]=e)}if(a&&'object'==typeof a&&!Array.isArray(a))for(const t of['20','19']){const e=Z(a[t]);e.length&&(o[t]=e)}const l='string'==typeof t.note?String(t.note):void 0;return 0===Object.keys(r).length&&0===Object.keys(o).length?null:{add:Object.keys(r).length?r:void 0,remove:Object.keys(o).length?o:void 0,note:l}}(_.get(l,['庇护所','庇护范围变更'],null));k('debug','shelter_scope.input',{shelterLevel:u,hasDelta:!!d,deltaNote:d?.note??'',add:d?.add??null,remove:d?.remove??null},r);const g=d?function(t,e,n){const r={...a(t)};for(const t of['20','19']){const o=s(n,t),i=Array.isArray(r[t])?r[t].slice():[],a=new Set(i);for(const n of Z(e.remove?.[t]))a.delete(n);if(o>0)for(const n of Z(e.add?.[t]))if('2001'!==n&&!a.has(n)){if(a.size>=o)break;a.add(n)}const l=tt(Array.from(a),o);l.length>0?r[t]=l:delete r[t]}return a(r)}(f,d,u):f;d&&(o=g,'function'==typeof updateVariablesWith&&updateVariablesWith(t=>(_.set(t,c,a(o)),t),{type:'chat'}),k('info','shelter_scope.applied',{scope:g},r)),_.set(l,['庇护所','当前生存庇护范围'],g),d&&_.set(l,['庇护所','庇护范围变更'],{}),_t(t,i,g)}catch(t){k('error','mvu.update_ended.last.error',{reason:t instanceof Error?t.message:String(t)},r)}finally{k('debug','mvu.update_ended.last.end',{},r),e=null}var o})});
//# sourceMappingURL=index.js.map