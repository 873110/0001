{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/external var \"z\"","src://tavern_helper_template/src/寒冬末日/util/health.ts","src://tavern_helper_template/src/寒冬末日/util/room.ts","src://tavern_helper_template/src/寒冬末日/util/shelter_scope.ts","src://tavern_helper_template/src/寒冬末日/util/time.ts","src://tavern_helper_template/src/寒冬末日/界面/outbound.ts","src://tavern_helper_template/src/寒冬末日/脚本/伊甸后台数据辅助/index.ts"],"sourcesContent":["const __WEBPACK_NAMESPACE_OBJECT__ = z;","export type HealthRules = {\n  decayPer6h: number;\n  recoverPer12h: number;\n  decayMultiplier: number;\n  recoverMultiplier: number;\n};\n\nexport function clampHealth(v: number): number {\n  return _.clamp(Number(v) || 0, 0, 100);\n}\n\nexport function healthCondition(health: number): string {\n  const h = clampHealth(health);\n  if (h <= 0) return '死亡';\n  if (h < 30) return '重病/濒死';\n  if (h < 60) return '生病/受伤';\n  if (h < 80) return '亚健康';\n  return '健康';\n}\n\nexport function computeOffstageHealthDelta(\n  deltaHours: number,\n  sheltered: boolean,\n  rules: HealthRules,\n): { delta: number; reason: string } {\n  const dh = Number(deltaHours);\n  if (!Number.isFinite(dh) || dh <= 0) return { delta: 0, reason: '0, 无变化' };\n\n  const decayPer6h = Math.max(0, Number(rules.decayPer6h) || 0);\n  const recoverPer12h = Math.max(0, Number(rules.recoverPer12h) || 0);\n  const decayMultiplier = Math.max(0, Number(rules.decayMultiplier) || 0);\n  const recoverMultiplier = Math.max(0, Number(rules.recoverMultiplier) || 0);\n\n  if (sheltered) {\n    const steps = Math.floor(dh / 12);\n    const delta = Math.floor(steps * recoverPer12h * recoverMultiplier);\n    if (!delta) return { delta: 0, reason: '0, 无变化' };\n    return { delta, reason: `+${delta}, 离场受庇护休整` };\n  }\n\n  const steps = Math.floor(dh / 6);\n  const delta = -Math.floor(steps * decayPer6h * decayMultiplier);\n  if (!delta) return { delta: 0, reason: '0, 无变化' };\n  return { delta, reason: `${delta}, 离场未受庇护自然衰减` };\n}\n","export type RoomLocation =\n  | { kind: 'entrance'; room: '临时客房A' | '临时客房B' | '玄关' | '净化/隔离区' }\n  | { kind: 'core'; room: '客厅' | '餐厅/厨房' | '主卧室' | '主浴室' }\n  | { kind: 'floor'; floor: string; roomNumber: string }\n  | { kind: 'outdoor'; area: string }\n  | { kind: 'none' };\n\ntype RoomsStatData = any;\n\nexport function normalizeRoomTag(tag: string): string {\n  const raw = String(tag ?? '').trim();\n  if (!raw) return '';\n\n  // 清理误输入的空白（兼容旧存档/手动编辑造成的断行空格）\n  const t = raw.replace(/\\s+/g, '');\n\n  // 兼容旧命名/别名\n  if (t === '核心区/餐厅厨房') return '核心区/餐厅/厨房';\n  if (\n    t === '玄关/隔离区' ||\n    t === '玄关/净化区' ||\n    t === '玄关/净化隔离区' ||\n    t === '玄关/净化/隔离区' ||\n    t === '玄关（净化/隔离区）'\n  )\n    return '玄关/净化/隔离区';\n  if (t.startsWith('室外/')) return `户外/${t.slice('室外/'.length)}`;\n  if (t === '室外') return '户外';\n\n  return t;\n}\n\nexport function parseRoomTag(tag: string): RoomLocation {\n  const t = normalizeRoomTag(tag);\n  if (!t) return { kind: 'none' };\n\n  if (t === '玄关/临时客房A') return { kind: 'entrance', room: '临时客房A' };\n  if (t === '玄关/临时客房B') return { kind: 'entrance', room: '临时客房B' };\n  if (t === '玄关/净化/隔离区') return { kind: 'entrance', room: '净化/隔离区' };\n  if (t === '玄关') return { kind: 'entrance', room: '玄关' };\n\n  if (t === '核心区/主卧室') return { kind: 'core', room: '主卧室' };\n  if (t === '核心区/主浴室') return { kind: 'core', room: '主浴室' };\n  if (t === '核心区/客厅') return { kind: 'core', room: '客厅' };\n  if (t === '核心区/餐厅/厨房') return { kind: 'core', room: '餐厅/厨房' };\n\n  const m = t.match(/^楼层(\\d+)\\/(.+)$/);\n  if (m) {\n    const floor = String(m[1] ?? '').trim();\n    const roomNumber = String(m[2] ?? '').trim();\n    // 严格限制房号为纯数字（避免“2001门外/门口”等不规范字符串进入系统）\n    if (floor && roomNumber && /^\\d{4}$/.test(roomNumber)) return { kind: 'floor', floor, roomNumber };\n  }\n\n  const outdoor = t.match(/^户外\\/(.+)$/);\n  if (outdoor) {\n    const area = String(outdoor[1] ?? '').trim();\n    if (area) return { kind: 'outdoor', area };\n    return { kind: 'outdoor', area: '' };\n  }\n  if (t === '户外') return { kind: 'outdoor', area: '' };\n\n  return { kind: 'none' };\n}\n\nexport function roomTagFromLocation(loc: RoomLocation): string {\n  if (loc.kind === 'entrance') {\n    if (loc.room === '临时客房A') return '玄关/临时客房A';\n    if (loc.room === '临时客房B') return '玄关/临时客房B';\n    if (loc.room === '净化/隔离区') return '玄关/净化/隔离区';\n    return '玄关';\n  }\n  if (loc.kind === 'core') {\n    if (loc.room === '客厅') return '核心区/客厅';\n    if (loc.room === '餐厅/厨房') return '核心区/餐厅/厨房';\n    if (loc.room === '主卧室') return '核心区/主卧室';\n    return '核心区/主浴室';\n  }\n  if (loc.kind === 'floor') return `楼层${loc.floor}/${loc.roomNumber}`;\n  if (loc.kind === 'outdoor') return loc.area ? `户外/${loc.area}` : '户外';\n  return '';\n}\n\nexport function findRoleLocation(rooms: RoomsStatData, roleName: string): RoomLocation {\n  const name = roleName ?? '';\n  if (!name) return { kind: 'none' };\n\n  const entranceA: string[] = _.get(rooms, '玄关.临时客房A入住者', []);\n  if (Array.isArray(entranceA) && entranceA.includes(name)) return { kind: 'entrance', room: '临时客房A' };\n\n  const entranceB: string[] = _.get(rooms, '玄关.临时客房B入住者', []);\n  if (Array.isArray(entranceB) && entranceB.includes(name)) return { kind: 'entrance', room: '临时客房B' };\n\n  const purify: string[] = _.get(rooms, '玄关.净化隔离区入住者', []);\n  if (Array.isArray(purify) && purify.includes(name)) return { kind: 'entrance', room: '净化/隔离区' };\n\n  const bedroom: string[] = _.get(rooms, '核心区.主卧室使用者', []);\n  if (Array.isArray(bedroom) && bedroom.includes(name)) return { kind: 'core', room: '主卧室' };\n\n  const bathroom: string[] = _.get(rooms, '核心区.主浴室使用者', []);\n  if (Array.isArray(bathroom) && bathroom.includes(name)) return { kind: 'core', room: '主浴室' };\n\n  const livingRoom: string[] = _.get(rooms, '核心区.客厅使用者', []);\n  if (Array.isArray(livingRoom) && livingRoom.includes(name)) return { kind: 'core', room: '客厅' };\n\n  const kitchen: string[] = _.get(rooms, '核心区.餐厅厨房使用者', []);\n  if (Array.isArray(kitchen) && kitchen.includes(name)) return { kind: 'core', room: '餐厅/厨房' };\n\n  const floor20: Record<string, any> = _.get(rooms, '楼层房间.楼层20房间', {});\n  if (floor20 && typeof floor20 === 'object') {\n    for (const [roomNumber, data] of Object.entries(floor20)) {\n      const residents: string[] = (data as any)?.入住者 ?? [];\n      if (Array.isArray(residents) && residents.includes(name)) return { kind: 'floor', floor: '20', roomNumber };\n    }\n  }\n\n  const floor19: Record<string, any> = _.get(rooms, '楼层房间.楼层19房间', {});\n  if (floor19 && typeof floor19 === 'object') {\n    for (const [roomNumber, data] of Object.entries(floor19)) {\n      const residents: string[] = (data as any)?.入住者 ?? [];\n      if (Array.isArray(residents) && residents.includes(name)) return { kind: 'floor', floor: '19', roomNumber };\n    }\n  }\n\n  return { kind: 'none' };\n}\n","export type ShelterScopeByFloor = Record<string, string[]>;\n\nexport function floorRoomCapacity(level: number, floor: '20' | '19'): number {\n  const lv = Number(level);\n  if (!Number.isFinite(lv)) return 0;\n\n  if (floor === '20') {\n    // 设定：Lv3=3 间，Lv4=6 间，Lv5=12 间（封顶）\n    if (lv < 3) return 0;\n    if (lv === 3) return 3;\n    if (lv === 4) return 6;\n    return 12;\n  }\n\n  // 19 层从等级 6 开始\n  if (lv < 6) return 0;\n  return _.clamp((lv - 5) * 3, 0, 12);\n}\n\nexport function isRoomSheltered(scope: ShelterScopeByFloor, floor: '20' | '19', roomNumber: string): boolean {\n  const list = scope?.[floor] ?? [];\n  if (!Array.isArray(list)) return false;\n  return list.includes(roomNumber);\n}\n\nexport function normalizeScope(scope: ShelterScopeByFloor): ShelterScopeByFloor {\n  const out: ShelterScopeByFloor = {};\n  for (const [floor, rooms] of Object.entries(scope ?? {})) {\n    if (!Array.isArray(rooms)) continue;\n    out[floor] = _(rooms)\n      .filter((x: any) => typeof x === 'string' && x.trim().length > 0)\n      .filter((room: string) => !(floor === '20' && room === '2001'))\n      .uniq()\n      .sortBy()\n      .value();\n  }\n  return out;\n}\n","type ParsedWorldTime = {\n  epochMinutes: number;\n  hour: number;\n  minute: number;\n};\n\nfunction parseDateToEpochDay(dateStr: string): number | null {\n  // 格式：末日纪元，XXXX年XX月XX日\n  const m = (dateStr ?? '').match(/(\\d{1,4})年(\\d{1,2})月(\\d{1,2})日/);\n  if (!m) return null;\n  const year = Number(m[1]);\n  const month = Number(m[2]);\n  const day = Number(m[3]);\n  if (!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day)) return null;\n  const d = new Date(year, month - 1, day);\n  if (Number.isNaN(d.getTime())) return null;\n  return Math.floor(d.getTime() / 86400000);\n}\n\nfunction parseTimeToMinutes(timeStr: string): { hour: number; minute: number } | null {\n  // 格式：时间段 - HH:MM\n  const m = (timeStr ?? '').match(/(\\d{1,2}):(\\d{2})/);\n  if (!m) return null;\n  const hour = Number(m[1]);\n  const minute = Number(m[2]);\n  if (!Number.isFinite(hour) || !Number.isFinite(minute)) return null;\n  if (hour < 0 || hour > 23 || minute < 0 || minute > 59) return null;\n  return { hour, minute };\n}\n\nexport function parseWorldTime(dateStr: string, timeStr: string): ParsedWorldTime | null {\n  const day = parseDateToEpochDay(dateStr);\n  const hm = parseTimeToMinutes(timeStr);\n  if (day === null || hm === null) return null;\n  const epochMinutes = day * 1440 + hm.hour * 60 + hm.minute;\n  return { epochMinutes, hour: hm.hour, minute: hm.minute };\n}\n\nexport function diffWorldHours(\n  oldWorld: { 日期?: string; 时间?: string },\n  newWorld: { 日期?: string; 时间?: string },\n): number | null {\n  const oldParsed = parseWorldTime(oldWorld.日期 ?? '', oldWorld.时间 ?? '');\n  const newParsed = parseWorldTime(newWorld.日期 ?? '', newWorld.时间 ?? '');\n  if (!oldParsed || !newParsed) return null;\n  const diffMinutes = newParsed.epochMinutes - oldParsed.epochMinutes;\n  if (!Number.isFinite(diffMinutes)) return null;\n  if (diffMinutes <= 0) return null;\n  return diffMinutes / 60;\n}\n","import type { ShelterScopeByFloor } from '../util/shelter_scope';\n\nexport const CHAT_VAR_KEYS = {\n  EDEN_SHELTER_SCOPE: 'eden.shelter_scope',\n  EDEN_RULES_HEALTH: 'eden.rules.health',\n  EDEN_SHELTER_UPGRADE: 'eden.shelter_upgrade',\n  UI_SETTINGS: 'ui_settings',\n} as const;\n\nexport type SendToChatResult =\n  | { ok: true; method: 'triggerSlash'; sentText: string }\n  | { ok: false; method: 'triggerSlash' | 'unavailable'; reason: string; sentText: string };\n\nexport type CopyTextResult =\n  | { ok: true; method: 'clipboard' | 'execCommand'; text: string }\n  | { ok: false; method: 'clipboard' | 'execCommand'; reason: string; text: string };\n\ntype DebugSetting =\n  | boolean\n  | {\n      enabled?: boolean;\n      toConsole?: boolean;\n      toChat?: boolean;\n    };\n\nconst OUTBOUND_DEBUG_FLAG_PATH = 'ui_settings.debug_outbound';\nconst OUTBOUND_LOG_PATH = 'eden.debug.outbound_log';\nconst OUTBOUND_LOG_MAX = 50;\n\nfunction normalizeChatText(input: string): string {\n  const raw = String(input ?? '');\n  const noNewlines = raw.replace(/\\r?\\n+/g, ' ').trim();\n  // `/send ... | /trigger` 的管道分隔符，避免被用户文本打断\n  return noNewlines.replaceAll('|', '｜');\n}\n\nfunction resolveDebug(debug?: DebugSetting): { enabled: boolean; toConsole: boolean; toChat: boolean } {\n  if (typeof debug === 'boolean') {\n    return { enabled: debug, toConsole: debug, toChat: false };\n  }\n  if (debug && typeof debug === 'object') {\n    const enabled = debug.enabled ?? true;\n    return { enabled, toConsole: debug.toConsole ?? enabled, toChat: debug.toChat ?? false };\n  }\n\n  // 默认：如果 chat 变量里打开了 ui_settings.debug_outbound，就输出到 console（不写回 chat，避免污染存档）\n  try {\n    const vars = getVariables?.({ type: 'chat' }) ?? {};\n    const flag = OUTBOUND_DEBUG_FLAG_PATH.split('.').reduce<any>((acc, k) => (acc ? acc[k] : undefined), vars);\n    const enabled = flag === true;\n    return { enabled, toConsole: enabled, toChat: false };\n  } catch {\n    return { enabled: false, toConsole: false, toChat: false };\n  }\n}\n\nfunction truncateText(text: string, max = 200): string {\n  const s = String(text ?? '');\n  if (s.length <= max) return s;\n  return `${s.slice(0, max)}…`;\n}\n\nfunction setDeep(obj: any, path: string, value: any) {\n  const keys = path.split('.').filter(Boolean);\n  if (keys.length === 0) return;\n  let cur = obj;\n  for (let i = 0; i < keys.length - 1; i++) {\n    const k = keys[i];\n    if (!cur[k] || typeof cur[k] !== 'object') cur[k] = {};\n    cur = cur[k];\n  }\n  cur[keys[keys.length - 1]] = value;\n}\n\nfunction getDeep(obj: any, path: string): any {\n  const keys = path.split('.').filter(Boolean);\n  let cur = obj;\n  for (const k of keys) {\n    if (!cur || typeof cur !== 'object') return undefined;\n    cur = cur[k];\n  }\n  return cur;\n}\n\nfunction debugLog(\n  debug: { enabled: boolean; toConsole: boolean; toChat: boolean },\n  event: string,\n  payload: Record<string, any>,\n) {\n  if (!debug.enabled) return;\n\n  const record = {\n    ts: new Date().toISOString(),\n    event,\n    ...payload,\n  };\n\n  if (debug.toConsole) {\n    // eslint-disable-next-line no-console\n    console.debug?.('[eden/outbound]', record);\n  }\n\n  if (debug.toChat && typeof updateVariablesWith === 'function') {\n    try {\n      updateVariablesWith(\n        (vars: any) => {\n          const current = getDeep(vars, OUTBOUND_LOG_PATH);\n          const list = Array.isArray(current) ? current.slice() : [];\n          list.push(record);\n          if (list.length > OUTBOUND_LOG_MAX) {\n            list.splice(0, list.length - OUTBOUND_LOG_MAX);\n          }\n          setDeep(vars, OUTBOUND_LOG_PATH, list);\n          return vars;\n        },\n        { type: 'chat' },\n      );\n    } catch {\n      // ignore\n    }\n  }\n}\n\nexport function sendToChat(\n  text: string,\n  {\n    toast = true,\n    awaitTrigger = true,\n    debug,\n    successMessage = '已发送到聊天',\n    failureMessage = '发送失败，请复制后手动发送',\n    unavailableMessage = '无法发送：triggerSlash 不可用',\n  }: {\n    toast?: boolean;\n    awaitTrigger?: boolean;\n    debug?: DebugSetting;\n    successMessage?: string;\n    failureMessage?: string;\n    unavailableMessage?: string;\n  } = {},\n): SendToChatResult {\n  const debugResolved = resolveDebug(debug);\n  const sentText = normalizeChatText(text);\n  if (!sentText) {\n    const reason = '空文本';\n    if (toast) toastr?.warning?.(reason);\n    debugLog(debugResolved, 'sendToChat', { ok: false, method: 'unavailable', reason, text: truncateText(text) });\n    return { ok: false, method: 'unavailable', reason, sentText };\n  }\n\n  if (typeof triggerSlash !== 'function') {\n    if (toast) toastr?.error?.(unavailableMessage);\n    debugLog(debugResolved, 'sendToChat', {\n      ok: false,\n      method: 'unavailable',\n      reason: unavailableMessage,\n      text: truncateText(sentText),\n    });\n    return { ok: false, method: 'unavailable', reason: unavailableMessage, sentText };\n  }\n\n  const cmd = awaitTrigger ? `/send ${sentText} | /trigger await=true` : `/send ${sentText}`;\n  try {\n    triggerSlash(cmd);\n    if (toast) toastr?.success?.(successMessage);\n    debugLog(debugResolved, 'sendToChat', { ok: true, method: 'triggerSlash', text: truncateText(sentText) });\n    return { ok: true, method: 'triggerSlash', sentText };\n  } catch (err) {\n    const reason = err instanceof Error ? err.message : String(err);\n    if (toast) toastr?.error?.(failureMessage);\n    debugLog(debugResolved, 'sendToChat', { ok: false, method: 'triggerSlash', reason, text: truncateText(sentText) });\n    return { ok: false, method: 'triggerSlash', reason, sentText };\n  }\n}\n\nexport async function copyText(\n  text: string,\n  {\n    toast = true,\n    debug,\n    successMessage = '已复制',\n    failureMessage = '复制失败，请手动复制',\n  }: { toast?: boolean; debug?: DebugSetting; successMessage?: string; failureMessage?: string } = {},\n): Promise<CopyTextResult> {\n  const debugResolved = resolveDebug(debug);\n  const normalized = String(text ?? '').trim();\n  if (!normalized) {\n    const reason = '空文本';\n    if (toast) toastr?.warning?.(reason);\n    debugLog(debugResolved, 'copyText', { ok: false, method: 'clipboard', reason, text: truncateText(text) });\n    return { ok: false, method: 'clipboard', reason, text: normalized };\n  }\n\n  try {\n    await navigator.clipboard.writeText(normalized);\n    if (toast) toastr?.success?.(successMessage);\n    debugLog(debugResolved, 'copyText', { ok: true, method: 'clipboard', text: truncateText(normalized) });\n    return { ok: true, method: 'clipboard', text: normalized };\n  } catch {\n    // fallback\n  }\n\n  try {\n    const ta = document.createElement('textarea');\n    ta.value = normalized;\n    ta.style.position = 'fixed';\n    ta.style.left = '-9999px';\n    ta.style.top = '0';\n    document.body.appendChild(ta);\n    ta.focus();\n    ta.select();\n    document.execCommand('copy');\n    document.body.removeChild(ta);\n    if (toast) toastr?.success?.(successMessage);\n    debugLog(debugResolved, 'copyText', { ok: true, method: 'execCommand', text: truncateText(normalized) });\n    return { ok: true, method: 'execCommand', text: normalized };\n  } catch (err) {\n    const reason = err instanceof Error ? err.message : String(err);\n    if (toast) toastr?.error?.(failureMessage);\n    debugLog(debugResolved, 'copyText', { ok: false, method: 'execCommand', reason, text: truncateText(normalized) });\n    return { ok: false, method: 'execCommand', reason, text: normalized };\n  }\n}\n\nexport function buildShelterScopeInstructionText(scope: ShelterScopeByFloor): string {\n  const floors = (['20', '19'] as const)\n    .map(floor => ({ floor, rooms: scope?.[floor] ?? [] }))\n    .filter(x => x.rooms.length > 0);\n\n  if (floors.length === 0) return '';\n\n  const parts = floors.map(({ floor, rooms }) => `楼层${floor}的${rooms.join('、')}房间`);\n  return `{{user}}指令伊甸将${parts.join('、以及')}，设为其生存庇护范围，这些房间的通风系统、供暖系统将与伊甸同步：进入该房间的角色将不再因恶劣天气扣减健康值。`;\n}\n","import { z } from 'zod';\nimport { clampHealth, computeOffstageHealthDelta, healthCondition, HealthRules } from '../../util/health';\nimport { findRoleLocation, normalizeRoomTag, parseRoomTag, roomTagFromLocation } from '../../util/room';\nimport { floorRoomCapacity, isRoomSheltered, normalizeScope, ShelterScopeByFloor } from '../../util/shelter_scope';\nimport { diffWorldHours } from '../../util/time';\nimport { CHAT_VAR_KEYS } from '../../界面/outbound';\n\nimport shelterBlueprintRaw from '../../世界书/寒冬末日/庇护所升级能力.txt?raw';\n\ntype Rooms = any;\n\ntype EdenDebugSetting = {\n  enabled: boolean;\n  toConsole: boolean;\n  toChat: boolean;\n};\n\nconst EDEN_HELPER_VERSION = '1.2';\nconst EDEN_HELPER_ACTIVE_INSTANCE_KEY = '__eden_helper_active_instance__';\nconst EDEN_HELPER_INSTANCE_ID = (() => {\n  try {\n    return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;\n  } catch {\n    return String(Date.now());\n  }\n})();\n\nconst EDEN_HELPER_DEBUG_FLAG_PATH = 'eden.debug.eden_helper';\nconst EDEN_HELPER_DEBUG_TO_CHAT_FLAG_PATH = 'eden.debug.to_chat';\nconst EDEN_HELPER_DEBUG_LOG_PATH = 'eden.debug.eden_helper_log';\nconst EDEN_HELPER_DEBUG_LOG_MAX = 80;\n\nconst DEBUG_BUTTON_TOGGLE = '伊甸调试开关';\nconst DEBUG_BUTTON_TOGGLE_CHATLOG = '伊甸调试写入日志';\n\nfunction getDeep(obj: any, path: string): any {\n  const keys = String(path ?? '')\n    .split('.')\n    .filter(Boolean);\n  let cur = obj;\n  for (const k of keys) {\n    if (!cur || typeof cur !== 'object') return undefined;\n    cur = cur[k];\n  }\n  return cur;\n}\n\nfunction setDeep(obj: any, path: string, value: any) {\n  const keys = String(path ?? '')\n    .split('.')\n    .filter(Boolean);\n  if (keys.length === 0) return;\n  let cur = obj;\n  for (let i = 0; i < keys.length - 1; i++) {\n    const k = keys[i];\n    if (!cur[k] || typeof cur[k] !== 'object') cur[k] = {};\n    cur = cur[k];\n  }\n  cur[keys[keys.length - 1]] = value;\n}\n\nfunction safeStringify(value: any, maxLen = 1200): string {\n  try {\n    const json = JSON.stringify(value, (_k, v) => {\n      if (typeof v === 'string' && v.length > 400) return `${v.slice(0, 400)}…`;\n      return v;\n    });\n    if (typeof json !== 'string') return String(value ?? '');\n    if (json.length <= maxLen) return json;\n    return `${json.slice(0, maxLen)}…`;\n  } catch {\n    return String(value ?? '');\n  }\n}\n\nfunction resolveEdenDebugSetting(): EdenDebugSetting {\n  try {\n    // 支持 ?debug：方便在不便写入变量时快速开启控制台日志（不写入 chat）\n    try {\n      const search = new URLSearchParams(window.location.search);\n      if (search.has('debug') || search.has('dev')) {\n        return { enabled: true, toConsole: true, toChat: search.has('to_chat') };\n      }\n    } catch {\n      // ignore\n    }\n\n    const vars = typeof getVariables === 'function' ? (getVariables({ type: 'chat' }) ?? {}) : {};\n    const enabled = getDeep(vars, EDEN_HELPER_DEBUG_FLAG_PATH) === true;\n    const toChat = getDeep(vars, EDEN_HELPER_DEBUG_TO_CHAT_FLAG_PATH) === true;\n    return { enabled, toConsole: enabled, toChat };\n  } catch {\n    return { enabled: false, toConsole: false, toChat: false };\n  }\n}\n\nfunction getHostGlobal(): any {\n  // 在 SillyTavern 中脚本运行于 iframe，顶层 window 可作为“跨重载”的共享存储。\n  try {\n    return (window.top ?? window) as any;\n  } catch {\n    return window as any;\n  }\n}\n\nfunction markThisInstanceActive() {\n  try {\n    const host = getHostGlobal();\n    host[EDEN_HELPER_ACTIVE_INSTANCE_KEY] = {\n      id: EDEN_HELPER_INSTANCE_ID,\n      version: EDEN_HELPER_VERSION,\n      scriptId: typeof getScriptId === 'function' ? (getScriptId() as any) : null,\n      ts: new Date().toISOString(),\n    };\n  } catch {\n    // ignore\n  }\n}\n\nfunction isActiveInstance(): boolean {\n  try {\n    const host = getHostGlobal();\n    const cur = host?.[EDEN_HELPER_ACTIVE_INSTANCE_KEY];\n    // 若宿主没写入 active key（极端环境），默认放行，避免脚本“完全失效”。\n    if (!cur || typeof cur !== 'object') return true;\n    return cur.id === EDEN_HELPER_INSTANCE_ID;\n  } catch {\n    return true;\n  }\n}\n\nfunction edenLog(\n  level: 'debug' | 'info' | 'warn' | 'error',\n  event: string,\n  payload?: Record<string, any>,\n  debugSetting?: EdenDebugSetting,\n) {\n  if (!isActiveInstance()) return;\n  const debug = debugSetting ?? resolveEdenDebugSetting();\n  if (!debug.enabled) return;\n\n  const zh = typeof payload?.zh === 'string' ? (payload.zh as string) : '';\n  const payloadForPrint = payload ? { ...payload } : undefined;\n  if (payloadForPrint && 'zh' in payloadForPrint) delete (payloadForPrint as any).zh;\n\n  const record = {\n    ts: new Date().toISOString(),\n    level,\n    event,\n    ...(zh ? { zh } : {}),\n    ...(payload ? payload : {}),\n  };\n\n  if (debug.toConsole) {\n    const head = zh ? `${zh} (${event})` : event;\n    const tail = payloadForPrint ? ` ${safeStringify(payloadForPrint)}` : '';\n    (console as any)?.[level]?.(`[eden/helper] ${head}${tail}`);\n  }\n\n  if (debug.toChat && typeof updateVariablesWith === 'function') {\n    try {\n      updateVariablesWith(\n        (vars: any) => {\n          const current = getDeep(vars, EDEN_HELPER_DEBUG_LOG_PATH);\n          const list = Array.isArray(current) ? current.slice() : [];\n          list.push({\n            ts: record.ts,\n            level: record.level,\n            event: record.event,\n            zh: record.zh ?? '',\n            data: payload ? safeStringify(payload) : '',\n          });\n          if (list.length > EDEN_HELPER_DEBUG_LOG_MAX) list.splice(0, list.length - EDEN_HELPER_DEBUG_LOG_MAX);\n          setDeep(vars, EDEN_HELPER_DEBUG_LOG_PATH, list);\n          return vars;\n        },\n        { type: 'chat' },\n      );\n    } catch {\n      // ignore\n    }\n  }\n}\n\nfunction readChatDebugFlag(path: string): boolean {\n  try {\n    const vars = typeof getVariables === 'function' ? (getVariables({ type: 'chat' }) ?? {}) : {};\n    return _.get(vars, path, false) === true;\n  } catch {\n    return false;\n  }\n}\n\nfunction writeChatDebugFlags(next: {\n  eden_helper?: boolean;\n  date_logic?: boolean;\n  offstage_health?: boolean;\n  room_logic?: boolean;\n  to_chat?: boolean;\n}) {\n  if (typeof updateVariablesWith !== 'function') return;\n  updateVariablesWith(\n    vars => {\n      if (typeof next.eden_helper === 'boolean') _.set(vars, 'eden.debug.eden_helper', next.eden_helper);\n      if (typeof next.date_logic === 'boolean') _.set(vars, 'eden.debug.date_logic', next.date_logic);\n      if (typeof next.offstage_health === 'boolean') _.set(vars, 'eden.debug.offstage_health', next.offstage_health);\n      if (typeof next.room_logic === 'boolean') _.set(vars, 'eden.debug.room_logic', next.room_logic);\n      if (typeof next.to_chat === 'boolean') _.set(vars, 'eden.debug.to_chat', next.to_chat);\n      return vars;\n    },\n    { type: 'chat' },\n  );\n}\n\nfunction ensureDebugButtons() {\n  if (typeof appendInexistentScriptButtons !== 'function') return;\n  if (typeof getButtonEvent !== 'function') return;\n  if (typeof eventOn !== 'function') return;\n\n  appendInexistentScriptButtons([\n    { name: DEBUG_BUTTON_TOGGLE, visible: true },\n    { name: DEBUG_BUTTON_TOGGLE_CHATLOG, visible: true },\n  ]);\n\n  eventOn(getButtonEvent(DEBUG_BUTTON_TOGGLE), () => {\n    if (!isActiveInstance()) return;\n    const cur = readChatDebugFlag('eden.debug.eden_helper');\n    const next = !cur;\n    writeChatDebugFlags({\n      eden_helper: next,\n      date_logic: next,\n      offstage_health: next,\n      room_logic: next,\n    });\n    toastr?.info?.(`伊甸调试：${next ? '已开启' : '已关闭'}`);\n\n    console.log(`[eden/helper] 调试开关：${next ? '开启' : '关闭'} ${safeStringify({ enabled: next })}`);\n  });\n\n  eventOn(getButtonEvent(DEBUG_BUTTON_TOGGLE_CHATLOG), () => {\n    if (!isActiveInstance()) return;\n    const cur = readChatDebugFlag('eden.debug.to_chat');\n    const next = !cur;\n    writeChatDebugFlags({ to_chat: next });\n    toastr?.info?.(`伊甸调试写入日志：${next ? '已开启' : '已关闭'}`);\n\n    console.log(`[eden/helper] 调试写入日志：${next ? '开启' : '关闭'} ${safeStringify({ to_chat: next })}`);\n  });\n}\n\nfunction readRoomDebugFlagFromChat(): boolean {\n  const vars = getVariables({ type: 'chat' }) ?? {};\n  const debug = _.get(vars, 'eden.debug', {}) ?? {};\n  return _.get(debug, 'room_logic', false) === true;\n}\n\nfunction notifyEdenHelperLoaded() {\n  try {\n    if (!isActiveInstance()) return;\n    const id = typeof getScriptId === 'function' ? String(getScriptId() ?? 'unknown') : 'unknown';\n    const key = `eden.helper.loaded.${id}.v${EDEN_HELPER_VERSION}`;\n    if (sessionStorage.getItem(key)) return;\n    sessionStorage.setItem(key, '1');\n    toastr?.success?.(`伊甸后台数据辅助 v${EDEN_HELPER_VERSION} 加载成功`);\n  } catch {\n    // ignore\n  }\n}\n\nfunction listRoomTagsFromRooms(rooms: Rooms): string[] {\n  const tags: string[] = [\n    '玄关/净化/隔离区',\n    '玄关/临时客房A',\n    '玄关/临时客房B',\n    '核心区/客厅',\n    '核心区/餐厅/厨房',\n    '核心区/主卧室',\n    '核心区/主浴室',\n  ];\n\n  const floor20: Record<string, any> = _.get(rooms, '楼层房间.楼层20房间', {});\n  if (floor20 && typeof floor20 === 'object') {\n    for (const k of Object.keys(floor20)) {\n      const roomNumber = String(k ?? '').trim();\n      if (roomNumber) tags.push(`楼层20/${roomNumber}`);\n    }\n  }\n  const floor19: Record<string, any> = _.get(rooms, '楼层房间.楼层19房间', {});\n  if (floor19 && typeof floor19 === 'object') {\n    for (const k of Object.keys(floor19)) {\n      const roomNumber = String(k ?? '').trim();\n      if (roomNumber) tags.push(`楼层19/${roomNumber}`);\n    }\n  }\n\n  return _(tags).uniq().value();\n}\n\nfunction readRoomListByTag(rooms: Rooms, tag: string): string[] {\n  const t = normalizeRoomTag(tag);\n  if (t === '玄关/净化/隔离区') return _.get(rooms, '玄关.净化隔离区入住者', []);\n  if (t === '玄关/临时客房A') return _.get(rooms, '玄关.临时客房A入住者', []);\n  if (t === '玄关/临时客房B') return _.get(rooms, '玄关.临时客房B入住者', []);\n  if (t === '核心区/客厅') return _.get(rooms, '核心区.客厅使用者', []);\n  if (t === '核心区/餐厅/厨房') return _.get(rooms, '核心区.餐厅厨房使用者', []);\n  if (t === '核心区/主卧室') return _.get(rooms, '核心区.主卧室使用者', []);\n  if (t === '核心区/主浴室') return _.get(rooms, '核心区.主浴室使用者', []);\n\n  const m = t.match(/^楼层(20|19)\\/(.+)$/);\n  if (m) {\n    const floor = m[1];\n    const roomNumber = String(m[2] ?? '').trim();\n    if (!roomNumber) return [];\n    return _.get(rooms, `楼层房间.楼层${floor}房间.${roomNumber}.入住者`, []);\n  }\n\n  return [];\n}\n\nfunction listRoleNames(stat_data: any): { core: string[]; tempNpc: string[] } {\n  const reserved = new Set(['世界', '庇护所', '房间', '主线任务', '楼层其他住户', '临时NPC']);\n\n  const core: string[] = [];\n  for (const [k, v] of Object.entries(stat_data ?? {})) {\n    if (reserved.has(k)) continue;\n    if (typeof k !== 'string' || !k || k.startsWith('_')) continue;\n    if (!v || typeof v !== 'object') continue;\n    if (!('登场状态' in v) || !('健康' in v)) continue;\n    core.push(k);\n  }\n\n  const tempNpc: string[] = [];\n  const temp = _.get(stat_data, '临时NPC', {});\n  if (temp && typeof temp === 'object' && !Array.isArray(temp)) {\n    for (const [k, v] of Object.entries(temp)) {\n      if (typeof k !== 'string' || !k) continue;\n      if (!v || typeof v !== 'object') continue;\n      if (!('登场状态' in v) || !('健康' in v)) continue;\n      tempNpc.push(k);\n    }\n  }\n\n  return { core, tempNpc };\n}\n\nfunction readRoleRoomTag(stat_data: any, name: string, isTempNpc: boolean): string {\n  const path = isTempNpc ? `临时NPC.${name}.所在房间` : `${name}.所在房间`;\n  return normalizeRoomTag(_.get(stat_data, path, ''));\n}\n\nfunction writeRoleRoomTag(stat_data: any, name: string, isTempNpc: boolean, tag: string) {\n  const path = isTempNpc ? `临时NPC.${name}.所在房间` : `${name}.所在房间`;\n  _.set(stat_data, path, normalizeRoomTag(tag));\n}\n\nfunction isValidExplicitTag(tag: string): boolean {\n  if (!tag) return false;\n  const loc = parseRoomTag(tag);\n  return loc.kind !== 'none';\n}\n\nfunction resolveRoleFinalTagTagOnly(args: { oldTag: string; newTag: string }): { finalTag: string; reason: string } {\n  const oldTag = normalizeRoomTag(args.oldTag);\n  const newTag = normalizeRoomTag(args.newTag);\n\n  if (isValidExplicitTag(newTag)) return { finalTag: newTag, reason: 'explicit' };\n  if (newTag === '') {\n    return isValidExplicitTag(oldTag) ? { finalTag: '', reason: 'explicit-none' } : { finalTag: '', reason: 'none' };\n  }\n\n  if (isValidExplicitTag(oldTag)) return { finalTag: oldTag, reason: 'invalid-keep-old' };\n  return { finalTag: '', reason: 'invalid-to-none' };\n}\n\nfunction bootstrapMissingRoleRoomTagsFromRooms(stat_data: any, debug: boolean) {\n  const rooms = _.get(stat_data, '房间', {}) ?? {};\n  const { core, tempNpc } = listRoleNames(stat_data);\n\n  const patched: Array<{ name: string; tag: string }> = [];\n  for (const name of [...core, ...tempNpc]) {\n    const isTemp = tempNpc.includes(name);\n    const curTag = readRoleRoomTag(stat_data, name, isTemp);\n    if (curTag) continue;\n\n    const loc = findRoleLocation(rooms, name);\n    const tag = roomTagFromLocation(loc);\n    if (!tag) continue;\n\n    writeRoleRoomTag(stat_data, name, isTemp, tag);\n    patched.push({ name, tag });\n  }\n\n  if (debug && patched.length > 0) {\n    console.log('[房间逻辑] 已从「房间」表补齐缺失的角色所在房间标签:', patched);\n  }\n}\n\nfunction keepUnknownNames(list: any, known: Set<string>): string[] {\n  if (!Array.isArray(list)) return [];\n  return _(list)\n    .filter((x: any) => typeof x === 'string')\n    .map((x: string) => x.trim())\n    .filter((x: string) => x.length > 0 && !known.has(x))\n    .value();\n}\n\nfunction ensureFloorRoomSlot(nextRooms: Rooms, floor: '20' | '19', roomNumber: string) {\n  const path = `楼层房间.楼层${floor}房间.${roomNumber}`;\n  const cur = _.get(nextRooms, path, null);\n  if (!cur || typeof cur !== 'object') _.set(nextRooms, path, { 入住者: [] });\n  const residents = _.get(nextRooms, `${path}.入住者`, null);\n  if (!Array.isArray(residents)) _.set(nextRooms, `${path}.入住者`, []);\n}\n\nfunction writeRoomListByTag(nextRooms: Rooms, tag: string, list: string[]) {\n  const t = normalizeRoomTag(tag);\n  if (t === '玄关/净化/隔离区') return void _.set(nextRooms, '玄关.净化隔离区入住者', list);\n  if (t === '玄关/临时客房A') return void _.set(nextRooms, '玄关.临时客房A入住者', list);\n  if (t === '玄关/临时客房B') return void _.set(nextRooms, '玄关.临时客房B入住者', list);\n  if (t === '核心区/客厅') return void _.set(nextRooms, '核心区.客厅使用者', list);\n  if (t === '核心区/餐厅/厨房') return void _.set(nextRooms, '核心区.餐厅厨房使用者', list);\n  if (t === '核心区/主卧室') return void _.set(nextRooms, '核心区.主卧室使用者', list);\n  if (t === '核心区/主浴室') return void _.set(nextRooms, '核心区.主浴室使用者', list);\n\n  const m = t.match(/^楼层(20|19)\\/(.+)$/);\n  if (!m) return;\n  const floor = m[1] as '20' | '19';\n  const roomNumber = String(m[2] ?? '').trim();\n  if (!roomNumber) return;\n  ensureFloorRoomSlot(nextRooms, floor, roomNumber);\n  _.set(nextRooms, `楼层房间.楼层${floor}房间.${roomNumber}.入住者`, list);\n}\n\nfunction applyRoomConsistency(stat_data: any, old_stat_data: any, debug: boolean) {\n  const rooms = _.get(stat_data, '房间', {}) ?? {};\n  const oldRooms = _.get(old_stat_data, '房间', {}) ?? {};\n\n  bootstrapMissingRoleRoomTagsFromRooms(stat_data, debug);\n\n  const { core, tempNpc } = listRoleNames(stat_data);\n  const knownNames = new Set<string>([...core, ...tempNpc]);\n\n  const allTags = _([...listRoomTagsFromRooms(oldRooms), ...listRoomTagsFromRooms(rooms)])\n    .uniq()\n    .value();\n\n  const finalTagByName = new Map<string, string>();\n  const finalReasonByName = new Map<string, string>();\n  const oldTagByName = new Map<string, string>();\n  const newTagByName = new Map<string, string>();\n\n  for (const name of [...core, ...tempNpc]) {\n    const isTemp = tempNpc.includes(name);\n    const oldTag = readRoleRoomTag(old_stat_data, name, isTemp);\n    const newTag = readRoleRoomTag(stat_data, name, isTemp);\n    oldTagByName.set(name, oldTag);\n    newTagByName.set(name, newTag);\n\n    const { finalTag, reason } = resolveRoleFinalTagTagOnly({ oldTag, newTag });\n    finalTagByName.set(name, finalTag);\n    finalReasonByName.set(name, reason);\n\n    if (finalTag !== newTag) {\n      writeRoleRoomTag(stat_data, name, isTemp, finalTag);\n    }\n  }\n\n  const nextRooms: Rooms = _.cloneDeep(rooms ?? {});\n\n  for (const tag of allTags) {\n    const base = keepUnknownNames(readRoomListByTag(oldRooms, tag), knownNames);\n    writeRoomListByTag(nextRooms, tag, base);\n  }\n\n  for (const name of [...core, ...tempNpc]) {\n    const tag = finalTagByName.get(name) ?? '';\n    if (!tag) continue;\n    const list = readRoomListByTag(nextRooms, tag);\n    const next = Array.isArray(list) ? list.slice() : [];\n    if (!next.includes(name)) next.push(name);\n    writeRoomListByTag(nextRooms, tag, next);\n  }\n\n  const allKnown = [...core, ...tempNpc];\n  for (const tag of allTags) {\n    const list = readRoomListByTag(nextRooms, tag);\n    const normalized = _(list)\n      .filter((x: any) => typeof x === 'string')\n      .map((x: string) => x.trim())\n      .filter((x: string) => x.length > 0)\n      .uniq()\n      .value();\n\n    const kept = normalized.filter(x => !allKnown.includes(x));\n    const known = normalized.filter(x => allKnown.includes(x));\n    writeRoomListByTag(nextRooms, tag, [...kept, ...known]);\n  }\n\n  _.set(stat_data, '房间', nextRooms);\n\n  if (debug) {\n    const mismatch: Array<{ name: string; old: string; next: string; final: string; reason: string }> = [];\n    for (const name of [...core, ...tempNpc]) {\n      const oldTag = oldTagByName.get(name) ?? '';\n      const newTag = newTagByName.get(name) ?? '';\n      const finalTag = finalTagByName.get(name) ?? '';\n      const reason = finalReasonByName.get(name) ?? '';\n      if (oldTag !== newTag || newTag !== finalTag)\n        mismatch.push({ name, old: oldTag, next: newTag, final: finalTag, reason });\n    }\n    if (mismatch.length > 0) console.log('[房间逻辑] 房间标签对齐详情:', mismatch);\n\n    const dup: Array<{ name: string; tags: string[] }> = [];\n    const writeTags = allTags;\n    for (const name of [...core, ...tempNpc]) {\n      const tags = writeTags.filter(t => (readRoomListByTag(nextRooms, t) ?? []).includes(name));\n      if (tags.length > 1) dup.push({ name, tags });\n    }\n    if (dup.length > 0) console.log('[房间逻辑] 对齐后仍存在多房间重复占用:', dup);\n\n    const reasons = [...finalReasonByName.entries()].reduce<Record<string, number>>((acc, [, r]) => {\n      acc[r] = (acc[r] ?? 0) + 1;\n      return acc;\n    }, {});\n    console.log('[房间逻辑] 对齐原因统计:', reasons);\n  }\n}\n\ntype ScopeDelta = {\n  add?: ShelterScopeByFloor;\n  remove?: ShelterScopeByFloor;\n  note?: string;\n};\n\nfunction readShelterScopeFromChat(): ShelterScopeByFloor {\n  const vars = getVariables({ type: 'chat' }) ?? {};\n  const raw = _.get(vars, CHAT_VAR_KEYS.EDEN_SHELTER_SCOPE, {});\n  if (!raw || typeof raw !== 'object') return {};\n  return normalizeScope(raw as any);\n}\n\nfunction writeShelterScopeToChat(scope: ShelterScopeByFloor) {\n  if (typeof updateVariablesWith !== 'function') return;\n  updateVariablesWith(\n    vars => {\n      _.set(vars, CHAT_VAR_KEYS.EDEN_SHELTER_SCOPE, normalizeScope(scope));\n      return vars;\n    },\n    { type: 'chat' },\n  );\n}\n\nfunction clampLevel(level: any): number {\n  const lv = Number(level);\n  return _.clamp(Number.isFinite(lv) ? lv : 1, 1, 10);\n}\n\ntype Ability = { name: string; desc: string };\n\ntype ShelterUpgradeState = z.output<typeof ShelterUpgradeStateSchema>;\n\nconst ShelterUpgradeStateSchema = z\n  .object({\n    last_roll_date: z.string().prefault(''),\n    days_since_upgrade: z.coerce.number().prefault(0),\n\n    // meta: 用于 UI 显示 NEW 标签、以及调试定位“谁生效了”\n    // roll_history: 以“日期”为粒度的一次性结算记录（用于防删楼刷点、以及回看旧日期时保持点数稳定）\n    roll_history: z\n      .record(\n        z.string(),\n        z\n          .object({\n            roll: z.union([z.coerce.number(), z.null()]),\n            upgraded: z.boolean(),\n            reason: z.string().prefault('normal'),\n            source: z.string().prefault('script'),\n            ts: z.string().prefault(''),\n            event_id: z.string().optional(),\n            message_id: z.coerce.number().optional(),\n            trigger: z.string().optional(),\n          })\n          .passthrough(),\n      )\n      .prefault({}),\n    last_roll_value: z.union([z.coerce.number(), z.null()]).optional(),\n    last_roll_upgraded: z.boolean().optional(),\n    last_roll_reason: z.string().optional(),\n    last_roll_source: z.string().optional(),\n    last_roll_event_id: z.string().optional(),\n    last_roll_settled: z.boolean().optional(),\n\n    last_level_message_id: z.coerce.number().optional(),\n    last_level_source: z.string().optional(),\n\n    last_ability_message_id: z.coerce.number().optional(),\n    last_ability_source: z.string().optional(),\n    last_ability_changed: z.boolean().optional(),\n    last_ability_event_id: z.string().optional(),\n    last_ability_added_names: z.array(z.string()).optional(),\n\n    manual_request: z\n      .object({\n        id: z.string().prefault(''),\n        message_id: z.coerce.number().prefault(0),\n        today: z.string().prefault(''),\n        ts: z.string().prefault(''),\n      })\n      .prefault({ id: '', message_id: 0, today: '', ts: '' })\n      .optional(),\n  })\n  .passthrough()\n  .prefault({ last_roll_date: '', days_since_upgrade: 0 });\n\nfunction readShelterUpgradeState(): ShelterUpgradeState {\n  try {\n    const vars = getVariables({ type: 'chat' }) ?? {};\n    const raw = _.get(vars, CHAT_VAR_KEYS.EDEN_SHELTER_UPGRADE, {});\n    return ShelterUpgradeStateSchema.parse(raw);\n  } catch {\n    return ShelterUpgradeStateSchema.parse({});\n  }\n}\n\nfunction patchShelterUpgradeState(patcher: (prev: any) => any) {\n  if (typeof updateVariablesWith !== 'function') return;\n  updateVariablesWith(\n    (vars: any) => {\n      const raw = _.get(vars, CHAT_VAR_KEYS.EDEN_SHELTER_UPGRADE, {});\n      const prev = raw && typeof raw === 'object' && !Array.isArray(raw) ? { ...(raw as any) } : {};\n      const next = patcher(prev) ?? prev;\n      _.set(vars, CHAT_VAR_KEYS.EDEN_SHELTER_UPGRADE, next);\n      return vars;\n    },\n    { type: 'chat' },\n  );\n}\n\nfunction getLastMessageIdSafe(): number | null {\n  try {\n    const id = (globalThis as any).getLastMessageId?.();\n    if (typeof id === 'number' && Number.isFinite(id)) return id;\n    const n = Number(id);\n    return Number.isFinite(n) ? n : null;\n  } catch {\n    return null;\n  }\n}\n\nfunction parseDaysSinceUpgrade(distanceText: any): number {\n  const s = String(distanceText ?? '').trim();\n  const m = s.match(/^(\\d+)\\s*天/);\n  if (!m) return 0;\n  const v = Number(m[1]);\n  return Number.isFinite(v) ? Math.max(0, v) : 0;\n}\n\nfunction formatDistanceText(daysSinceUpgrade: number): string {\n  const days = Math.max(0, Math.floor(daysSinceUpgrade));\n  const remaining = Math.max(0, 7 - days);\n  return `${days}天 | 剩余保底升级天数：${remaining}天`;\n}\n\nfunction formatRollText(roll: number | null, upgraded: boolean, reason?: 'guarantee'): string {\n  if (reason === 'guarantee') return '今日已投掷: 保底升级！';\n  const r = typeof roll === 'number' && Number.isFinite(roll) ? Math.floor(roll) : 0;\n  return `今日已投掷: ${r}点 (${upgraded ? '触发幸运升级！' : '未升级'})`;\n}\n\nfunction parseEdenDateToNumber(dateStr: any): number | null {\n  const s = String(dateStr ?? '').trim();\n  const m = s.match(/(\\d+)年(\\d+)月(\\d+)日/);\n  if (!m) return null;\n  const y = Number(m[1]);\n  const mo = Number(m[2]);\n  const d = Number(m[3]);\n  if (!Number.isFinite(y) || !Number.isFinite(mo) || !Number.isFinite(d)) return null;\n  return y * 10000 + mo * 100 + d;\n}\n\nfunction isDateForward(today: string, last: string): boolean {\n  const t = parseEdenDateToNumber(today);\n  const l = parseEdenDateToNumber(last);\n  if (t == null || l == null) return today !== last;\n  return t > l;\n}\n\nfunction createEventId(prefix: string): string {\n  try {\n    const uuid = (globalThis as any)?.crypto?.randomUUID?.();\n    if (typeof uuid === 'string' && uuid) return `${prefix}_${uuid}`;\n  } catch {\n    // ignore\n  }\n  return `${prefix}_${Date.now()}_${Math.floor(Math.random() * 1e9)}`;\n}\n\nfunction pruneRollHistory(history: Record<string, any>, keep: number): Record<string, any> {\n  const entries = Object.entries(history ?? {});\n  if (entries.length <= keep) return history ?? {};\n\n  const scored = entries.map(([k, v]) => {\n    const n = parseEdenDateToNumber(k);\n    return { k, v, n: n == null ? Number.POSITIVE_INFINITY : n };\n  });\n  scored.sort((a, b) => a.n - b.n);\n\n  const sliced = scored.slice(Math.max(0, scored.length - keep));\n  return sliced.reduce<Record<string, any>>((acc, x) => {\n    acc[x.k] = x.v;\n    return acc;\n  }, {});\n}\n\nfunction parseShelterAbilitiesByLevel(raw: string): Record<number, Ability[]> {\n  const out: Record<number, Ability[]> = {};\n  const parts = String(raw ?? '').split(/###\\s*庇护所等级\\s*(\\d+)\\s*:/g);\n  for (let i = 1; i + 1 < parts.length; i += 2) {\n    const level = Number(parts[i]);\n    const section = String(parts[i + 1] ?? '');\n    if (!Number.isFinite(level)) continue;\n\n    const lines = section.split(/\\r?\\n/);\n    const abilities: Ability[] = [];\n\n    let curName: string | null = null;\n    let curDesc: string[] = [];\n    let inDesc = false;\n\n    const commit = () => {\n      if (!curName) return;\n      const desc = curDesc\n        .map(x => String(x ?? '').trim())\n        .filter(Boolean)\n        .join('\\n')\n        .trim();\n      abilities.push({ name: curName.trim(), desc });\n      curName = null;\n      curDesc = [];\n      inDesc = false;\n    };\n\n    const looksLikeAbilityName = (line: string) => {\n      const t = line.trim();\n      if (!t) return false;\n      // 能力名在蓝图中均以 emoji 开头；描述换行通常以中文开头，避免误判为“新能力”\n      try {\n        if (!/^\\p{Extended_Pictographic}/u.test(t)) return false;\n      } catch {\n        // fallback：不支持 Unicode 属性转义时，退化为“常见图标前缀”判断\n        if (!/^[\\u2600-\\u27BF\\u{1F300}-\\u{1FAFF}]/u.test(t)) return false;\n      }\n      if (t.startsWith('#') || t.startsWith('<')) return false;\n      if (t.startsWith('---')) return false;\n      if (t.startsWith('简介')) return false;\n      if (t.startsWith('-')) return false;\n      return true;\n    };\n\n    for (const lineRaw of lines) {\n      const line = String(lineRaw ?? '').trimEnd();\n      const t = line.trim();\n      if (!t) {\n        if (inDesc) curDesc.push('');\n        continue;\n      }\n      if (t.startsWith('---')) {\n        if (curName) commit();\n        continue;\n      }\n\n      const descMatch = t.match(/^简介[:：]\\s*(.*)$/);\n      if (descMatch && curName) {\n        inDesc = true;\n        curDesc.push(descMatch[1] ?? '');\n        continue;\n      }\n\n      if (looksLikeAbilityName(t)) {\n        if (curName) commit();\n        curName = t;\n        curDesc = [];\n        inDesc = false;\n        continue;\n      }\n\n      if (inDesc && curName) {\n        curDesc.push(t);\n      }\n    }\n    if (curName) commit();\n\n    if (abilities.length > 0) out[level] = abilities;\n  }\n  return out;\n}\n\nconst __shelterAbilitiesByLevel = parseShelterAbilitiesByLevel(shelterBlueprintRaw);\n\nfunction normalizeAbilityName(name: any): string {\n  // 统一“智能引号”等字符，避免同一能力被 AI 写出多个 key（导致误判 NEW / addedAbilities）\n  const s = String(name ?? '').trim();\n  if (!s) return '';\n  return s\n    .replace(/[“”]/g, '\"')\n    .replace(/[‘’]/g, \"'\")\n    .replace(/[（]/g, '(')\n    .replace(/[）]/g, ')')\n    .replace(/\\s+/g, ' ')\n    .trim();\n}\n\nfunction applyShelterUpgradeRewards(\n  stat_data: any,\n  level: number,\n): {\n  addedAbilities: string[];\n  patchedMedicalWing: boolean;\n  patchedVehicleHangar: boolean;\n} {\n  const lv = clampLevel(level);\n\n  const beforeRecord = _.get(stat_data, ['庇护所', '庇护所能力'], {});\n  const beforeKeys = beforeRecord && typeof beforeRecord === 'object' ? Object.keys(beforeRecord as any) : [];\n  const beforeNorm = new Set(beforeKeys.map(k => normalizeAbilityName(k)).filter(Boolean));\n\n  const abilityRecord = _.get(stat_data, ['庇护所', '庇护所能力'], {});\n  if (!abilityRecord || typeof abilityRecord !== 'object') _.set(stat_data, ['庇护所', '庇护所能力'], {});\n\n  // 先把当前能力表去重（按 normalizeAbilityName），合并 desc，避免产生“同能力多个 key”\n  const rawMerged: Record<string, { desc: string }> = { ...(_.get(stat_data, ['庇护所', '庇护所能力']) ?? {}) };\n  const deduped: Record<string, { desc: string }> = {};\n  const normToKey = new Map<string, string>();\n  for (const [k, v] of Object.entries(rawMerged)) {\n    const key = String(k ?? '').trim();\n    if (!key) continue;\n    const norm = normalizeAbilityName(key);\n    if (!norm) continue;\n    const desc = String((v as any)?.desc ?? '').trim();\n    const existKey = normToKey.get(norm);\n    if (!existKey) {\n      normToKey.set(norm, key);\n      deduped[key] = { desc };\n      continue;\n    }\n    const old = String((deduped[existKey] as any)?.desc ?? '').trim();\n    // 优先保留信息量更大的描述，避免丢字；否则保留已有\n    if ((!old && desc) || (desc && desc.length > old.length)) {\n      deduped[existKey] = { desc };\n    }\n  }\n\n  const addedAbilities: string[] = [];\n  const merged: Record<string, { desc: string }> = { ...deduped };\n\n  for (let i = 1; i <= lv; i++) {\n    for (const ab of __shelterAbilitiesByLevel[i] ?? []) {\n      const name = String(ab.name ?? '').trim();\n      const norm = normalizeAbilityName(name);\n      if (!norm) continue;\n\n      const existingKey = normToKey.get(norm);\n      if (!existingKey) {\n        // 不存在：以蓝图名作为 canonical key 插入\n        normToKey.set(norm, name);\n        merged[name] = { desc: ab.desc };\n        if (!beforeNorm.has(norm)) addedAbilities.push(name);\n        continue;\n      }\n\n      // 已存在：仅在 desc 为空时补全，避免覆盖玩家/AI 写的更详细版本\n      const existing = merged[existingKey];\n      const oldDesc = String((existing as any)?.desc ?? '').trim();\n      if (!oldDesc && ab.desc) merged[existingKey] = { desc: ab.desc };\n    }\n  }\n\n  _.set(stat_data, ['庇护所', '庇护所能力'], merged);\n\n  // 可扩展区域：只按“明确等级解锁”的部分做同步，避免覆盖任务解锁逻辑\n  const beforeMed = String(_.get(stat_data, ['庇护所', '可扩展区域', '医疗翼'], '') ?? '');\n  const med = lv >= 9 ? '专家级自动医师' : lv >= 6 ? '外科手术台' : lv >= 3 ? '初级医疗舱' : '未解锁';\n  _.set(stat_data, ['庇护所', '可扩展区域', '医疗翼'], med);\n  const patchedMedicalWing = beforeMed !== med;\n\n  let patchedVehicleHangar = false;\n  if (lv >= 7) {\n    const cur = String(_.get(stat_data, ['庇护所', '可扩展区域', '载具格纳库'], '') ?? '');\n    if (!cur || cur === '未解锁') {\n      _.set(stat_data, ['庇护所', '可扩展区域', '载具格纳库'], '先驱者制造单元');\n      patchedVehicleHangar = true;\n    }\n  }\n\n  return { addedAbilities, patchedMedicalWing, patchedVehicleHangar };\n}\n\ntype ParsedRollText =\n  | { kind: 'guarantee'; roll: null; upgraded: true }\n  | { kind: 'number'; roll: number; upgraded: boolean };\n\nfunction parseRollText(text: any): ParsedRollText | null {\n  const s = String(text ?? '').trim();\n  if (!s) return null;\n  if (s.includes('保底')) return { kind: 'guarantee', roll: null, upgraded: true };\n\n  const m = s.match(/今日已投掷[:：]?\\s*(\\d+)\\s*点/);\n  if (!m) return null;\n  const roll = Number(m[1]);\n  if (!Number.isFinite(roll)) return null;\n  const clamped = _.clamp(Math.floor(roll), 0, 10);\n  const upgraded = clamped === 7 || clamped === 10;\n  return { kind: 'number', roll: clamped, upgraded };\n}\n\nfunction applyShelterDailyRollIfNeeded(new_variables: any, old_variables: any, debugSetting: EdenDebugSetting) {\n  const stat_data = _.get(new_variables, 'stat_data', {}) ?? {};\n  const old_stat_data = _.get(old_variables, 'stat_data', {}) ?? {};\n\n  const today = String(_.get(stat_data, ['世界', '日期'], '') ?? '').trim();\n  if (!today) return;\n  const yesterday = String(_.get(old_stat_data, ['世界', '日期'], '') ?? '').trim();\n\n  const state = readShelterUpgradeState();\n  const history0: Record<string, any> = ((state as any).roll_history as any) ?? {};\n\n  const manualReq = (state as any)?.manual_request ?? null;\n  const manualMessageId = Number((manualReq as any)?.message_id ?? 0);\n  const manualToday = String((manualReq as any)?.today ?? '').trim();\n  const hasManual = Number.isFinite(manualMessageId) && manualMessageId > 0 && (!manualToday || manualToday === today);\n\n  const lastDate = String(state.last_roll_date ?? '').trim();\n  const hasRollValue =\n    Object.prototype.hasOwnProperty.call(state, 'last_roll_value') && (state as any).last_roll_value !== undefined;\n  const alreadyRolledToday = lastDate === today && hasRollValue;\n  const alreadyHasHistoryToday = Object.prototype.hasOwnProperty.call(history0, today);\n\n  const crossedDay = (() => {\n    if (!yesterday) return false;\n    if (yesterday === today) return false;\n    // 如果解析失败，退化为“字符串变化即跨天”，宁可触发一次也不要错过（有 chat 变量幂等兜底）\n    const y = parseEdenDateToNumber(yesterday);\n    const t = parseEdenDateToNumber(today);\n    if (y == null || t == null) return true;\n    return t > y;\n  })();\n\n  // 初次进入：优先用 old date 建档（避免“第一次装脚本刚好跨天但没roll”的体验）\n  if (!lastDate) {\n    const seededDays = parseDaysSinceUpgrade(_.get(stat_data, ['庇护所', '距离上次升级'], ''));\n    const seededRoll = parseRollText(_.get(stat_data, ['庇护所', '今日投掷点数'], ''));\n    const seededMessageId = getLastMessageIdSafe() ?? 0;\n    const seedDate = yesterday && yesterday !== today ? yesterday : today;\n\n    patchShelterUpgradeState(prev => ({\n      ...prev,\n      last_roll_date: seedDate,\n      days_since_upgrade: seededDays,\n      ...(seededRoll\n        ? {\n            last_roll_value: seededRoll.roll,\n            last_roll_upgraded: seededRoll.upgraded,\n            last_roll_reason: seededRoll.kind === 'guarantee' ? 'guarantee' : seededRoll.upgraded ? 'lucky' : 'normal',\n            last_roll_source: 'seed',\n            roll_history: {\n              ...(typeof (prev as any)?.roll_history === 'object' && (prev as any).roll_history\n                ? (prev as any).roll_history\n                : {}),\n              ...(Object.prototype.hasOwnProperty.call(\n                typeof (prev as any)?.roll_history === 'object' && (prev as any).roll_history\n                  ? (prev as any).roll_history\n                  : {},\n                seedDate,\n              )\n                ? {}\n                : {\n                    [seedDate]: {\n                      roll: seededRoll.roll,\n                      upgraded: seededRoll.upgraded,\n                      reason: seededRoll.kind === 'guarantee' ? 'guarantee' : seededRoll.upgraded ? 'lucky' : 'normal',\n                      source: 'seed',\n                      ts: new Date().toISOString(),\n                      message_id: seededMessageId,\n                      trigger: 'seed',\n                    },\n                  }),\n            },\n          }\n        : {}),\n    }));\n\n    edenLog(\n      'info',\n      'daily_roll.seed',\n      { today, yesterday, seedDate, seededDays, hasSeededRoll: !!seededRoll, message_id: seededMessageId },\n      debugSetting,\n    );\n  }\n\n  // 重新读取一次，确保 last_roll_date/天数已就绪（本次事件内写回 chat 变量不会影响 new_variables，但这里用于逻辑判断即可）\n  const nextState = lastDate ? state : readShelterUpgradeState();\n  const history: Record<string, any> = ((nextState as any).roll_history as any) ?? {};\n  const historyEntryToday = Object.prototype.hasOwnProperty.call(history, today) ? history[today] : null;\n  const nextLastDate = String(nextState.last_roll_date ?? '').trim();\n  const nextHasRollValue =\n    Object.prototype.hasOwnProperty.call(nextState, 'last_roll_value') &&\n    (nextState as any).last_roll_value !== undefined;\n  const nextAlreadyRolledToday = nextLastDate === today && nextHasRollValue;\n  const nextAlreadyHasHistoryToday = !!historyEntryToday;\n\n  const needRollByDate = crossedDay && !nextAlreadyHasHistoryToday;\n  const needRollByManual = hasManual && !nextAlreadyHasHistoryToday;\n  const needRoll = needRollByDate || needRollByManual;\n\n  const settleSource = needRollByManual ? 'manual' : 'script';\n  const metaMessageId = (needRollByManual ? manualMessageId : getLastMessageIdSafe()) ?? 0;\n\n  // 若今天已经有 roll_history 记录，则以它为准回写 roll/天数字段，避免 MVU “无更新取旧值”导致 UI 混淆。\n  if (nextAlreadyHasHistoryToday) {\n    const roll = (historyEntryToday as any)?.roll ?? null;\n    const upgraded = (historyEntryToday as any)?.upgraded === true;\n    const reason = String((historyEntryToday as any)?.reason ?? '').trim();\n    const text = formatRollText(roll, upgraded, reason === 'guarantee' ? 'guarantee' : undefined);\n    if (String(_.get(stat_data, ['庇护所', '今日投掷点数'], '') ?? '') !== text) {\n      _.set(stat_data, ['庇护所', '今日投掷点数'], text);\n    }\n\n    const days =\n      Number.isFinite((nextState as any).days_since_upgrade) && (nextState as any).days_since_upgrade >= 0\n        ? Math.floor((nextState as any).days_since_upgrade)\n        : parseDaysSinceUpgrade(_.get(stat_data, ['庇护所', '距离上次升级'], ''));\n    const distText = formatDistanceText(days);\n    if (String(_.get(stat_data, ['庇护所', '距离上次升级'], '') ?? '') !== distText) {\n      _.set(stat_data, ['庇护所', '距离上次升级'], distText);\n    }\n  }\n\n  // 未触发 roll：仅清理 manual_request（避免重复触发）\n  if (!needRoll) {\n    if (crossedDay || hasManual) {\n      console.log(\n        `[DailyRoll] skip ${JSON.stringify({\n          today,\n          yesterday,\n          crossedDay,\n          last_roll_date: nextLastDate,\n          alreadyRolledToday: nextAlreadyRolledToday,\n          alreadyHasHistoryToday: nextAlreadyHasHistoryToday,\n          hasManual,\n          last_roll_source: (nextState as any)?.last_roll_source ?? '',\n        })}`,\n      );\n    }\n    if (hasManual) {\n      patchShelterUpgradeState(prev => {\n        const next = { ...prev };\n        delete (next as any).manual_request;\n        return next;\n      });\n      edenLog('info', 'daily_roll.manual.noop', { today, message_id: metaMessageId }, debugSetting);\n    }\n    return;\n  }\n\n  const baseDays = Number.isFinite(nextState.days_since_upgrade)\n    ? Math.max(0, Math.floor(nextState.days_since_upgrade))\n    : parseDaysSinceUpgrade(_.get(stat_data, ['庇护所', '距离上次升级'], ''));\n\n  const isGuarantee = baseDays >= 7;\n\n  const rollTextNew = _.get(stat_data, ['庇护所', '今日投掷点数'], '');\n  const rollTextOld = _.get(old_stat_data, ['庇护所', '今日投掷点数'], '');\n  const aiTouchedRollTextRaw = !_.isEqual(rollTextNew, rollTextOld) && String(rollTextNew ?? '').trim().length > 0;\n  const aiTouchedRollText = false; // 默认忽略 AI 写入 roll 文本（避免固定点数/刷点）\n  const aiParsed = aiTouchedRollText ? parseRollText(rollTextNew) : null;\n\n  if (aiTouchedRollTextRaw) {\n    edenLog(\n      'warn',\n      'daily_roll.ai_roll_ignored',\n      {\n        today,\n        message_id: metaMessageId,\n        roll_text: String(rollTextNew ?? '').slice(0, 120),\n      },\n      debugSetting,\n    );\n  }\n\n  let roll: number | null = null;\n  let upgraded = false;\n  let reason: 'guarantee' | 'lucky' | 'normal' | 'ai_invalid' = 'normal';\n  let source: 'script' | 'manual' | 'ai' = settleSource;\n\n  if (isGuarantee) {\n    roll = null;\n    upgraded = true;\n    reason = 'guarantee';\n  } else if (aiParsed && aiParsed.kind === 'number') {\n    roll = aiParsed.roll;\n    upgraded = aiParsed.upgraded;\n    reason = upgraded ? 'lucky' : 'normal';\n    source = 'ai';\n  } else {\n    if (aiTouchedRollText && !aiParsed) {\n      reason = 'ai_invalid';\n    }\n    roll = Math.floor(Math.random() * 11);\n    upgraded = roll === 7 || roll === 10;\n    source = settleSource;\n    reason = upgraded ? 'lucky' : reason === 'ai_invalid' ? 'ai_invalid' : 'normal';\n  }\n\n  const oldLevelRaw = _.get(old_stat_data, ['庇护所', '庇护所等级'], 1);\n  const newLevelRaw = _.get(stat_data, ['庇护所', '庇护所等级'], 1);\n  const oldLevel = clampLevel(oldLevelRaw);\n  const newLevel = clampLevel(newLevelRaw);\n  const baselineLevel = Math.max(oldLevel, newLevel);\n\n  if (baselineLevel !== newLevel) {\n    _.set(stat_data, ['庇护所', '庇护所等级'], baselineLevel);\n    edenLog(\n      'warn',\n      'shelter.level.downgrade_corrected',\n      { oldLevel, newLevel, baselineLevel, today, message_id: metaMessageId },\n      debugSetting,\n    );\n  }\n\n  const canLevelUp = baselineLevel < 10;\n  const alreadyLevelUpByAI = newLevel > oldLevel;\n\n  const nextLevel = upgraded && canLevelUp && !alreadyLevelUpByAI ? clampLevel(baselineLevel + 1) : baselineLevel;\n  const nextDays = upgraded ? 0 : baseDays + 1;\n\n  _.set(stat_data, ['庇护所', '今日投掷点数'], formatRollText(roll, upgraded, isGuarantee ? 'guarantee' : undefined));\n  _.set(stat_data, ['庇护所', '距离上次升级'], formatDistanceText(nextDays));\n  _.set(stat_data, ['庇护所', '庇护所等级'], nextLevel);\n\n  const rewardDiff = applyShelterUpgradeRewards(stat_data, nextLevel);\n\n  const didLevelUp = nextLevel > oldLevel;\n  const didAbilityListChange = rewardDiff.addedAbilities.length > 0;\n  const rollEventId = createEventId('roll');\n  const abilityEventId = didAbilityListChange ? createEventId('ability') : '';\n\n  edenLog(\n    'info',\n    'daily_roll.settled',\n    {\n      today,\n      message_id: metaMessageId,\n      trigger: needRollByManual ? 'manual' : 'auto',\n      source,\n      reason,\n      baseDays,\n      nextDays,\n      roll,\n      upgraded,\n      oldLevel,\n      nextLevel,\n      didLevelUp,\n      rewardAddedAbilities: rewardDiff.addedAbilities,\n      rewardPatchedMedicalWing: rewardDiff.patchedMedicalWing,\n      rewardPatchedVehicleHangar: rewardDiff.patchedVehicleHangar,\n    },\n    debugSetting,\n  );\n  console.log(\n    `[DailyRoll] settled ${JSON.stringify({\n      today,\n      yesterday,\n      trigger: needRollByManual ? 'manual' : 'auto',\n      source,\n      reason,\n      roll,\n      upgraded,\n      oldLevel,\n      nextLevel,\n      baseDays,\n      nextDays,\n    })}`,\n  );\n\n  patchShelterUpgradeState(prev => {\n    const next = {\n      ...prev,\n      last_roll_date: today,\n      days_since_upgrade: nextDays,\n      last_roll_value: roll,\n      last_roll_upgraded: upgraded,\n      last_roll_reason: reason,\n      last_roll_source: source,\n      last_roll_event_id: rollEventId,\n      last_roll_settled: true,\n    } as any;\n\n    const prevHistory: Record<string, any> =\n      prev && typeof prev === 'object' && !Array.isArray(prev) && typeof (prev as any).roll_history === 'object'\n        ? ((prev as any).roll_history ?? {})\n        : {};\n    const nextHistory = {\n      ...prevHistory,\n      [today]: {\n        roll,\n        upgraded,\n        reason,\n        source,\n        ts: new Date().toISOString(),\n        event_id: rollEventId,\n        message_id: metaMessageId,\n        trigger: needRollByManual ? 'manual' : 'auto',\n      },\n    };\n    next.roll_history = pruneRollHistory(nextHistory, 120);\n\n    if (didLevelUp) {\n      next.last_level_message_id = metaMessageId;\n      next.last_level_source = source;\n    }\n\n    // 能力列表 NEW：仅在“新增能力条目”时点亮，避免仅修补可扩展区域等也显示 NEW\n    next.last_ability_changed = didAbilityListChange;\n    if (didAbilityListChange) {\n      next.last_ability_message_id = metaMessageId;\n      next.last_ability_source = source;\n      next.last_ability_event_id = abilityEventId;\n      next.last_ability_added_names = rewardDiff.addedAbilities.slice();\n    }\n\n    delete next.manual_request;\n    return next;\n  });\n}\n\nfunction toRoomList(input: any): string[] {\n  if (!Array.isArray(input)) return [];\n  return _(input)\n    .filter((x: any) => typeof x === 'string')\n    .map((x: string) => x.trim())\n    .filter(Boolean)\n    .value();\n}\n\nfunction normalizeScopeDelta(raw: any): ScopeDelta | null {\n  if (!raw || typeof raw !== 'object' || Array.isArray(raw)) return null;\n\n  const addRaw = (raw as any).add ?? null;\n  const removeRaw = (raw as any).remove ?? null;\n\n  const add: ShelterScopeByFloor = {};\n  const remove: ShelterScopeByFloor = {};\n\n  const looksLikeScope =\n    addRaw == null &&\n    removeRaw == null &&\n    (Object.prototype.hasOwnProperty.call(raw, '20') || Object.prototype.hasOwnProperty.call(raw, '19'));\n\n  const srcAdd = looksLikeScope ? raw : addRaw;\n  const srcRemove = looksLikeScope ? null : removeRaw;\n\n  if (srcAdd && typeof srcAdd === 'object' && !Array.isArray(srcAdd)) {\n    for (const floor of ['20', '19']) {\n      const list = toRoomList((srcAdd as any)[floor]);\n      if (list.length) add[floor] = list;\n    }\n  }\n\n  if (srcRemove && typeof srcRemove === 'object' && !Array.isArray(srcRemove)) {\n    for (const floor of ['20', '19']) {\n      const list = toRoomList((srcRemove as any)[floor]);\n      if (list.length) remove[floor] = list;\n    }\n  }\n\n  const note = typeof (raw as any).note === 'string' ? String((raw as any).note) : undefined;\n\n  if (Object.keys(add).length === 0 && Object.keys(remove).length === 0) return null;\n  return {\n    add: Object.keys(add).length ? add : undefined,\n    remove: Object.keys(remove).length ? remove : undefined,\n    note,\n  };\n}\n\nfunction enforceCapacity(list: string[], capacity: number): string[] {\n  if (capacity <= 0) return [];\n  const uniqSorted = _(list)\n    .filter((x: any) => typeof x === 'string' && x.trim().length > 0)\n    .map((x: string) => x.trim())\n    .filter((room: string) => room !== '2001')\n    .uniq()\n    .sortBy()\n    .value();\n  if (uniqSorted.length <= capacity) return uniqSorted;\n  return uniqSorted.slice(0, capacity);\n}\n\nfunction applyScopeDelta(current: ShelterScopeByFloor, delta: ScopeDelta, level: number): ShelterScopeByFloor {\n  const base = normalizeScope(current);\n  const next: ShelterScopeByFloor = { ...base };\n\n  for (const floor of ['20', '19'] as const) {\n    const cap = floorRoomCapacity(level, floor);\n    const cur = Array.isArray(next[floor]) ? next[floor].slice() : [];\n    const set = new Set<string>(cur);\n\n    for (const room of toRoomList(delta.remove?.[floor])) set.delete(room);\n\n    if (cap > 0) {\n      for (const room of toRoomList(delta.add?.[floor])) {\n        if (room === '2001') continue;\n        if (set.has(room)) continue;\n        if (set.size >= cap) break;\n        set.add(room);\n      }\n    }\n\n    const merged = Array.from(set);\n    const capped = enforceCapacity(merged, cap);\n    if (capped.length > 0) next[floor] = capped;\n    else delete next[floor];\n  }\n\n  return normalizeScope(next);\n}\n\ntype RoleLike = {\n  姓名?: string;\n  健康?: number;\n  健康更新原因?: string;\n  健康状况?: string;\n  内心想法?: string;\n  登场状态?: string;\n  关系?: string;\n  关系倾向?: string;\n  秩序刻印?: number;\n  秩序刻印更新原因?: string;\n};\n\ntype RoleTouched = {\n  health: boolean;\n  healthReason: boolean;\n  relation: boolean;\n  relationTendency: boolean;\n  imprint: boolean;\n  imprintReason: boolean;\n  thought: boolean;\n};\n\nfunction parseTimeStrToMinutes(timeStr: string): number | null {\n  const m = (timeStr ?? '').match(/(\\d{1,2}):(\\d{2})/);\n  if (!m) return null;\n  const hour = Number(m[1]);\n  const minute = Number(m[2]);\n  if (!Number.isFinite(hour) || !Number.isFinite(minute)) return null;\n  if (hour < 0 || hour > 23 || minute < 0 || minute > 59) return null;\n  return hour * 60 + minute;\n}\n\nfunction parseDateStr(dateStr: string): { year: number; month: number; day: number } | null {\n  const m = (dateStr ?? '').match(/(\\d{1,4})年(\\d{1,2})月(\\d{1,2})日/);\n  if (!m) return null;\n  const year = Number(m[1]);\n  const month = Number(m[2]);\n  const day = Number(m[3]);\n  if (!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day)) return null;\n  if (month < 1 || month > 12) return null;\n  if (day < 1 || day > 31) return null;\n  return { year, month, day };\n}\n\nfunction formatDateStr(date: Date): string {\n  return `末日纪元，${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;\n}\n\nfunction readDebugFlagsFromChat(): { dateLogic: boolean; offstageHealth: boolean } {\n  const vars = getVariables({ type: 'chat' }) ?? {};\n  const debug = _.get(vars, 'eden.debug', {}) ?? {};\n  return {\n    dateLogic: _.get(debug, 'date_logic', false) === true,\n    offstageHealth: _.get(debug, 'offstage_health', false) === true,\n  };\n}\n\nfunction relationStageFromImprint(mark: number): '无' | '拒绝' | '交易' | '顺从' | '忠诚' | '性奴' {\n  const v = _.clamp(Number(mark) || 0, 0, 100);\n  if (v <= 0) return '无';\n  if (v < 20) return '拒绝';\n  if (v < 40) return '交易';\n  if (v < 60) return '顺从';\n  if (v < 90) return '忠诚';\n  return '性奴';\n}\n\nfunction readHealthRulesFromChat(): HealthRules {\n  const vars = getVariables({ type: 'chat' }) ?? {};\n  const raw = _.get(vars, CHAT_VAR_KEYS.EDEN_RULES_HEALTH, {}) ?? {};\n  const r = raw as Partial<HealthRules>;\n  return {\n    decayPer6h: _.clamp(Number(r.decayPer6h) || 5, 0, 10),\n    recoverPer12h: _.clamp(Number(r.recoverPer12h) || 1, 0, 10),\n    decayMultiplier: _.clamp(Number(r.decayMultiplier) || 1, 0, 10),\n    recoverMultiplier: _.clamp(Number(r.recoverMultiplier) || 1, 0, 10),\n  };\n}\n\nfunction isShelteredForRole(stat_data: any, rolePath: string, scope: ShelterScopeByFloor): boolean {\n  const tag = _.get(stat_data, `${rolePath}.所在房间`, '');\n  const loc = parseRoomTag(tag);\n  if (loc.kind === 'core' || loc.kind === 'entrance') return true;\n  if (loc.kind === 'floor') {\n    if (loc.floor === '20' && loc.roomNumber === '2001') return true;\n    if (loc.floor === '20' || loc.floor === '19') return isRoomSheltered(scope, loc.floor, loc.roomNumber);\n    return false;\n  }\n  return false;\n}\n\nfunction isRoleLike(val: any): val is RoleLike {\n  return val && typeof val === 'object' && '健康' in val && '登场状态' in val;\n}\n\nfunction mergeRoleLike(coreRole: RoleLike, tempRole: RoleLike): RoleLike {\n  const next: any = _.cloneDeep(coreRole);\n  for (const [key, value] of Object.entries(tempRole ?? {})) {\n    const cur = next[key];\n    if (cur === undefined || cur === null) {\n      next[key] = value;\n      continue;\n    }\n    if (typeof cur === 'string' && cur.trim() === '' && typeof value === 'string' && value.trim() !== '') {\n      next[key] = value;\n      continue;\n    }\n    if (Array.isArray(cur) && cur.length === 0 && Array.isArray(value) && value.length > 0) {\n      next[key] = value.slice();\n      continue;\n    }\n  }\n  return next as RoleLike;\n}\n\nfunction mergeTempNpcIntoCore(stat_data: any, debugSetting?: EdenDebugSetting) {\n  const temp = _.get(stat_data, '临时NPC', {});\n  if (!temp || typeof temp !== 'object' || Array.isArray(temp)) return;\n\n  const merged: string[] = [];\n  for (const [name, tempRole] of Object.entries(temp)) {\n    if (typeof name !== 'string' || !name) continue;\n    if (!isRoleLike(tempRole)) continue;\n    const coreRole = _.get(stat_data, name, null);\n    if (!isRoleLike(coreRole)) continue;\n\n    const next = mergeRoleLike(coreRole, tempRole as RoleLike);\n    _.set(stat_data, name, next);\n    _.unset(stat_data, ['临时NPC', name]);\n    merged.push(name);\n  }\n\n  if (merged.length > 0 && debugSetting) {\n    edenLog('info', 'role.merge_temp_into_core', { names: merged }, debugSetting);\n  }\n}\n\nfunction diffRoleTouched(oldRole: RoleLike | null, newRole: RoleLike): RoleTouched {\n  if (!oldRole) {\n    return {\n      health: false,\n      healthReason: false,\n      relation: false,\n      relationTendency: false,\n      imprint: false,\n      imprintReason: false,\n      thought: false,\n    };\n  }\n  return {\n    health: !_.isEqual(oldRole.健康, newRole.健康),\n    healthReason: !_.isEqual(oldRole.健康更新原因, newRole.健康更新原因),\n    relation: !_.isEqual(oldRole.关系, newRole.关系),\n    relationTendency: !_.isEqual(oldRole.关系倾向, newRole.关系倾向),\n    imprint: !_.isEqual(oldRole.秩序刻印, newRole.秩序刻印),\n    imprintReason: !_.isEqual(oldRole.秩序刻印更新原因, newRole.秩序刻印更新原因),\n    thought: !_.isEqual(oldRole.内心想法, newRole.内心想法),\n  };\n}\n\n/**\n * 登场状态清洗（针对“AI忘了把登场拨回离场，且本次没写任何字段”的失效局面）\n *\n * 规则（按用户需求）：\n * - 若 AI 明确改了登场状态（登场/离场），一律信任 AI（不在此处干预）\n * - 仅当：旧值为【登场】、新值仍为【登场】、且整段角色对象完全没变化（AI未写任何字段）\n *   => 视为“忘回拨”，脚本强制改为【离场】以继续走离场健康结算\n */\nfunction sanitizeForgottenOnstageRoles(stat_data: any, old_stat_data: any, debugSetting: EdenDebugSetting) {\n  const { core, tempNpc } = listRoleNames(stat_data);\n  const all = [...core, ...tempNpc];\n\n  const patched: Array<{ name: string; path: string }> = [];\n\n  for (const name of all) {\n    const isTemp = tempNpc.includes(name);\n    const rolePath = isTemp ? `临时NPC.${name}` : name;\n\n    const newRole = _.get(stat_data, rolePath, null);\n    const oldRole = _.get(old_stat_data, rolePath, null);\n    if (!newRole || typeof newRole !== 'object') continue;\n    if (!oldRole || typeof oldRole !== 'object') continue;\n\n    const oldStage = String(_.get(oldRole, '登场状态', '') ?? '').trim();\n    const newStage = String(_.get(newRole, '登场状态', '') ?? '').trim();\n\n    // 只处理“旧登场、且 AI 未改登场状态”的情况\n    if (oldStage !== '登场') continue;\n    if (oldStage !== newStage) continue;\n\n    // 若 AI 写了任何字段（对象有差异），则认为“登场是有意为之”，不处理\n    if (!_.isEqual(oldRole, newRole)) continue;\n\n    _.set(stat_data, `${rolePath}.登场状态`, '离场');\n    patched.push({ name, path: rolePath });\n\n    edenLog(\n      'warn',\n      'stage_sanitize.force_offstage',\n      {\n        zh: `回拨「${name}」的登场状态为「离场」（AI 未改登场状态且本轮无字段更新）`,\n        role: name,\n        rolePath,\n        reason: 'onstage_unchanged_and_no_updates',\n      },\n      debugSetting,\n    );\n  }\n\n  if (patched.length > 0) {\n    edenLog(\n      'info',\n      'stage_sanitize.summary',\n      {\n        zh: `登场状态清洗完成：共回拨 ${patched.length} 名角色为「离场」`,\n        patchedCount: patched.length,\n        patched,\n      },\n      debugSetting,\n    );\n  }\n}\n\n/**\n * 登场状态反向回拨（针对“角色实际有字段更新，但登场状态还停留在离场”的局面）\n *\n * 规则（按用户需求，且尽量保守）：\n * - 若 AI 明确改了登场状态（登场/离场），一律信任 AI（不在此处干预）\n * - 仅当：旧值为【离场】、新值仍为【离场】、且角色对象出现“非健康结算类字段”的更新\n *   => 视为“忘拨回登场”，脚本强制改为【登场】\n *\n * 说明：健康/健康更新原因 可能会被脚本或 AI 用于“离场期间的休整/衰减结算”，不应据此强制登场。\n */\nfunction sanitizeForgottenOffstageRoles(stat_data: any, old_stat_data: any, debugSetting: EdenDebugSetting) {\n  const { core, tempNpc } = listRoleNames(stat_data);\n  const all = [...core, ...tempNpc];\n\n  const patched: Array<{ name: string; path: string; changedKeys: string[]; effectiveChangedKeys: string[] }> = [];\n  const skippedHealthOnly: Array<{ name: string; path: string; changedKeys: string[] }> = [];\n\n  for (const name of all) {\n    const isTemp = tempNpc.includes(name);\n    const rolePath = isTemp ? `临时NPC.${name}` : name;\n\n    const newRole = _.get(stat_data, rolePath, null);\n    const oldRole = _.get(old_stat_data, rolePath, null);\n    if (!newRole || typeof newRole !== 'object') continue;\n    if (!oldRole || typeof oldRole !== 'object') continue;\n\n    const oldStage = String(_.get(oldRole, '登场状态', '') ?? '').trim();\n    const newStage = String(_.get(newRole, '登场状态', '') ?? '').trim();\n\n    // 只处理“旧离场、且 AI 未改登场状态”的情况\n    if (oldStage !== '离场') continue;\n    if (oldStage !== newStage) continue;\n\n    // AI 本轮没有写入任何字段：不回拨\n    if (_.isEqual(oldRole, newRole)) continue;\n\n    const IGNORE_FOR_DIFF = new Set(['登场状态']);\n    // 用户设定：只排除“脚本后台可能更新”的字段（健康与原因）。其他字段若被更新，一律视为“角色实际在场”。\n    const IGNORE_FOR_EFFECTIVE = new Set(['健康', '健康更新原因']);\n\n    const keys = Array.from(new Set([...Object.keys(oldRole), ...Object.keys(newRole)]));\n    const changedKeys = keys.filter(\n      k => !IGNORE_FOR_DIFF.has(k) && !_.isEqual((oldRole as any)?.[k], (newRole as any)?.[k]),\n    );\n    const effectiveChangedKeys = changedKeys.filter(k => !IGNORE_FOR_EFFECTIVE.has(k));\n\n    // 只更新了健康/健康更新原因：不回拨登场（保持离场）。\n    if (effectiveChangedKeys.length === 0) {\n      if (changedKeys.length > 0) skippedHealthOnly.push({ name, path: rolePath, changedKeys: changedKeys.slice() });\n      continue;\n    }\n\n    _.set(stat_data, `${rolePath}.登场状态`, '登场');\n    patched.push({\n      name,\n      path: rolePath,\n      changedKeys: changedKeys.slice(),\n      effectiveChangedKeys: effectiveChangedKeys.slice(),\n    });\n\n    edenLog(\n      'warn',\n      'stage_sanitize.force_onstage',\n      {\n        zh: `回拨「${name}」的登场状态为「登场」（检测到非健康字段更新：${effectiveChangedKeys\n          .slice(0, 8)\n          .join('、')}${effectiveChangedKeys.length > 8 ? ` 等${effectiveChangedKeys.length}项` : ''}）`,\n        role: name,\n        rolePath,\n        reason: 'offstage_unchanged_but_role_updated',\n        changedKeys,\n        effectiveChangedKeys,\n        ignoredKeysForEffective: Array.from(IGNORE_FOR_EFFECTIVE),\n      },\n      debugSetting,\n    );\n  }\n\n  if (patched.length > 0) {\n    edenLog(\n      'info',\n      'stage_sanitize.summary.force_onstage',\n      {\n        zh: `离场状态校准完成：共回拨 ${patched.length} 名角色为「登场」`,\n        patchedCount: patched.length,\n        patched,\n      },\n      debugSetting,\n    );\n  }\n\n  if (skippedHealthOnly.length > 0) {\n    edenLog(\n      'debug',\n      'stage_sanitize.summary.skip_health_only',\n      {\n        zh: `离场状态校准：检测到 ${skippedHealthOnly.length} 名角色仅更新「健康/健康更新原因」，保持「离场」`,\n        skippedCount: skippedHealthOnly.length,\n        skipped: skippedHealthOnly,\n      },\n      debugSetting,\n    );\n  }\n}\n\nfunction applyDerivedHealthStatus(rolePath: string, role: RoleLike, stat_data: any) {\n  const healthRaw = role.健康;\n  const health = typeof healthRaw === 'number' || typeof healthRaw === 'string' ? Number(healthRaw) : NaN;\n  if (!Number.isFinite(health)) return;\n  const status = healthCondition(clampHealth(health));\n  _.set(stat_data, `${rolePath}.健康状况`, status);\n}\n\nfunction applyAutoStageFromThoughtUpdateIfNeeded(\n  roleName: string,\n  oldRole: RoleLike | null,\n  newRole: RoleLike,\n  debug: { offstageHealth: boolean },\n) {\n  const touched = diffRoleTouched(oldRole, newRole);\n  if (!touched.thought) return;\n\n  const tag = _.get(newRole, '登场状态', '');\n  if (tag !== '离场') return;\n\n  if (debug.offstageHealth) {\n    console.log(`[登场状态] 「${roleName}」内心想法已更新，登场状态自动回拨为「登场」`);\n  }\n\n  _.set(newRole, '登场状态', '登场');\n}\n\nfunction applyDeathFromNegativeImprintIfNeeded(\n  rolePath: string,\n  roleName: string,\n  newRole: RoleLike,\n  stat_data: any,\n  debug: { offstageHealth: boolean },\n) {\n  const markRaw = newRole.秩序刻印;\n  if (typeof markRaw !== 'number' && typeof markRaw !== 'string') return;\n  const mark = Number(markRaw);\n  if (!Number.isFinite(mark)) return;\n  if (mark >= 0) return;\n\n  if (debug.offstageHealth) {\n    console.log(`[死亡判定] 「${roleName}」Imp=${mark}（<0），判定精神崩溃自杀：健康清零`);\n  }\n\n  _.set(stat_data, `${rolePath}.健康`, 0);\n  _.set(stat_data, `${rolePath}.健康更新原因`, '死亡（Imp<0 触发精神崩溃自杀）');\n  _.set(stat_data, `${rolePath}.健康状况`, '死亡');\n  // Imp<0 自杀：按规则保留负值，不清零（仅规范化为 number）\n  _.set(stat_data, `${rolePath}.秩序刻印`, mark);\n  _.set(stat_data, `${rolePath}.秩序刻印更新原因`, '');\n  _.set(stat_data, `${rolePath}.登场状态`, '离场');\n  _.set(stat_data, `${rolePath}.衣着`, '');\n  _.set(stat_data, `${rolePath}.舌唇`, '');\n  _.set(stat_data, `${rolePath}.胸乳`, '');\n  _.set(stat_data, `${rolePath}.私穴`, '');\n  _.set(stat_data, `${rolePath}.神态样貌`, '');\n  _.set(stat_data, `${rolePath}.动作姿势`, '');\n  _.set(stat_data, `${rolePath}.内心想法`, '');\n  _.set(stat_data, `${rolePath}.所在房间`, '');\n}\n\nfunction applyDeathFromZeroHealthIfNeeded(\n  rolePath: string,\n  roleName: string,\n  role: RoleLike,\n  stat_data: any,\n  debug: { offstageHealth: boolean },\n) {\n  const healthRaw = role.健康;\n  if (typeof healthRaw !== 'number' && typeof healthRaw !== 'string') return;\n  const health = clampHealth(Number(healthRaw) || 0);\n  if (health > 0) return;\n\n  const reason = String((role as any)?.健康更新原因 ?? '').trim();\n  const markRaw = (role as any)?.秩序刻印;\n  const markNum = typeof markRaw === 'number' || typeof markRaw === 'string' ? Number(markRaw) : NaN;\n  const diedFromNegativeImprint = Number.isFinite(markNum) && markNum < 0;\n\n  _.set(stat_data, `${rolePath}.健康`, 0);\n  _.set(stat_data, `${rolePath}.健康状况`, '死亡');\n  _.set(stat_data, `${rolePath}.登场状态`, '离场');\n  if (!reason) _.set(stat_data, `${rolePath}.健康更新原因`, '死亡（健康归零）');\n\n  // 归档死亡：清空文本类字段；秩序刻印清零（负刻印死亡已在另一条规则内处理）\n  _.set(stat_data, `${rolePath}.衣着`, '');\n  _.set(stat_data, `${rolePath}.舌唇`, '');\n  _.set(stat_data, `${rolePath}.胸乳`, '');\n  _.set(stat_data, `${rolePath}.私穴`, '');\n  _.set(stat_data, `${rolePath}.神态样貌`, '');\n  _.set(stat_data, `${rolePath}.动作姿势`, '');\n  _.set(stat_data, `${rolePath}.内心想法`, '');\n  _.set(stat_data, `${rolePath}.所在房间`, '');\n\n  if (!diedFromNegativeImprint) {\n    _.set(stat_data, `${rolePath}.秩序刻印`, 0);\n    _.set(stat_data, `${rolePath}.秩序刻印更新原因`, '');\n  }\n\n  if (debug.offstageHealth) {\n    console.log(\n      `[死亡判定] 「${roleName}」健康<=0，判定死亡 ${safeStringify({ health, reason, diedFromNegativeImprint })}`,\n    );\n  }\n}\n\nfunction applyOffstageRoleHealthIfNeeded(\n  rolePath: string,\n  roleName: string,\n  oldRole: RoleLike | null,\n  newRole: RoleLike,\n  stat_data: any,\n  deltaHours: number | null,\n  scope: ShelterScopeByFloor,\n  rules: HealthRules,\n  debug: { offstageHealth: boolean },\n) {\n  if (deltaHours === null) return;\n\n  const touched = diffRoleTouched(oldRole, newRole);\n  if (touched.health) return;\n  if (touched.healthReason) {\n    const r = String((newRole as any)?.健康更新原因 ?? '').trim();\n    if (r && r !== '0, 无变化') return;\n  }\n\n  const stage = _.get(newRole, '登场状态', '');\n  const isOffstage = stage === '离场';\n  if (!isOffstage) return;\n\n  const healthRaw = newRole.健康;\n  if (typeof healthRaw !== 'number' && typeof healthRaw !== 'string') return;\n  const currentHealth = clampHealth(Number(healthRaw) || 0);\n  if (currentHealth <= 0) return;\n\n  const sheltered = isShelteredForRole(stat_data, rolePath, scope);\n  const computed = computeOffstageHealthDelta(deltaHours, sheltered, rules);\n  if (!computed.delta) return;\n\n  const nextHealth = clampHealth(currentHealth + computed.delta);\n  const actualDelta = nextHealth - currentHealth;\n  _.set(stat_data, `${rolePath}.健康`, nextHealth);\n\n  const label =\n    computed.reason.split(',').slice(1).join(',').trim() || (sheltered ? '离场受庇护休整' : '离场未受庇护自然衰减');\n  const reasonText = actualDelta ? `${actualDelta > 0 ? `+${actualDelta}` : `${actualDelta}`}, ${label}` : '0, 无变化';\n  _.set(stat_data, `${rolePath}.健康更新原因`, reasonText);\n\n  if (debug.offstageHealth) {\n    console.log(\n      `[离场结算] 「${roleName}」健康 ${currentHealth} -> ${nextHealth}（${reasonText}）${safeStringify({\n        deltaHours,\n        sheltered,\n        rules,\n      })}`,\n    );\n  }\n}\n\nfunction applyDerivedRelationStage(rolePath: string, oldRole: RoleLike | null, newRole: RoleLike, stat_data: any) {\n  const markRaw = newRole.秩序刻印;\n  if (typeof markRaw !== 'number' && typeof markRaw !== 'string') return;\n  const mark = Number(markRaw);\n  const stage = relationStageFromImprint(mark);\n\n  const touched = diffRoleTouched(oldRole, newRole);\n  if (touched.relation) return;\n\n  if (newRole.关系 !== stage) {\n    const oldStage = String((newRole as any)?.关系 ?? '').trim();\n    _.set(stat_data, `${rolePath}.关系`, stage);\n    edenLog('info', 'relation.auto_derived', {\n      zh: `Imp 达到 ${Number.isFinite(mark) ? mark : '?'}，自动调整「${rolePath}」关系为「${stage}」`,\n      rolePath,\n      imp: Number.isFinite(mark) ? mark : null,\n      relationBefore: oldStage,\n      relationAfter: stage,\n    });\n  }\n}\n\nfunction patchDateOnMidnightCrossIfNeeded(new_variables: any, old_variables: any, debug: { dateLogic: boolean }) {\n  const oldTimeStr = _.get(old_variables, 'stat_data.世界.时间', '');\n  const newTimeStr = _.get(new_variables, 'stat_data.世界.时间', '');\n\n  if (oldTimeStr === newTimeStr) {\n    if (debug.dateLogic) console.log('[时间逻辑] 时间未变化：不检查日期');\n    return;\n  }\n\n  const oldMinutes = parseTimeStrToMinutes(oldTimeStr);\n  const newMinutes = parseTimeStrToMinutes(newTimeStr);\n  if (oldMinutes === null || newMinutes === null) return;\n\n  if (oldMinutes <= newMinutes) {\n    if (debug.dateLogic) {\n      console.log(\n        `[时间逻辑] 时间变化但未跨天：${oldTimeStr} -> ${newTimeStr} (oldMin=${oldMinutes}, newMin=${newMinutes})`,\n      );\n    }\n    return;\n  }\n\n  console.log(`[时间逻辑] 检测到跨天：${oldTimeStr} -> ${newTimeStr}`);\n\n  const oldDateStr = _.get(old_variables, 'stat_data.世界.日期', '');\n  const newDateStr = _.get(new_variables, 'stat_data.世界.日期', '');\n  if (oldDateStr !== newDateStr) {\n    if (debug.dateLogic) console.log(`[时间逻辑] AI 已更新日期：${oldDateStr} -> ${newDateStr}`);\n    return;\n  }\n\n  const parsed = parseDateStr(oldDateStr);\n  if (!parsed) {\n    if (debug.dateLogic) console.log(`[时间逻辑] 无法解析日期字符串：${oldDateStr}`);\n    return;\n  }\n\n  const dateObj = new Date(parsed.year, parsed.month - 1, parsed.day);\n  if (Number.isNaN(dateObj.getTime())) {\n    if (debug.dateLogic) console.log(`[时间逻辑] 无法转换为 Date：${oldDateStr}`);\n    return;\n  }\n\n  console.log('[时间逻辑] AI 未更新日期，脚本开始补全日期/天数...');\n  dateObj.setDate(dateObj.getDate() + 1);\n  const patched = formatDateStr(dateObj);\n  _.set(new_variables, 'stat_data.世界.日期', patched);\n\n  const oldDays = _.get(new_variables, 'stat_data.世界.末日天数');\n  if (typeof oldDays === 'number') _.set(new_variables, 'stat_data.世界.末日天数', oldDays + 1);\n  const daysAfter = _.get(new_variables, 'stat_data.世界.末日天数');\n  console.log(`[时间逻辑] 已补全日期：${oldDateStr} -> ${patched}; 天数: ${oldDays} -> ${daysAfter}`);\n}\n\nfunction applyOffstageBundle(new_variables: any, old_variables: any, scope: ShelterScopeByFloor) {\n  const debug = readDebugFlagsFromChat();\n  const oldWorld = _.get(old_variables, 'stat_data.世界', {});\n  const newWorld = _.get(new_variables, 'stat_data.世界', {});\n\n  let deltaHours = diffWorldHours(oldWorld, newWorld);\n  if (deltaHours === null) {\n    // fallback：当日期/时间格式异常导致无法计算时，用 末日天数 的差值近似（避免离场健康“经常不结算”）\n    const oldDays = _.get(oldWorld, '末日天数', null);\n    const newDays = _.get(newWorld, '末日天数', null);\n    if (\n      typeof oldDays === 'number' &&\n      typeof newDays === 'number' &&\n      Number.isFinite(oldDays) &&\n      Number.isFinite(newDays)\n    ) {\n      const dayDelta = Math.floor(newDays) - Math.floor(oldDays);\n      if (dayDelta > 0) deltaHours = dayDelta * 24;\n    }\n  }\n  if (deltaHours === null) {\n    const oldTimeStr = _.get(old_variables, 'stat_data.世界.时间', '');\n    const newTimeStr = _.get(new_variables, 'stat_data.世界.时间', '');\n    if (oldTimeStr !== newTimeStr) {\n      console.log(`[时间逻辑] 无法计算世界时间差(diffWorldHours=null) ${safeStringify({ oldWorld, newWorld })}`);\n    } else if (debug.dateLogic) {\n      console.log(`[时间逻辑] diffWorldHours=null（时间未变化）${safeStringify({ oldWorld, newWorld })}`);\n    }\n  } else if (debug.dateLogic) {\n    console.log(`[时间逻辑] 世界时间差(diffWorldHours)=${deltaHours.toFixed(2)}小时`);\n  }\n\n  const stat_data = _.get(new_variables, 'stat_data', {});\n  const old_stat_data = _.get(old_variables, 'stat_data', {});\n  const rules = readHealthRulesFromChat();\n\n  const reserved = new Set(['世界', '庇护所', '房间', '主线任务', '楼层其他住户', '临时NPC']);\n  for (const [key, val] of Object.entries(stat_data ?? {})) {\n    if (reserved.has(key)) continue;\n    if (typeof key !== 'string' || key.startsWith('_')) continue;\n    if (!isRoleLike(val)) continue;\n\n    const oldRole = _.get(old_stat_data, key, null) as any as RoleLike | null;\n    applyAutoStageFromThoughtUpdateIfNeeded(key, oldRole, val as any, debug);\n    applyDeathFromNegativeImprintIfNeeded(key, key, val as any, stat_data, debug);\n    applyOffstageRoleHealthIfNeeded(key, key, oldRole, val as any, stat_data, deltaHours, scope, rules, debug);\n    applyDeathFromZeroHealthIfNeeded(key, key, val as any, stat_data, debug);\n    applyDerivedHealthStatus(key, val as any, stat_data);\n    applyDerivedRelationStage(key, oldRole, val as any, stat_data);\n  }\n\n  const tempNpc = _.get(stat_data, '临时NPC', {});\n  if (tempNpc && typeof tempNpc === 'object') {\n    for (const [name, val] of Object.entries(tempNpc)) {\n      if (typeof name !== 'string' || !name) continue;\n      if (!isRoleLike(val)) continue;\n\n      const oldRole = _.get(old_stat_data, `临时NPC.${name}`, null) as any as RoleLike | null;\n      applyAutoStageFromThoughtUpdateIfNeeded(name, oldRole, val as any, debug);\n      applyDeathFromNegativeImprintIfNeeded(`临时NPC.${name}`, name, val as any, stat_data, debug);\n      applyOffstageRoleHealthIfNeeded(\n        `临时NPC.${name}`,\n        name,\n        oldRole,\n        val as any,\n        stat_data,\n        deltaHours,\n        scope,\n        rules,\n        debug,\n      );\n      applyDeathFromZeroHealthIfNeeded(`临时NPC.${name}`, name, val as any, stat_data, debug);\n      applyOffstageRoleHealthIfNeeded(\n        `临时NPC.${name}`,\n        name,\n        oldRole,\n        val as any,\n        stat_data,\n        deltaHours,\n        scope,\n        rules,\n        debug,\n      );\n      applyDerivedHealthStatus(`临时NPC.${name}`, val as any, stat_data);\n      applyDerivedRelationStage(`临时NPC.${name}`, oldRole, val as any, stat_data);\n    }\n  }\n}\n\n$(async () => {\n  ensureDebugButtons();\n  await waitGlobalInitialized('Mvu');\n  // 防止“脚本-实时修改/重载”导致重复监听：以顶层 window 为准，仅让最新实例生效。\n  markThisInstanceActive();\n\n  const baseDebug = resolveEdenDebugSetting();\n  notifyEdenHelperLoaded();\n  edenLog(\n    'info',\n    'boot',\n    {\n      zh: `伊甸后台数据辅助已启动 v${EDEN_HELPER_VERSION}（实例 ${EDEN_HELPER_INSTANCE_ID}）`,\n      script: '伊甸后台数据辅助',\n      version: EDEN_HELPER_VERSION,\n      instanceId: EDEN_HELPER_INSTANCE_ID,\n    },\n    baseDebug,\n  );\n\n  // MVU 更新变量时可能会“就地修改”对象，导致 VARIABLE_UPDATE_ENDED 的\n  // variables_before_update 与 variables 共享引用，进而让“本轮是否写入字段”的判定失真。\n  // 因此在 UPDATE_STARTED 时抓取一份深拷贝快照，供本轮 UPDATE_ENDED 使用。\n  let variablesBeforeUpdateSnapshot: any | null = null;\n  eventMakeFirst(Mvu.events.VARIABLE_UPDATE_STARTED, (variables: any) => {\n    if (!isActiveInstance()) return;\n    try {\n      variablesBeforeUpdateSnapshot = _.cloneDeep(variables);\n    } catch {\n      // best-effort: 保底不要影响后续逻辑\n      variablesBeforeUpdateSnapshot = variables;\n    }\n  });\n\n  const first = (new_variables: any, old_variables: any) => {\n    if (!isActiveInstance()) return;\n    const debugSetting = resolveEdenDebugSetting();\n    edenLog('debug', 'mvu.update_ended.first.begin', {}, debugSetting);\n\n    try {\n      const stat_data = _.get(new_variables, 'stat_data', {}) ?? {};\n      const old_vars = variablesBeforeUpdateSnapshot ?? old_variables;\n      const old_stat_data = _.get(old_vars, 'stat_data', {}) ?? {};\n\n      // 若同名角色同时存在于顶层与临时NPC，自动合并并移除临时NPC\n      mergeTempNpcIntoCore(stat_data, debugSetting);\n\n      // 出场状态清洗：尽早处理，避免后续房间逻辑等改动干扰“AI本次是否写入字段”的判定\n      sanitizeForgottenOnstageRoles(stat_data, old_stat_data, debugSetting);\n      sanitizeForgottenOffstageRoles(stat_data, old_stat_data, debugSetting);\n\n      const roomDebug = readRoomDebugFlagFromChat();\n      if (roomDebug) edenLog('debug', 'room_logic.begin', {}, debugSetting);\n      applyRoomConsistency(stat_data, old_stat_data, roomDebug);\n      if (roomDebug) edenLog('debug', 'room_logic.end', {}, debugSetting);\n\n      const debug = readDebugFlagsFromChat();\n      patchDateOnMidnightCrossIfNeeded(new_variables, old_vars, debug);\n    } catch (err) {\n      const reason = err instanceof Error ? err.message : String(err);\n      edenLog('error', 'mvu.update_ended.first.error', { reason }, debugSetting);\n    } finally {\n      edenLog('debug', 'mvu.update_ended.first.end', {}, debugSetting);\n    }\n  };\n\n  const last = (new_variables: any, old_variables: any) => {\n    if (!isActiveInstance()) return;\n    const debugSetting = resolveEdenDebugSetting();\n    edenLog('debug', 'mvu.update_ended.last.begin', {}, debugSetting);\n\n    try {\n      const old_vars = variablesBeforeUpdateSnapshot ?? old_variables;\n      const stat_data = _.get(new_variables, 'stat_data', {}) ?? {};\n\n      // 日更 roll / 升级结算：从 UI 剥离后由脚本统一处理（含手动校准触发）\n      applyShelterDailyRollIfNeeded(new_variables, old_vars, debugSetting);\n      const shelterLevel = clampLevel(_.get(stat_data, ['庇护所', '庇护所等级'], 1));\n\n      const currentScope = readShelterScopeFromChat();\n      const rawDelta = _.get(stat_data, ['庇护所', '庇护范围变更'], null);\n      const delta = normalizeScopeDelta(rawDelta);\n\n      edenLog(\n        'debug',\n        'shelter_scope.input',\n        {\n          shelterLevel,\n          hasDelta: !!delta,\n          deltaNote: delta?.note ?? '',\n          add: delta?.add ?? null,\n          remove: delta?.remove ?? null,\n        },\n        debugSetting,\n      );\n\n      const nextScope = delta ? applyScopeDelta(currentScope, delta, shelterLevel) : currentScope;\n      if (delta) {\n        writeShelterScopeToChat(nextScope);\n        edenLog('info', 'shelter_scope.applied', { scope: nextScope }, debugSetting);\n      }\n\n      _.set(stat_data, ['庇护所', '当前生存庇护范围'], nextScope);\n\n      // 清空触发器（保留字段本身），避免重复执行；并保证 AI 后续可继续 replace 该路径。\n      if (delta) _.set(stat_data, ['庇护所', '庇护范围变更'], {});\n\n      applyOffstageBundle(new_variables, old_vars, nextScope);\n    } catch (err) {\n      const reason = err instanceof Error ? err.message : String(err);\n      edenLog('error', 'mvu.update_ended.last.error', { reason }, debugSetting);\n    } finally {\n      edenLog('debug', 'mvu.update_ended.last.end', {}, debugSetting);\n      variablesBeforeUpdateSnapshot = null;\n    }\n  };\n\n  eventMakeFirst(Mvu.events.VARIABLE_UPDATE_ENDED, first);\n  eventMakeLast(Mvu.events.VARIABLE_UPDATE_ENDED, last);\n});\n"],"names":["z","clampHealth","v","_","clamp","Number","normalizeRoomTag","tag","raw","String","trim","t","replace","startsWith","slice","parseRoomTag","kind","room","m","match","floor","roomNumber","test","outdoor","area","roomTagFromLocation","loc","findRoleLocation","rooms","roleName","name","entranceA","get","Array","isArray","includes","entranceB","purify","bedroom","bathroom","livingRoom","kitchen","floor20","data","Object","entries","residents","floor19","floorRoomCapacity","level","lv","isFinite","normalizeScope","scope","out","filter","x","length","uniq","sortBy","value","parseWorldTime","dateStr","timeStr","day","year","month","d","Date","isNaN","getTime","Math","parseDateToEpochDay","hm","hour","minute","parseTimeToMinutes","epochMinutes","CHAT_VAR_KEYS","EDEN_HELPER_VERSION","EDEN_HELPER_ACTIVE_INSTANCE_KEY","EDEN_HELPER_INSTANCE_ID","now","toString","random","EDEN_HELPER_DEBUG_LOG_PATH","DEBUG_BUTTON_TOGGLE","DEBUG_BUTTON_TOGGLE_CHATLOG","obj","path","keys","split","Boolean","cur","k","safeStringify","maxLen","json","JSON","stringify","_k","resolveEdenDebugSetting","search","URLSearchParams","window","location","has","enabled","toConsole","toChat","vars","getVariables","type","getHostGlobal","top","isActiveInstance","host","id","edenLog","event","payload","debugSetting","debug","zh","payloadForPrint","undefined","record","ts","toISOString","head","tail","console","updateVariablesWith","current","list","push","splice","i","readChatDebugFlag","writeChatDebugFlags","next","eden_helper","set","date_logic","offstage_health","room_logic","to_chat","listRoomTagsFromRooms","tags","readRoomListByTag","listRoleNames","stat_data","reserved","Set","core","tempNpc","temp","readRoleRoomTag","isTempNpc","writeRoleRoomTag","isValidExplicitTag","resolveRoleFinalTagTagOnly","args","oldTag","newTag","finalTag","reason","keepUnknownNames","known","map","writeRoomListByTag","nextRooms","ensureFloorRoomSlot","applyRoomConsistency","old_stat_data","oldRooms","patched","isTemp","log","bootstrapMissingRoleRoomTagsFromRooms","knownNames","allTags","finalTagByName","Map","finalReasonByName","oldTagByName","newTagByName","cloneDeep","base","allKnown","normalized","kept","mismatch","old","final","dup","writeTags","reasons","reduce","acc","r","clampLevel","ShelterUpgradeStateSchema","object","last_roll_date","string","prefault","days_since_upgrade","coerce","number","roll_history","roll","union","null","upgraded","boolean","source","event_id","optional","message_id","trigger","passthrough","last_roll_value","last_roll_upgraded","last_roll_reason","last_roll_source","last_roll_event_id","last_roll_settled","last_level_message_id","last_level_source","last_ability_message_id","last_ability_source","last_ability_changed","last_ability_event_id","last_ability_added_names","array","manual_request","today","readShelterUpgradeState","parse","patchShelterUpgradeState","patcher","prev","getLastMessageIdSafe","globalThis","getLastMessageId","n","parseDaysSinceUpgrade","distanceText","max","formatDistanceText","daysSinceUpgrade","days","formatRollText","parseEdenDateToNumber","y","mo","createEventId","prefix","uuid","crypto","randomUUID","__shelterAbilitiesByLevel","parts","section","lines","abilities","curName","curDesc","inDesc","commit","desc","join","looksLikeAbilityName","line","lineRaw","trimEnd","descMatch","parseShelterAbilitiesByLevel","normalizeAbilityName","s","parseRollText","text","clamped","applyShelterDailyRollIfNeeded","new_variables","old_variables","yesterday","state","history0","manualReq","manualMessageId","manualToday","hasManual","lastDate","crossedDay","prototype","hasOwnProperty","call","seededDays","seededRoll","seededMessageId","seedDate","hasSeededRoll","nextState","history","historyEntryToday","nextLastDate","nextHasRollValue","nextAlreadyRolledToday","nextAlreadyHasHistoryToday","needRollByManual","needRoll","settleSource","metaMessageId","distText","alreadyRolledToday","alreadyHasHistoryToday","baseDays","isGuarantee","rollTextNew","rollTextOld","isEqual","roll_text","oldLevelRaw","newLevelRaw","oldLevel","newLevel","baselineLevel","nextLevel","nextDays","rewardDiff","beforeRecord","beforeKeys","beforeNorm","abilityRecord","rawMerged","deduped","normToKey","key","norm","existKey","addedAbilities","merged","ab","existingKey","existing","beforeMed","med","patchedMedicalWing","patchedVehicleHangar","applyShelterUpgradeRewards","didLevelUp","didAbilityListChange","rollEventId","abilityEventId","rewardAddedAbilities","rewardPatchedMedicalWing","rewardPatchedVehicleHangar","nextHistory","keep","scored","POSITIVE_INFINITY","sort","a","b","pruneRollHistory","toRoomList","input","enforceCapacity","capacity","uniqSorted","parseTimeStrToMinutes","readDebugFlagsFromChat","dateLogic","offstageHealth","isShelteredForRole","rolePath","isRoomSheltered","isRoleLike","val","mergeRoleLike","coreRole","tempRole","diffRoleTouched","oldRole","newRole","health","healthReason","relation","relationTendency","imprint","imprintReason","thought","applyDerivedHealthStatus","role","healthRaw","NaN","status","h","healthCondition","applyAutoStageFromThoughtUpdateIfNeeded","applyDeathFromNegativeImprintIfNeeded","markRaw","mark","applyDeathFromZeroHealthIfNeeded","markNum","diedFromNegativeImprint","applyOffstageRoleHealthIfNeeded","deltaHours","rules","touched","currentHealth","sheltered","computed","dh","delta","decayPer6h","recoverPer12h","decayMultiplier","recoverMultiplier","steps","computeOffstageHealthDelta","nextHealth","actualDelta","label","reasonText","applyDerivedRelationStage","stage","relationStageFromImprint","oldStage","imp","relationBefore","relationAfter","patchDateOnMidnightCrossIfNeeded","oldTimeStr","newTimeStr","oldMinutes","newMinutes","oldDateStr","newDateStr","parsed","parseDateStr","dateObj","setDate","getDate","date","getFullYear","getMonth","oldDays","daysAfter","applyOffstageBundle","oldWorld","newWorld","oldParsed","newParsed","diffMinutes","diffWorldHours","newDays","dayDelta","toFixed","readHealthRulesFromChat","$","async","appendInexistentScriptButtons","getButtonEvent","eventOn","visible","toastr","info","waitGlobalInitialized","version","scriptId","getScriptId","markThisInstanceActive","baseDebug","sessionStorage","getItem","setItem","success","notifyEdenHelperLoaded","script","instanceId","variablesBeforeUpdateSnapshot","eventMakeFirst","Mvu","events","VARIABLE_UPDATE_STARTED","variables","VARIABLE_UPDATE_ENDED","old_vars","unset","names","mergeTempNpcIntoCore","all","newStage","patchedCount","sanitizeForgottenOnstageRoles","skippedHealthOnly","IGNORE_FOR_DIFF","IGNORE_FOR_EFFECTIVE","changedKeys","from","effectiveChangedKeys","ignoredKeysForEffective","skippedCount","skipped","sanitizeForgottenOffstageRoles","roomDebug","readRoomDebugFlagFromChat","err","Error","message","eventMakeLast","shelterLevel","currentScope","readShelterScopeFromChat","addRaw","add","removeRaw","remove","looksLikeScope","srcAdd","srcRemove","note","normalizeScopeDelta","hasDelta","deltaNote","nextScope","cap","delete","size","capped","applyScopeDelta"],"ignoreList":[],"sourceRoot":""}