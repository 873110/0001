function t(t){const n=String(t??'').trim();if(!n)return'';const e=n.replace(/\s+/g,'');return'核心区/餐厅厨房'===e?'核心区/餐厅/厨房':'玄关/隔离区'===e||'玄关/净化区'===e||'玄关/净化隔离区'===e||'玄关/净化/隔离区'===e||'玄关（净化/隔离区）'===e?'玄关/净化/隔离区':e.startsWith('室外/')?`户外/${e.slice(3)}`:'室外'===e?'户外':e}function n(t){return'entrance'===t.kind?'临时客房A'===t.room?'玄关/临时客房A':'临时客房B'===t.room?'玄关/临时客房B':'净化/隔离区'===t.room?'玄关/净化/隔离区':'玄关':'core'===t.kind?'客厅'===t.room?'核心区/客厅':'餐厅/厨房'===t.room?'核心区/餐厅/厨房':'主卧室'===t.room?'核心区/主卧室':'核心区/主浴室':'floor'===t.kind?`楼层${t.floor}/${t.roomNumber}`:'outdoor'===t.kind?t.area?`户外/${t.area}`:'户外':''}function e(t,n){const e=n??'';if(!e)return{kind:'none'};const o=_.get(t,'玄关.临时客房A入住者',[]);if(Array.isArray(o)&&o.includes(e))return{kind:'entrance',room:'临时客房A'};const r=_.get(t,'玄关.临时客房B入住者',[]);if(Array.isArray(r)&&r.includes(e))return{kind:'entrance',room:'临时客房B'};const i=_.get(t,'玄关.净化隔离区入住者',[]);if(Array.isArray(i)&&i.includes(e))return{kind:'entrance',room:'净化/隔离区'};const c=_.get(t,'核心区.主卧室使用者',[]);if(Array.isArray(c)&&c.includes(e))return{kind:'core',room:'主卧室'};const s=_.get(t,'核心区.主浴室使用者',[]);if(Array.isArray(s)&&s.includes(e))return{kind:'core',room:'主浴室'};const f=_.get(t,'核心区.客厅使用者',[]);if(Array.isArray(f)&&f.includes(e))return{kind:'core',room:'客厅'};const u=_.get(t,'核心区.餐厅厨房使用者',[]);if(Array.isArray(u)&&u.includes(e))return{kind:'core',room:'餐厅/厨房'};const a=_.get(t,'楼层房间.楼层20房间',{});if(a&&'object'==typeof a)for(const[t,n]of Object.entries(a)){const o=n?.入住者??[];if(Array.isArray(o)&&o.includes(e))return{kind:'floor',floor:'20',roomNumber:t}}const l=_.get(t,'楼层房间.楼层19房间',{});if(l&&'object'==typeof l)for(const[t,n]of Object.entries(l)){const o=n?.入住者??[];if(Array.isArray(o)&&o.includes(e))return{kind:'floor',floor:'19',roomNumber:t}}return{kind:'none'}}function o(t){const n=['玄关/临时客房A','玄关/临时客房B','核心区/客厅','核心区/餐厅/厨房','核心区/主卧室','核心区/主浴室'],e=_.get(t,'楼层房间.楼层20房间',{});if(e&&'object'==typeof e)for(const t of Object.keys(e)){const e=String(t??'').trim();e&&n.push(`楼层20/${e}`)}const o=_.get(t,'楼层房间.楼层19房间',{});if(o&&'object'==typeof o)for(const t of Object.keys(o)){const e=String(t??'').trim();e&&n.push(`楼层19/${e}`)}return _(n).uniq().value()}function r(n,e){const o=t(e);if('玄关/临时客房A'===o)return _.get(n,'玄关.临时客房A入住者',[]);if('玄关/临时客房B'===o)return _.get(n,'玄关.临时客房B入住者',[]);if('核心区/客厅'===o)return _.get(n,'核心区.客厅使用者',[]);if('核心区/餐厅/厨房'===o)return _.get(n,'核心区.餐厅厨房使用者',[]);if('核心区/主卧室'===o)return _.get(n,'核心区.主卧室使用者',[]);if('核心区/主浴室'===o)return _.get(n,'核心区.主浴室使用者',[]);const r=o.match(/^楼层(20|19)\/(.+)$/);if(r){const t=r[1],e=String(r[2]??'').trim();return e?_.get(n,`楼层房间.楼层${t}房间.${e}.入住者`,[]):[]}return[]}function i(t){return t&&'object'==typeof t&&'健康'in t&&'登场状态'in t}function c(t,n){const e=_.cloneDeep(t);for(const[t,o]of Object.entries(n??{})){const n=e[t];null!=n?'string'!=typeof n||''!==n.trim()||'string'!=typeof o||''===o.trim()?Array.isArray(n)&&0===n.length&&Array.isArray(o)&&o.length>0&&(e[t]=o.slice()):e[t]=o:e[t]=o}return e}function s(t){const n=new Set(['世界','庇护所','房间','主线任务','楼层其他住户','临时NPC']),e=[];for(const[o,r]of Object.entries(t??{}))n.has(o)||'string'==typeof o&&o&&!o.startsWith('_')&&r&&'object'==typeof r&&'登场状态'in r&&'健康'in r&&e.push(o);const o=[],r=_.get(t,'临时NPC',{});if(r&&'object'==typeof r&&!Array.isArray(r))for(const[t,n]of Object.entries(r))'string'==typeof t&&t&&n&&'object'==typeof n&&'登场状态'in n&&'健康'in n&&o.push(t);return{core:e,tempNpc:o}}function f(n,e,o){const r=o?`临时NPC.${e}.所在房间`:`${e}.所在房间`;return t(_.get(n,r,''))}function u(n,e,o,r){const i=o?`临时NPC.${e}.所在房间`:`${e}.所在房间`;_.set(n,i,t(r))}function a(n){if(!n)return!1;const e=function(n){const e=t(n);if(!e)return{kind:'none'};if('玄关/临时客房A'===e)return{kind:'entrance',room:'临时客房A'};if('玄关/临时客房B'===e)return{kind:'entrance',room:'临时客房B'};if('玄关/净化/隔离区'===e)return{kind:'entrance',room:'净化/隔离区'};if('玄关'===e)return{kind:'entrance',room:'玄关'};if('核心区/主卧室'===e)return{kind:'core',room:'主卧室'};if('核心区/主浴室'===e)return{kind:'core',room:'主浴室'};if('核心区/客厅'===e)return{kind:'core',room:'客厅'};if('核心区/餐厅/厨房'===e)return{kind:'core',room:'餐厅/厨房'};const o=e.match(/^楼层(\d+)\/(.+)$/);if(o){const t=String(o[1]??'').trim(),n=String(o[2]??'').trim();if(t&&n&&/^\d{4}$/.test(n))return{kind:'floor',floor:t,roomNumber:n}}const r=e.match(/^户外\/(.+)$/);if(r){const t=String(r[1]??'').trim();return t?{kind:'outdoor',area:t}:{kind:'outdoor',area:''}}return'户外'===e?{kind:'outdoor',area:''}:{kind:'none'}}(n);return'none'!==e.kind}function l(n){const e=t(n.oldTag),o=t(n.newTag);return a(o)?{finalTag:o,reason:'explicit'}:''===o?a(e)?{finalTag:'',reason:'explicit-none'}:{finalTag:'',reason:'none'}:a(e)?{finalTag:e,reason:'invalid-keep-old'}:{finalTag:'',reason:'invalid-to-none'}}function g(t,n){return Array.isArray(t)?_(t).filter(t=>'string'==typeof t).map(t=>t.trim()).filter(t=>t.length>0&&!n.has(t)).value():[]}function d(n,e,o){const r=t(e);if('玄关/临时客房A'===r)return void _.set(n,'玄关.临时客房A入住者',o);if('玄关/临时客房B'===r)return void _.set(n,'玄关.临时客房B入住者',o);if('核心区/客厅'===r)return void _.set(n,'核心区.客厅使用者',o);if('核心区/餐厅/厨房'===r)return void _.set(n,'核心区.餐厅厨房使用者',o);if('核心区/主卧室'===r)return void _.set(n,'核心区.主卧室使用者',o);if('核心区/主浴室'===r)return void _.set(n,'核心区.主浴室使用者',o);const i=r.match(/^楼层(20|19)\/(.+)$/);if(!i)return;const c=i[1],s=String(i[2]??'').trim();s&&(!function(t,n,e){const o=`楼层房间.楼层${n}房间.${e}`,r=_.get(t,o,null);r&&'object'==typeof r||_.set(t,o,{入住者:[]});const i=_.get(t,`${o}.入住者`,null);Array.isArray(i)||_.set(t,`${o}.入住者`,[])}(n,c,s),_.set(n,`楼层房间.楼层${c}房间.${s}.入住者`,o))}function m(t,a,m){!function(t){const n=_.get(t,'临时NPC',{});if(n&&'object'==typeof n&&!Array.isArray(n))for(const[e,o]of Object.entries(n)){if('string'!=typeof e||!e)continue;if(!i(o))continue;const n=_.get(t,e,null);if(!i(n))continue;const r=c(n,o);_.set(t,e,r),_.unset(t,['临时NPC',e])}}(t);const y=_.get(t,'房间',{})??{},p=_.get(a,'房间',{})??{};!function(t,o){const r=_.get(t,'房间',{})??{},{core:i,tempNpc:c}=s(t),a=[];for(const o of[...i,...c]){const i=c.includes(o);if(f(t,o,i))continue;const s=n(e(r,o));s&&(u(t,o,i,s),a.push({name:o,tag:s}))}o&&a.length>0&&console.log('[RoomLogic] bootstrapped missing role tags from rooms:',a)}(t,m);const{core:A,tempNpc:k}=s(t),b=new Set([...A,...k]),h=_([...o(p),...o(y)]).uniq().value(),j=new Map,v=new Map,N=new Map,T=new Map;for(const n of[...A,...k]){const e=k.includes(n),o=f(a,n,e),r=f(t,n,e);N.set(n,o),T.set(n,r);const i=l({oldTag:o,newTag:r});j.set(n,i.finalTag),v.set(n,i.reason)}for(const n of[...A,...k]){u(t,n,k.includes(n),j.get(n)??'')}const w=_.cloneDeep(y??{}),B={},S={};for(const t of h){const n=r(y,t);B[t]=g(n,b),S[t]=Array.isArray(n)?n.filter(t=>'string'==typeof t&&b.has(t)):[];const e=g(r(p,t),b).filter(t=>'{{user}}'===t||/^\{\{.+\}\}$/.test(t));if(e.length>0){const n=_(B[t]).concat(e).uniq().value();B[t]=n}}const O={};for(const[t,n]of j.entries()){if(!n)continue;const e='玄关'===n?'玄关/临时客房A':n;O[e]||(O[e]=[]),O[e].push(t)}const M=_([...h,...Object.keys(O)]).uniq().value();for(const t of M){const n=O[t]??[],e=(S[t]??[]).filter(t=>n.includes(t)),o=n.filter(t=>!e.includes(t)).sort(),r=[...B[t]??[],...e,...o];d(w,t,_(r).uniq().value())}if(_.set(t,'房间',w),m){const t=[...v.entries()].filter(([,t])=>'explicit-none'===t).map(([t])=>({name:t,oldTag:N.get(t)??'',newTag:T.get(t)??'',finalTag:j.get(t)??''}));t.length>0&&console.log('[RoomLogic] explicit-none applied (role left to unknown):',t);const n=[];for(const t of[...A,...k]){const e=M.filter(n=>(r(w,n)??[]).includes(t));e.length>1&&n.push({name:t,tags:e})}n.length>0&&console.log('[RoomLogic] still duplicated after reconcile:',n);const e=[...v.entries()].reduce((t,[,n])=>(t[n]=(t[n]??0)+1,t),{});console.log('[RoomLogic] reconcile summary:',e)}}$(async()=>{await waitGlobalInitialized('Mvu');eventMakeFirst(Mvu.events.VARIABLE_UPDATE_ENDED,(t,n)=>{m(_.get(t,'stat_data',{})??{},_.get(n,'stat_data',{})??{},function(){const t=getVariables({type:'chat'})??{},n=_.get(t,'eden.debug',{})??{};return!0===_.get(n,'room_logic',!1)}())})});
//# sourceMappingURL=index.js.map