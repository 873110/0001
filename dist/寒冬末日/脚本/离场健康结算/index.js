function t(t,e){const n=function(t){const e=(t??'').match(/(\d{1,4})年(\d{1,2})月(\d{1,2})日/);if(!e)return null;const n=Number(e[1]),o=Number(e[2]),r=Number(e[3]);if(!Number.isFinite(n)||!Number.isFinite(o)||!Number.isFinite(r))return null;const i=new Date(n,o-1,r);return Number.isNaN(i.getTime())?null:Math.floor(i.getTime()/864e5)}(t),o=function(t){const e=(t??'').match(/(\d{1,2}):(\d{2})/);if(!e)return null;const n=Number(e[1]),o=Number(e[2]);return Number.isFinite(n)&&Number.isFinite(o)?n<0||n>23||o<0||o>59?null:{hour:n,minute:o}:null}(e);if(null===n||null===o)return null;return{epochMinutes:1440*n+60*o.hour+o.minute,hour:o.hour,minute:o.minute}}function e(t){const e=function(t){const e=String(t??'').trim();if(!e)return'';const n=e.replace(/\s+/g,'');return'核心区/餐厅厨房'===n?'核心区/餐厅/厨房':'玄关/隔离区'===n||'玄关/净化区'===n||'玄关/净化隔离区'===n||'玄关/净化/隔离区'===n||'玄关（净化/隔离区）'===n?'玄关/净化/隔离区':n.startsWith('室外/')?`户外/${n.slice(3)}`:'室外'===n?'户外':n}(t);if(!e)return{kind:'none'};if('玄关/临时客房A'===e)return{kind:'entrance',room:'临时客房A'};if('玄关/临时客房B'===e)return{kind:'entrance',room:'临时客房B'};if('玄关/净化/隔离区'===e)return{kind:'entrance',room:'净化/隔离区'};if('玄关'===e)return{kind:'entrance',room:'玄关'};if('核心区/主卧室'===e)return{kind:'core',room:'主卧室'};if('核心区/主浴室'===e)return{kind:'core',room:'主浴室'};if('核心区/客厅'===e)return{kind:'core',room:'客厅'};if('核心区/餐厅/厨房'===e)return{kind:'core',room:'餐厅/厨房'};const n=e.match(/^楼层(\d+)\/(.+)$/);if(n){const t=String(n[1]??'').trim(),e=String(n[2]??'').trim();if(t&&e&&/^\d{4}$/.test(e))return{kind:'floor',floor:t,roomNumber:e}}const o=e.match(/^户外\/(.+)$/);if(o){const t=String(o[1]??'').trim();return t?{kind:'outdoor',area:t}:{kind:'outdoor',area:''}}return'户外'===e?{kind:'outdoor',area:''}:{kind:'none'}}function n(t){return _.clamp(Number(t)||0,0,100)}function o(t){const e=(t??'').match(/(\d{1,2}):(\d{2})/);if(!e)return null;const n=Number(e[1]),o=Number(e[2]);return Number.isFinite(n)&&Number.isFinite(o)?n<0||n>23||o<0||o>59?null:60*n+o:null}function r(){const t=getVariables({type:'chat'})??{},e=_.get(t,'eden.shelter_scope',{});return e&&'object'==typeof e?function(t){const e={};for(const[n,o]of Object.entries(t??{}))Array.isArray(o)&&(e[n]=_(o).filter(t=>'string'==typeof t&&t.trim().length>0).filter(t=>!('20'===n&&'2001'===t)).uniq().sortBy().value());return e}(e):{}}function i(t,n,o){const r=e(_.get(t,`${n}.所在房间`,''));return'core'===r.kind||'entrance'===r.kind||'floor'===r.kind&&('20'===r.floor&&'2001'===r.roomNumber||('20'===r.floor||'19'===r.floor)&&function(t,e,n){const o=t?.[e]??[];return!!Array.isArray(o)&&o.includes(n)}(o,r.floor,r.roomNumber))}function a(t){return t&&'object'==typeof t&&'健康'in t&&'登场状态'in t}function s(t,e){const n=_.cloneDeep(t);for(const[t,o]of Object.entries(e??{})){const e=n[t];null!=e?'string'!=typeof e||''!==e.trim()||'string'!=typeof o||''===o.trim()?Array.isArray(e)&&0===e.length&&Array.isArray(o)&&o.length>0&&(n[t]=o.slice()):n[t]=o:n[t]=o}return n}function u(t,e){return t?{health:!_.isEqual(t.健康,e.健康),healthReason:!_.isEqual(t.健康更新原因,e.健康更新原因),relation:!_.isEqual(t.关系,e.关系),relationTendency:!_.isEqual(t.关系倾向,e.关系倾向),imprint:!_.isEqual(t.秩序刻印,e.秩序刻印),imprintReason:!_.isEqual(t.秩序刻印更新原因,e.秩序刻印更新原因),thought:!_.isEqual(t.内心想法,e.内心想法)}:{health:!1,healthReason:!1,relation:!1,relationTendency:!1,imprint:!1,imprintReason:!1,thought:!1}}function c(t,e,n,o,r){if(!n)return;if('离场'!==n.登场状态)return;if('离场'!==o.登场状态)return;if(!u(n,o).thought)return;String(o.内心想法??'').trim()&&(_.set(o,'登场状态','登场'),r?.offstageHealth&&console.log(`[OffstageHealth] auto-stage from thought update: ${t} (${e})`))}function l(t,e,o,r,a,s,c,l,f){if('离场'!==r.登场状态)return;if(!o)return;if(null===s)return;const d=u(o,r);if(d.health||d.healthReason)return void(f?.offstageHealth&&console.log(`[OffstageHealth] skip(${e}): touched by AI (health=${d.health}, reason=${d.healthReason})`));const g=n(Number(r.健康)||0),m=i(a,t,c),h=function(t,e,n){const o=Number(t);if(!Number.isFinite(o)||o<=0)return{delta:0,reason:'0, 无变化'};const r=Math.max(0,Number(n.decayPer6h)||0),i=Math.max(0,Number(n.recoverPer12h)||0),a=Math.max(0,Number(n.decayMultiplier)||0),s=Math.max(0,Number(n.recoverMultiplier)||0);if(e){const t=Math.floor(o/12),e=Math.floor(t*i*s);return e?{delta:e,reason:`+${e}, 离场受庇护休整`}:{delta:0,reason:'0, 无变化'}}const u=Math.floor(o/6),c=-Math.floor(u*r*a);return c?{delta:c,reason:`${c}, 离场未受庇护自然衰减`}:{delta:0,reason:'0, 无变化'}}(s,m,l);if(!h.delta)return void(f?.offstageHealth&&console.log(`[OffstageHealth] no-op(${e}): dh=${s.toFixed(2)}, sheltered=${m}`));const b=n(g+h.delta),N=b-g,p=h.reason.split(',').slice(1).join(',').trim()||(m?'离场受庇护休整':'离场未受庇护自然衰减'),y=N?`${N>0?`+${N}`:`${N}`}, ${p}`:'0, 无变化';_.set(a,`${t}.健康`,b),_.set(a,`${t}.健康更新原因`,y),console.log(`[离场健康结算] ${e}: ${g} → ${b} (${y})`)}function f(t,e,o,r,i){const a=o.秩序刻印;if('number'!=typeof a&&'string'!=typeof a)return!1;const s=Number(a);if(!Number.isFinite(s)||s>=0)return!1;const u=n(Number(o.健康)||0);if(u<=0)return!1;const c=-u+', 羞愧而死';return _.set(r,`${t}.健康`,0),_.set(r,`${t}.健康更新原因`,c),_.set(r,`${t}.登场状态`,'离场'),console.log(`[角色死亡] ${e}: Imp=${s} -> 健康 ${u} → 0 (${c})`),i?.offstageHealth&&console.log(`[OffstageHealth] applied death rule: ${t} (${e})`),!0}function d(t,e,o){const r=function(t){const e=n(t);return e<=0?'死亡':e<30?'重病/濒死':e<60?'生病/受伤':e<80?'亚健康':'健康'}(n(Number(e.健康)||0));e.健康状况!==r&&_.set(o,`${t}.健康状况`,r)}function g(t,e,n,o){const r=n.秩序刻印;if('number'!=typeof r&&'string'!=typeof r)return;const i=function(t){const e=_.clamp(Number(t)||0,0,100);return e<=0?'无':e<20?'拒绝':e<40?'交易':e<60?'顺从':e<90?'忠诚':'性奴'}(Number(r));u(e,n).relation||n.关系!==i&&_.set(o,`${t}.关系`,i)}$(async()=>{await waitGlobalInitialized('Mvu'),eventOn(Mvu.events.VARIABLE_UPDATE_ENDED,(e,n)=>{const i=function(){const t=getVariables({type:'chat'})??{},e=_.get(t,'eden.debug',{})??{};return{dateLogic:!0===_.get(e,'date_logic',!1),offstageHealth:!0===_.get(e,'offstage_health',!1)}}(),u=_.get(n,'stat_data.世界',{});{const t=_.get(n,'stat_data.世界.时间',''),r=_.get(e,'stat_data.世界.时间','');if(t!==r){const a=o(t),s=o(r);if(null!==a&&null!==s&&a>s){console.log(`[DateLogic] Detected midnight crossing: ${t} -> ${r}`);const o=_.get(n,'stat_data.世界.日期',''),a=_.get(e,'stat_data.世界.日期','');if(o===a){console.log('[DateLogic] AI did not update date, patching date/day...');const t=function(t){const e=(t??'').match(/(\d{1,4})年(\d{1,2})月(\d{1,2})日/);if(!e)return null;const n=Number(e[1]),o=Number(e[2]),r=Number(e[3]);return Number.isFinite(n)&&Number.isFinite(o)&&Number.isFinite(r)?{year:n,month:o,day:r}:null}(o);if(t){const n=new Date(t.year,t.month-1,t.day);if(Number.isNaN(n.getTime()))i.dateLogic&&console.log(`[DateLogic] cannot parse date to Date(): ${o}`);else{n.setDate(n.getDate()+1);const t=`末日纪元，${(m=n).getFullYear()}年${m.getMonth()+1}月${m.getDate()}日`;_.set(e,'stat_data.世界.日期',t);const r=_.get(e,'stat_data.世界.末日天数');'number'==typeof r&&_.set(e,'stat_data.世界.末日天数',r+1);const i=_.get(e,'stat_data.世界.末日天数');console.log(`[DateLogic] patched date: ${o} -> ${t}; days: ${r} -> ${i}`)}}else i.dateLogic&&console.log(`[DateLogic] cannot parse date string: ${o}`)}else i.dateLogic&&console.log(`[DateLogic] date already updated by AI: ${o} -> ${a}`)}else i.dateLogic&&console.log(`[DateLogic] time changed but not crossing: ${t} -> ${r} (oldMin=${a}, newMin=${s})`)}else i.dateLogic&&console.log('[DateLogic] time unchanged; no date check.')}var m;const h=_.get(e,'stat_data.世界',{}),b=function(e,n){const o=t(e.日期??'',e.时间??''),r=t(n.日期??'',n.时间??'');if(!o||!r)return null;const i=r.epochMinutes-o.epochMinutes;return Number.isFinite(i)?i<=0?null:i/60:null}(u,h);if(null===b){_.get(n,'stat_data.世界.时间','')!==_.get(e,'stat_data.世界.时间','')?console.log('[DateLogic] diffWorldHours=null',{oldWorld:u,newWorld:h}):i.dateLogic&&console.log('[DateLogic] diffWorldHours=null (time unchanged)',{oldWorld:u,newWorld:h})}else i.dateLogic&&console.log(`[DateLogic] diffWorldHours=${b.toFixed(2)}`);const N=_.get(e,'stat_data',{}),p=_.get(n,'stat_data',{});!function(t){const e=_.get(t,'临时NPC',{});if(e&&'object'==typeof e&&!Array.isArray(e))for(const[n,o]of Object.entries(e)){if('string'!=typeof n||!n)continue;if(!a(o))continue;const e=_.get(t,n,null);if(!a(e))continue;const r=s(e,o);_.set(t,n,r),_.unset(t,['临时NPC',n])}}(N);const y=r(),M=function(){const t=getVariables({type:'chat'})??{},e=_.get(t,'eden.rules.health',{})??{};return{decayPer6h:_.clamp(Number(e.decayPer6h)||5,0,10),recoverPer12h:_.clamp(Number(e.recoverPer12h)||1,0,10),decayMultiplier:_.clamp(Number(e.decayMultiplier)||1,0,10),recoverMultiplier:_.clamp(Number(e.recoverMultiplier)||1,0,10)}}(),D=new Set(['世界','庇护所','房间','主线任务','楼层其他住户','临时NPC']);for(const[t,e]of Object.entries(N??{})){if(D.has(t))continue;if('string'!=typeof t||t.startsWith('_'))continue;if(!a(e))continue;const n=_.get(p,t,null);c(t,t,n,e,i),f(t,t,e,N,i),l(t,t,n,e,N,b,y,M,i),d(t,e,N),g(t,n,e,N)}const L=_.get(N,'临时NPC',{});if(L&&'object'==typeof L)for(const[t,e]of Object.entries(L)){if('string'!=typeof t||!t)continue;if(!a(e))continue;const n=_.get(p,`临时NPC.${t}`,null);c(`临时NPC.${t}`,t,n,e,i),f(`临时NPC.${t}`,t,e,N,i),l(`临时NPC.${t}`,t,n,e,N,b,y,M,i),d(`临时NPC.${t}`,e,N),g(`临时NPC.${t}`,n,e,N)}})});
//# sourceMappingURL=index.js.map