// Auto-generated by scripts/postbuild-generate-loaders.mjs
// Loads the sibling index.html, injects its styles, and re-executes its scripts.

const __th_loaded = (globalThis.__tavern_helper_inline_loaders__ ??= new Set());
const __th_key = import.meta.url;
if (__th_loaded.has(__th_key)) {
  // Prevent double-mount if the user pastes the loader twice.
  return;
}
__th_loaded.add(__th_key);

const indexUrl = new URL('./index.html', import.meta.url);

(async () => {
  const res = await fetch(indexUrl);
  if (!res.ok) {
    const preview = await res.text().catch(() => '');
    throw new Error(`Failed to fetch ${indexUrl} (${res.status} ${res.statusText})\n${preview.slice(0, 200)}`);
  }
  const html = await res.text();
  const doc = new DOMParser().parseFromString(html, 'text/html');

  const resolveAssetUrl = (raw) => {
    const v = String(raw ?? '').trim();
    if (!v) return '';
    try {
      return new URL(v, indexUrl).toString();
    } catch {
      return v;
    }
  };

  // Inject styles into the real <head>.
  doc.querySelectorAll('head > style').forEach(node => {
    document.head.appendChild(node);
  });
  doc.querySelectorAll('head > link[rel="stylesheet"]').forEach(node => {
    const href = resolveAssetUrl(node.getAttribute('href'));
    if (!href) return;
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = href;
    if (node.hasAttribute('media')) link.media = node.getAttribute('media') ?? '';
    if (node.hasAttribute('crossorigin')) link.setAttribute('crossorigin', node.getAttribute('crossorigin') ?? '');
    if (node.hasAttribute('integrity')) link.setAttribute('integrity', node.getAttribute('integrity') ?? '');
    if (node.hasAttribute('referrerpolicy')) link.setAttribute('referrerpolicy', node.getAttribute('referrerpolicy') ?? '');
    document.head.appendChild(link);
  });

  // Inject body content (excluding scripts; we recreate them to guarantee execution).
  const scripts = Array.from(doc.body.querySelectorAll('script'));
  for (const s of scripts) s.remove();
  document.body.append(...doc.body.childNodes);

  // Re-run scripts in original order.
  for (const src of scripts) {
    const type = (src.getAttribute('type') ?? '').trim().toLowerCase();

    // Keep injected data container (and any other text/plain scripts) inert.
    if (type === 'text/plain') {
      document.body.appendChild(src);
      continue;
    }

    const s = document.createElement('script');
    if (src.hasAttribute('type')) s.setAttribute('type', src.getAttribute('type'));
    if (src.hasAttribute('nomodule')) s.setAttribute('nomodule', '');
    if (src.hasAttribute('async')) s.setAttribute('async', '');
    if (src.hasAttribute('defer')) s.setAttribute('defer', '');
    if (src.id) s.id = src.id;

    const srcAttr = src.getAttribute('src');
    if (srcAttr) s.src = resolveAssetUrl(srcAttr);
    else s.textContent = src.textContent;

    document.body.appendChild(s);
  }
})().catch(err => console.error('[tavern_helper_template loader] Failed:', err));
