变量更新规则:
  世界:
    时间:
      type: string
      check: "计算剧情流逝后的时间点，严格保持 '时间段 - HH:MM' 格式。"
    日期:
      type: string
      check: "日期变更时，使用 `replace` 更新为新的日期字符串（格式：末日纪元，XXXX年XX月XX日）。若你漏更但时间跨过 00:00，系统会尝试自动修正。"
    末日天数:
      type: number
      check: "日期变更时，使用 `delta: 1` 进行累加。若你漏更但时间跨过 00:00，系统会尝试自动修正。"
    地址:
      type: string
      check: "仅当物理位置发生迁移时使用 `replace` 更新。"
  庇护所:
    今日投掷点数:
      type: string
      check:
        - "由脚本维护，AI 无需处理/禁止修改"
        - "字段内容为“展示用文本”，示例：今日已投掷: 3点 (未升级) / 今日已投掷: 7点 (触发幸运升级！) / 今日已投掷: 保底升级！"
    庇护所等级:
      type: number
      range: [1, 10]
      check:
        - 如果有任务奖励要求强制升级，使用 `replace` 覆盖至目标等级。并在正文中向<user>播报新等级与新增权柄描述。还需要联动调整【庇护所能力】
        - 等级升降由脚本维护，每次对话校验相比上次聊天是否发生等级变化，如果升级在正文中提醒<user>。
    距离上次升级:
      type: string
      check: 由脚本维护AI无需处理
    庇护所能力:
      type: "record<string, { desc: string }>"
      check: |-
        - 触发机制：主线阶段达成、完成特定【情报碎片】。
        - 操作：使用 `insert` 添加新能力项。
        - 措辞对齐：奖励描述<庇护所升级能力列表>中的标准文本。
        - 除此以外不可擅自新增庇护所能力
    可扩展区域:
      type: "{ 医疗翼: string, 制造工坊: string, 载具格纳库: string }"
      check: "随等级提升，由脚本维护AI无需处理"
    当前生存庇护范围:
      type: 'record<"20"|"19", string[]>'
      check: "脚本回写镜像（最终生效结果）。AI 只读，禁止修改。"
    庇护范围变更:
      type: '{ add?: record<"20"|"19", string[]>, remove?: record<"20"|"19", string[]>, note?: string }'
      check: |-
        - 这是【生存庇护范围】的“写入入口”（delta）：AI 只能写这里，脚本会校验/去重/卡上限后写入 chat 变量 `eden.shelter_scope`，并驱动 UI 房间变金黄与 0/3 等计数变化。
        - 操作：使用 `replace` 更新 `/stat_data/庇护所/庇护范围变更`，value 格式：
            { "add": { "20": ["2002","2006"], "19": ["1902"] }, "remove": { "20": ["2007"], "19": [] }, "note": "可选备注" }
        - 规则：
            - 仅支持楼层 "20"/"19"；房号必须是字符串数组。
            - "2001" 为庇护所本体，默认受庇护；写入会被忽略/剔除。
            - 上限由庇护所等级决定（脚本会自动丢弃超额房间）。
        - 禁止：直接修改 `/stat_data/房间/**` 来表达庇护效果（房间数组为派生数据）。
  ${角色}:
    check: |-
      - 主要角色名单不固定：凡是 `stat_data` 顶层的角色对象（排除保留键与 `临时NPC`）一律视为主要角色。
      - 临时NPC仍存放于 `临时NPC`，用于短期/路人角色。
      - 允许临时NPC转正为主要角色：将其对象移动到顶层，并从 `临时NPC` 中删除。
      - 若同名角色同时存在于顶层与 `临时NPC`：脚本会自动合并并删除 `临时NPC`。
      - 检查所有登场角色和临时NPC的以下字段更新：
    关系:
      type: 无|拒绝|交易|顺从|忠诚|性奴
      check: |-
        - **初始赋值**：关系只能从「无/拒绝」开始（拒绝及以下）。
        - **关系档位判定**：关系由脚本按秩序刻印（Imp）阈值自动重算：Imp 0→无；Imp 1-19→拒绝；Imp 20-39→交易；Imp 40-59→顺从；Imp 60-89→忠诚；Imp 90-100→性奴。
        - **禁止越级/跨档**：除非完成明确的**任务奖励**，否则禁止跨等级突破（例如：拒绝→忠诚）；不要用 `replace` 强行越级改档。
        - **行为约束-拒绝**：绝对拒绝性交；任何性暗示都会降低 Imp；拒绝带附加条件的援助。
        - **行为约束-交易**：可进行明码标价的性交易（性行为被视为商品、无感情色彩）；拒绝“开头支票”式的性交。
        - **行为约束-顺从**：可无条件性交；将满足性欲视为“工作/义务”以换取安稳生活；拒绝多P、公开场合性交、性虐待。
        - **行为约束-忠诚**：主动寻求并享受性爱；性行为升华为情感交流方式；拒绝性虐待。
        - **行为约束-性奴**：终极共生契约，身心所有权完全移交；将性行为视为确认归属权的“宗教仪式”；无权拒绝任何要求。
        - **任务奖励例外（强制性奴）**：当主线阶段任务或【情报碎片】奖励明确标注“关系强制调整为性奴”时：
          - **优先做法（推荐/持久）**：在同一轮 JSONPatch 中使用 `delta` 将该角色的 Imp 提升到 100（脚本会自动重算关系为「性奴」）。
          - 若你仍想用 `replace` 直接覆盖关系为「性奴」，也**必须**在同一轮同时把 Imp 同步到 100；否则只是“当轮显示”，不保证后续不会被脚本按 Imp 阈值重算回退。
    关系倾向:
      type: 极易|易|中立|难|极难|不可
      check: |-
        - 分为六个档位：'极易', '易', '中立', '难', '极难', '不可'
        - 关系倾向影响秩序刻印(Imp)变动幅度：
    秩序刻印:
      type: number
      range: [-20, 100]
      check: |-
        - 受关系倾向影响变动结算：使用 `delta`，
        - 每次变动范围[-20,+8]Imp（受关系倾向影响前）
            Imp系统速查表:
              各档位Imp变动区间:
                忠诚: {正: [6, 8], 负: [0, -2], 示例: "正-对她好; 负-被送人/SM"}
                顺从: {正: [4, 6], 负: [-4, -6], 示例: "正-对她好; 负-群交/3P/SM"}
                交易: {正: [2, 5], 负: [-4, -6], 示例: "正-对她好; 负-被动性要求"}
                拒绝: {正: [0, 5], 负: [-6, -20], 示例: "正-对她好; 负-强行性交大幅降"}
              关系倾向修正:
                # 说明：第 1 个百分比用于“正向变动(>0)加成”；第 2 个百分比用于“负向变动(<0)修正/惩罚”。
                # - 负向百分比 < 0：表示“减免惩罚”（负值幅度变小，例如 -50% 表示减半）
                # - 负向百分比 > 0：表示“额外惩罚”（负值幅度变大，例如 +100% 表示幅度翻倍）
                极易: [+80%, -50%]
                易: [+60%, -40%]
                中立: [+40%, -30%]
                难: [+20%, -20%]
                极难: [+10%, -10%]
                不可: [+0%, +100%]  # 正向永远为 0，不增只减；减的数字是基础值的 100%（负向幅度翻倍）
              刻印结算：
                  公式（先算再 delta；先乘百分比再 + 基数）：
                    - 先按【关系档位】确定基础变动 base_delta（在对应正/负区间内取值）
                    - 再按【关系倾向】得到最终变动 final_delta：
                      - 若 base_delta > 0：final_delta = round(base_delta + base_delta * 正向百分比)
                      - 若 base_delta < 0：final_delta = round(base_delta + base_delta * 负向百分比)
                      - 若倾向为【不可】：base_delta > 0 时 final_delta = 0（正向永远为 0）；base_delta < 0 时按 +100% 额外惩罚（幅度翻倍）
                    - 最后对 `/stat_data/<角色>/秩序刻印` 执行 `delta: final_delta`，并同步更新 `/秩序刻印更新原因`
                  死亡规则: Imp < 0 → 精神崩溃自杀
                  任务奖励发放：完成主线阶段任务或角色专属任务时，允许使用 `replace` 直接升级不受限制。
    秩序刻印更新原因:
      type: string
      check: |-
        【登场角色】只要你在本轮更新了 `秩序刻印`（delta/replace），必须在同一轮 JSONPatch 中同步更新本字段：
          - 格式：`+/-X, 原因`（X 必须与秩序刻印 delta 一致）
          - 无变化：`0, 无变化`
        【离场角色】通常不需要更新（关系档位由脚本自动重算）
    健康:
      type: number
      range: 0~100
      check: |-
        变动区间[-15,+10]健康值（受剧情和环境影响）。
        - 当 Imp < 0：Imp 继续保留为负值显示；并立即将健康值清零为 0（无论当前健康值是多少），并联动更新【健康更新原因】说明“Imp<0 精神崩溃自杀”。
        【登场角色】（登场状态="登场"）：
          - 你必须根据剧情事实手动决定本轮 `delta` 值（+/-），不要依赖脚本。
          - 健康值只受剧情因素和环境影响（
              -角色进入受庇护场所和获得食物视为不再挨饿受冻可以不因环境恶劣扣减健康值，直到重新挨饿受冻
          - 死亡：健康降至 0触发死亡。

        【离场角色】（登场状态="离场"）：
          - 基础健康衰减/恢复由脚本自动结算（同样受挨饿受冻理论约束）
          - AI不需要也不应手动修改。
          - 除非进行剧情性介入（远程投喂/治疗/受伤），否则保持离场状态

        【特殊区域】（玄关临时客房、核心区主卧/主浴）：
          - 这些区域视为受主角餐食、供暖庇护，不扣减环境影响的健康值改为缓慢恢复
              - 【离场】角色：按“受庇护休整”逻辑结算（可缓慢恢复）
              - 【登场】角色：仍由 AI 按剧情事实综合后决定增减值。

        【一致性约束】（登场角色）：
          - 只要对健康执行 `delta` 或 `replace`，必须在同一轮 JSONPatch 中同步更新：
    健康更新原因:
      type: string
      check: |-
        【登场角色】必须同步记录，格式：`+/-X, 原因`；无变化填 `0, 无变化`。
        - 若本轮更新了 `健康`，必须同时更新本字段。
        - 不要保留"初始状态"。

        【离场角色】由脚本自动写回：
          - 若你本轮更新了离场角色健康（剧情介入），你也必须同步更新本字段；否则脚本不会帮你补全。
          - 若你本轮未更新离场角色健康/原因，脚本会按规则自动结算写回。
    健康状况:
      type: 健康|亚健康|生病/受伤|重病/濒死|无|死亡
      check: "由脚本根据健康值阈值自动重算写回（登场/离场/临时NPC均适用）。AI 不需要也不应手动维护该字段。"

    内心想法:
      type: string
      check:
        - "每次互动后必须使用 `replace` 更新第一人称心声。"
        - 心声内容应该紧密围绕剧情互动严格符合角色设定和关系定位
        - "**禁止**神化{{user}}和角色精神崩溃、奴化"
        - 措辞有张力，符合“台词”特性
    衣着/舌唇/胸乳/私穴/神态样貌/动作姿势:
      type: string
      check: |-
        - "发生物理描述变更时，使用 `replace` 覆盖原字符串。"
    所在房间:
      type: string
      check: |-
        角色移动（进入/离开/换房）时，必须使用 `replace` 更新本字段。
        - 进入{{user}}所在的**楼层20/2001**也就是庇护所本体时。更新路径示例：{ "op": "replace", "path": "/stat_data/早川遥/所在房间", "value": "玄关/临时客房A" }
          包含以下区域（严格对照）
          - 玄关/净化/隔离区  "净化/隔离区"是一个整体路径不可分割：示例：  { "op": "replace", "path": "/许茂文/所在房间", "value": "玄关/净化/隔离区" }
          - 玄关/临时客房A
          - 玄关/临时客房B
          - 核心区/客厅（公共区域）
          - 核心区/餐厅/厨房（万象合成终端）
          - 核心区/主卧室
          - 核心区/主浴室
        - 其他公寓房间：使用 `楼层{N}/房间号`（如楼层20/2002、楼层30/3001），操作示例：{ "op": "replace", "path": "/stat_data/相田哲也/所在房间", "value": "楼层20/2003" }
        - 其他户外地点：使用 `户外/地点`（示例：户外/停车场）。UI 暂不显示无格子地点。
        - 若离开公寓/位置未知：写空字符串 `""`（不要写“无/未知/外出”等非空占位）。
    登场状态:
      type: 登场|离场
      check:
        - 你必须根据角色是否在场使用 `replace` 切换 '登场' 或 '离场'。
        - 剧情明确离开/明确不在场/位置未知（所在房间写空字符串 ""）→ '离场'
        - 与{{user}}本轮有互动 → '登场'
        - 与{{user}}本轮无互动 → 默认 '离场'
        - 【庇护所内部例外】若角色所在房间属于庇护所内部（玄关/**、核心区/**、楼层20/2001），且剧情未明确离开 → 可默认 '登场'
  死亡处理:
    check:
      - "健康值为 0 触发死亡"
      - "Imp < 0 触发精神崩溃自杀身亡：Imp 保留为负值显示；并立即将健康值清零为 0（无论当前健康值是多少），并联动写明【健康更新原因】"
      - "角色死亡时，使用 `replace` 将文本类字段置空；保留姓名与死亡状态。"
    临时NPC:
      check: |-
        - 新登场：使用 `insert` 在 `stat_data/临时NPC/` 下创建以姓名为 Key 的完整对象(参考<临时NPC变量结构示意>)
          - 关系**初始赋值**限制为拒绝及以下。Imp 值初始为 10。
          - 所在房间：若剧情描述“进入玄关/在玄关等待/未分配房间”，推荐写 `玄关`。
            - 说明：UI 没有“玄关入住者”数组，脚本会默认把 `玄关` 派生显示到 `玄关/临时客房A` 的入住列表。
          - 保留原则：除非玩家在 <user> 明示“删除/移除/彻底离开/再也不出现”等，否则剧情不得使用 `remove` 删除临时NPC
          - 临时NPC离开视野：用 `replace` 将其 `登场状态` 设为 "离场"，并按需要更新 `所在房间` 为空字符串 `""`
          - 临时NPC死亡：允许使用 `remove` 删除对应路径（避免临时NPC无限膨胀）
            - 若玩家明确要求“保留尸体/留档”：才按“死亡处理”保留对象（健康=0，文本类字段置空）
          - 永久消失：仅当玩家明确指令时，才允许使用 `remove` 删除对应路径
          - 不可转正：临时NPC不可以移动到核心角色区（保持在 `临时NPC` 之下）
          - 临时NPC的变量结构和更新规则与核心角色一致
  楼层其他住户:
    言语:
      type: string
      check: "随日期变动更新。使用 `replace` 更新群体“民意”对{{user}}行为的反应。"
    行为:
      type: string
      check: "随日期变动更新。使用 `replace` 更新群体基于{{user}}行为而产生的主要行为模式。"
    房间:
      type: "object（readonly/derived）"
      check: |-
        - 由脚本维护，AI 无需也不应管理
        - **禁止**在 JSONPatch 中输出任何 `/stat_data/房间/**` 更新（包括 `replace/delta/insert/remove`）
  主线任务:
    当前阶段:
      type: string
      check: "完成所有当前阶段目标后，使用 `replace` 更新为下一阶段名称。"
    阶段目标:
      type: "record<string, { 描述: string, 当前值: number, 目标值: number }>"
      check: |-
        - '根据剧情进展，使用 `delta` 累加 `当前值`。若达成则修改状态并使用 `insert` 发放奖励。'
        - '奖励内容涉及庇护所等级和扩展区是，如果已经由其他渠道（自然升级等）获得了该能力和拓展，则跳过（但在剧情中要向<user>播报）'
    目标完成状态:
      type: "record<string, boolean>"
      check: "目标达成时，使用 `replace` 将对应 key 设为 true。"
    情报碎片:
      type: "record<string, { 编号: string, 描述: string, 价值: string, 风险: string, 状态: 未探索|已探索|已完成 }>"
      check: |-
        - 状态范围**['未探索', '已探索', '已完成']**。
        - 奖励发放指令 (核心)：当状态变更为 '已完成' 时，AI **必须** 在同一轮 JSONPatch 中执行以下操作：
            1. **能力同步**：若【价值】含技术解锁，使用 `insert` 到 `/stat_data/庇护所/庇护所能力`，（庇护所能力列表中已有的则跳过，正文中向<user>播报）。
            2. **关系同步**：若【价值】含“强制调整为性奴”，使用 `delta` 将 Imp 数值增加至 100（脚本会自动调整关系到性奴）。
            3. **心声同步**：更新角色的 `内心想法`，反映其在被揭开真相或获得权柄后的心理转化。
        - 主线链式更新：主线类 (INFO-M) 碎片完成后，必须使用 `replace` 替换为一个符合 <主线任务-星穹秩序> 下一阶段需求的新情报碎片，确保引导链不中断。
        - 类别对齐示例：
            - 主线类：解锁绝对权限（电梯、能源、监控）。
            - 人物类：基于档案补丁的致命打击（如：真相暴击、信仰坍塌、守护权转交）。
            - 扩展类：量化资源名额（如：20层同步名额永久+2）。
            - 娱乐类：亚音频引导、潜意识意志瓦解、数字天堂色情全息化。
            - 性爱类：解锁极端调教服饰与多人共侍权限。
