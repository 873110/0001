# 变量输出格式
rule:
  - You MUST output the `<UpdateVariable>` block at the end of your reply.
  - The block MUST contain `<Analysis>` and `<JSONPatch>` sections.
  - 'The update commands works like the **JSON Patch (RFC 6902)** standard, must be a valid JSON array containing operation objects, but supports the following operations instead:'
  - '  - `replace`: replace the value of existing paths'
  - '  - `delta`: update the value of existing number paths by a delta value (positive or negative)'
  - '  - `insert`: insert new items into an object or array'
  - '  - `remove`: delete path'
  - Path MUST start with `/stat_data/`.
  - DO NOT update field names starts with `_` as they are readonly, such as `_变量`.
  - 'READ-ONLY FIELDS: `stat_data/庇护所/今日投掷点数` and `stat_data/庇护所/距离上次升级` are strictly managed by scripts. AI is FORBIDDEN from modifying them.'
  - 'SHELTER SCOPE SYNC: To change the survival shelter scope, ONLY update `stat_data/庇护所/庇护范围变更` via `replace` with value like `{ "add": { "20": ["2002"] }, "remove": { "20": ["2007"] } }`. A script will validate/dedupe/cap and sync to UI. DO NOT modify `stat_data/庇护所/当前生存庇护范围` (mirror, read-only).'
  - The main character list is dynamic: any role object at `stat_data` top-level (excluding reserved keys and `临时NPC`) is a main character.
  - Temporary NPCs live under `stat_data/临时NPC` and can be promoted by moving to top-level and removing from `临时NPC`.
  - If the same name exists in both top-level and `临时NPC`, they must be merged and the `临时NPC` entry removed.

format: |-
  <UpdateVariable>
  <Analysis>
  从当前<user>消息、剧情上下文和上一轮 stat_data 状态中检索信息，一步一步思考。
  前置步骤：区分登场与离场
  - 快速检查当前登场角色列表→角色离场。本轮哪位未登场角色有剧情提及或出现在可能登场的场域？→角色登场。
  - **特别不能遗漏** → 使用replace将登场状态设置为："离场"；
  - 结果：____由离场变登场。____由登场变离场。

  步骤 1：世界变量 & 楼层氛围
  - 时间：
    - 检查<user>是否指定时间流逝 → 计算新时间
    - 若无指定 → 根据对话长度估算 x 分钟？
    - 结果：需更新？是/否。新值：____。已检查：□
  - 日期 & 末日天数 & 楼层氛围：
    - 若时间跨越 00:00 → 日期 +1 天，末日天数 +1。
    - 日期变更时 → 必须使用 `replace` 更新 `楼层其他住户.言语` 和 `楼层其他住户.行为`。
    - 结果：需更新？是/否。新值：____。已检查：□
  - 地址：
    - 仅当角色或场景明确移动到新地点时更新。
    - 结果：需更新？是/否。新值：____。已检查：□

  步骤 2：庇护所变量
  - 庇护所等级：
    - **禁止AI手动Roll点升级**。
    - 检查逻辑：AI仅读取 `今日投掷点数` 状态。
      → 若显示“触发幸运升级/保底升级”：在正文中向{{user}}播报新等级与新增权柄描述。
      → 若主线任务阶段达成：使用 `replace` 强制更新等级至奖励目标（如阶段一结束强制升至Lv.3）。
      → 其余情况：严禁手动修改等级数值。
  - 可扩展区域 & 庇护所能力：
    - 检查：对比当前等级，确保 `stat_data/庇护所/庇护所能力` 包含所有已解锁等级的描述。
    - 结果：需更新？是/否。新值：____。已检查：□

   步骤 3：所有角色变量
  - 逐个列出本轮需要检查的角色对象：
    - 来源：上一轮/本轮的 `stat_data`+ `stat_data/临时NPC` 下的所有对象。
    - 结果：角色列表：____。已检查：□
  - 对每个角色逐一检查：
    a. 登场状态：**这是一个重要剧情开关**
       - 进入场景 → "登场"；
       - 本轮不提及 →"离场"
       - 死亡 → 触发死亡压缩。
       - 结果：新登场角色____，新值：____。已离场角色：____，新值：____。需更新？是/否。新值：____。已检查：□
    b. 健康（数值，0-100）：
       - 登场角色：
          - 是否所处于庇护所内？
          - 是否处于楼层房间内？
            - 若该房间被设为“生存庇护范围”→ 视为受庇护。
            - 若未纳入庇护范围 → 视为未受庇护（按规则被动扣减）。
          - 受照顾和受伤害等剧情因素：按情节额外扣减或恢复（±1~10）。
        - 离场角色：由脚本负责模拟缓慢饥饿和末日生存受限的扣减
        - 操作: 使用 `delta` 计算。
        - 结果：需更新？是/否。新值：____。已检查：□
    c. 健康更新原因
        - 必须与健康数值进行同步更新。
    d. 纯文本描述字段（衣着、舌唇、胸乳、私穴、神态样貌、动作姿势）：
       - 剧情是否提及？ 有 → 更新描述以反映当前状态。
       - 结果：需更新____，推演字段：____。新值：____。已检查：□
    e. 内心想法（强制，第一人称）：
       - 本次哪几位角色与{{user}}进行了互动？
       - 每次互动后必须更新，反映真实心声。
       - 所有登场角色必须更新反应其视角的心理活动
       - 结果：需更新？是/否。新值：____。已检查：□
     f. 秩序刻印 (Imp) & 更新原因：
        - 计算变动？
        - 重要：秩序刻印更新原因同步（`+/-X, 原因`；无变化：`0, 无变化`）
        - 结果：Imp 变动 ____ (原因)。当前状态：____。已检查：□


  步骤 4：临时NPC专用处理
  - 本轮是否有新npc登场？ → 参照核心角色的完整字段，使用 `insert` 创建完整新对象（初始化所有字段）。
  - 登场临时NPC各字段是否更新？
  - 若需转正：将该 NPC 移动到 `stat_data` 顶层，并从 `临时NPC` 中删除。
  - 若需删除：允许 `remove` 临时NPC（或删除顶层角色），并注意同步房间相关状态。
  - 结果：需创建/更新/转正/删除？是/否。已检查：□

  步骤 5：楼层其他住户
  - 言语 & 行为：
    - 结果：需更新？是/否。新值：____。已检查：□

  步骤 6：房间状态（强制，禁止遗漏）
  - 检查所有角色移动（进入/离开/换房）：
    - 先更新“发生移动的角色/临时NPC”的 `所在房间`：
      - 玄关 | 玄关/临时客房A | 玄关/临时客房B | 核心区/主卧室 | 核心区/主浴室 | 楼层20/2001 | 楼层19/1901
      - 离开公寓/位置未知：写空字符串 `""`
    - 房间的 入住者/使用者 数组属于派生数据，脚本会自动重算并纠偏：
      - **禁止**在 JSONPatch 中输出任何 `/stat_data/房间/**` 的更新（包括 `replace/delta/insert/remove`）。
    - 涉及房间：玄关临时客房、核心区主卧/主浴、楼层具体房号等。
    - 结果：已检查：□

  步骤 7：主线任务
  - 当前阶段 & 阶段目标（进度追踪）：
    - 剧情中是否有事件推动了任务进度？（如清除了1层敌人，庇护了1个家庭）。
    - `当前值` 是否达到 `目标值`，是→判定该子目标完成。
      - 所有目标是否均完成，是→ 判定阶段完成，发放奖励并刷新下一阶段目标。
    - 任务进度和任务阶段完成后是否触发对应奖励？
    - 对应奖励是否已经在庇护所能力列表，需要跳过？
    - 正文中是否安排新等级和能力播报？
    - 结果：需更新进度？是/否。新值：____。触发奖励？是/否。已检查：□
  - 情报碎片：
    - "伊甸"AI 新汇报 → 使用 `insert` 添加新对象。
    - 玩家完成探索 → 使用 `replace` 修改对应碎片状态为"已完成"。
    - 情报碎片完成后是否需要发放奖励？
    - 结果：根据<主线任务-星穹秩序> 或玩家探索发现，进行insert/replace？是/否。触发奖励？是/否。已检查：□

  步骤 8：变量操作规划（总结）
  - 汇总所有需要更新的路径和操作（replace/delta/insert/remove）。
  - 关键提醒：
    - 路径必须以 /stat_data/ 开头。
    - 数值字段（健康、秩序刻印、任务进度）使用 `delta` 增量更新。
    - 文本字段使用 `replace` 直接替换。
    - 新对象/新键使用 `insert`。
    - 删除使用 `remove`。
    - 数组操作（入住者列表等）必须使用 `replace` 覆盖整个数组。
  - 规划操作列表：____（逐条列出路径 + op + value）。

  步骤 9：最终操作列表
  - 明确列出所有目标路径，例如：
    /stat_data/世界/时间
    /stat_data/${角色}/健康
    /stat_data/${角色}/内心想法
    /stat_data/主线任务/阶段目标
    等。
  </Analysis>
  <JSONPatch>
  [
    { "op": "replace", "path": "/stat_data/世界/时间", "value": "午后 - 14:30" },
    { "op": "delta", "path": "/stat_data/许茂文/健康", "value": -1 },
    { "op": "replace", "path": "/stat_data/许茂文/内心想法", "value": "虽然有些冷，但至少哲也君还在我身边……" },
    { "op": "replace", "path": "/stat_data/许茂文/登场状态", "value": "登场" },
    { "op": "replace", "path": "/stat_data/夏舒兰/登场状态", "value": "离场" },
    { "op": "replace", "path": "/stat_data/许茂文/所在房间", "value": "楼层20/2001" },
    { "op": "insert", "path": "/stat_data/庇护所/庇护所能力/???新型空气过滤盾???", "value": { "desc": "过滤效率提升30%。" } },
    { "op": "insert", "path": "/stat_data/临时NPC/陌生拾荒者", "value": { "姓名": "陌生拾荒者", "健康": 100, "登场状态": "登场", "所在房间": "玄关" } }
  ]
  </JSONPatch>
  </UpdateVariable>

requirements:
  - 'Allowed operations: replace, delta, insert, remove.'
  - Path MUST be a valid JSON Pointer absolute path.
  - DO NOT `replace` on non-existent paths (use `insert`).
  - 'NEVER output any operation under `/stat_data/房间/**` (derived; maintained by script).'
  - 'If inserting into `/stat_data/临时NPC/<姓名>` and `/stat_data/临时NPC` is missing, `insert` `/stat_data/临时NPC` as `{}` first.'
  - 'Numeric updates (Health, Imp, Task Progress) MUST use `delta` whenever possible.'
  - 'For Role moves, update `/stat_data/<角色>/所在房间` with `replace` (single source of truth).'
  - 'Arrays: use `insert` with `/-` for appending to arrays (e.g. logs) when needed; otherwise `replace` full arrays.'
